<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å‹‰å¼·é€²æ—ç®¡ç†</title>
    <link rel="apple-touch-icon" href="icon.png">
    <meta name="apple-mobile-web-app-title" content="å­¦ç¿’ç®¡ç†">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="firebase-config.js"></script>

    <script>
        tailwind.config = {
            darkMode: 'class', // ã‚¯ãƒ©ã‚¹åˆ‡ã‚Šæ›¿ãˆãƒ¢ãƒ¼ãƒ‰
            theme: {
                extend: {
                    colors: {
                        // å¤‰æ•°ã‚’ä½¿ã†ã‚ˆã†ã«å¤‰æ›´
                        'app-dark': 'var(--bg-main)',
                        'app-panel': 'var(--bg-panel)',
                        'app-accent': 'var(--accent)',
                        'app-success': '#10b981',
                        'app-text': 'var(--text-main)',
                        'app-sub': 'var(--text-sub)',
                        'challenge-gold': '#fbbf24',
                        'app-weak': '#ef4444',

                        // æ—¢å­˜ã®ã‚°ãƒ¬ãƒ¼è‰²ã‚‚å¤‰æ•°ã§ä¹—ã£å–ã‚‹ï¼ˆã“ã“ãŒè£æŠ€ï¼ï¼‰
                        gray: {
                            900: 'var(--c-gray-900)',
                            800: 'var(--c-gray-800)',
                            700: 'var(--c-gray-700)',
                            400: 'var(--c-gray-400)',
                            // ä»–ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ã¾ã¾
                            50: '#f9fafb', 100: '#f3f4f6', 200: '#e5e7eb', 300: '#d1d5db',
                            500: '#6b7280', 600: '#4b5563'
                        }
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        mono: ['ui-monospace', 'SFMono-Regular', 'Menlo', 'Monaco', 'Consolas', "Liberation Mono", "Courier New", 'monospace'],
                    },
                    animation: {
                        'pulse-fast': 'pulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                    }
                }
            }
        }
    </script>
    <style>
        /* â˜…ä¿®æ­£ï¼šã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼ã‚‚å¤‰æ•°å¯¾å¿œ */
        ::-webkit-scrollbar {
            width: 4px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-panel);
        }

        ::-webkit-scrollbar-thumb {
            background: #475569;
            border-radius: 2px;
        }

        /* â˜…ä¿®æ­£ï¼šbodyã®èƒŒæ™¯è‰²ã‚’ã€Œå›ºå®šã®é»’ã€ã‹ã‚‰ã€Œå¤‰æ•°ã€ã«å¤‰æ›´ */
        body {
            background-color: var(--bg-main);
            color: var(--text-main);
        }

        .category-label-top {
            text-align: center;
            border-bottom: 1px solid var(--c-gray-700);
            padding: 2px 1px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            font-size: 8px;
            color: var(--text-sub);
            box-sizing: border-box;
        }

        /* â˜…ä¿®æ­£ï¼šå˜å…ƒãƒãƒƒãƒ—ã®æ èƒŒæ™¯ã‚’å¤‰æ•°ã« */
        .slit-wrapper {
            display: flex;
            width: 100%;
            height: 150px;
            border: 1px solid var(--c-gray-700);
            border-radius: 4px;
            overflow: hidden;
            background-color: var(--bg-main);
        }

        /* â˜…ä¿®æ­£ï¼šã‚¹ãƒªãƒƒãƒˆã®èƒŒæ™¯ã‚’å¤‰æ•°ã« */
        .slit-item {
            flex: 1;
            position: relative;
            border-right: 1px solid var(--c-gray-700);
            /* å¢ƒç•Œç·šã¯è–„ã„é»’ã®ã¾ã¾ã§OK */
            background-color: var(--bg-panel);
            transition: all 0.2s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            overflow: hidden;
            padding-top: 4px;
            padding-bottom: 4px;
        }

        .slit-item:last-child {
            border-right: none;
        }

        .slit-text {
            flex-grow: 1;
            writing-mode: vertical-rl;
            text-orientation: upright;
            letter-spacing: 1px;
            font-size: 9px;
            line-height: 1;
            padding-top: 2px;
            padding-bottom: 2px;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
        }

        .slit-item.completed {
            background-color: #10b981;
        }

        .slit-item.completed .slit-text {
            color: rgba(0, 0, 0, 0.6);
            font-weight: bold;
        }

        .slit-item.completed.weak {
            background-color: #fbbf24;
        }

        .slit-item.weak-pending {
            background-color: #7f1d1d;
        }

        .slit-item.weak-pending .slit-text {
            color: #fca5a5;
            font-weight: bold;
        }

        .slit-item:hover {
            filter: brightness(1.2);
        }

        .slit-weak-btn {
            font-size: 8px;
            margin-top: 2px;
            z-index: 10;
            color: rgba(255, 255, 255, 0.2);
            /* ã‚¢ã‚¤ã‚³ãƒ³ã¯è–„ã„ç™½ç³»ã§å›ºå®šã§ã‚‚å¯ */
            transition: color 0.2s;
            width: 100%;
            text-align: center;
            padding: 2px 0;
        }

        .slit-weak-btn:hover,
        .slit-weak-btn.active {
            color: #ef4444;
            opacity: 1;
            text-shadow: 0 0 2px black;
        }

        /* å®Œäº†æ¸ˆã¿ã‚¹ãƒªãƒƒãƒˆã®ä¸­ã®ãƒœã‚¿ãƒ³è‰²èª¿æ•´ */
        .slit-item.completed .slit-weak-btn {
            color: rgba(0, 0, 0, 0.2);
        }

        .slit-item.completed .slit-weak-btn:hover,
        .slit-item.completed .slit-weak-btn.active {
            color: #ef4444;
        }

        /* â˜…è¿½åŠ ï¼šãƒ©ã‚¤ãƒˆãƒ¢ãƒ¼ãƒ‰æ™‚ã®å˜å…ƒãƒãƒƒãƒ—è¦–èªæ€§å‘ä¸Š */
        html.light-mode .slit-wrapper {
            border-color: #94a3b8;
        }

        html.light-mode .slit-item {
            border-right-color: #94a3b8;
        }

        html.light-mode .slit-item:not(.completed):not(.weak-pending) .slit-weak-btn {
            color: rgba(0, 0, 0, 0.3);
        }

        html.light-mode .slit-item:not(.completed):not(.weak-pending) .slit-weak-btn:hover,
        html.light-mode .slit-item:not(.completed):not(.weak-pending) .slit-weak-btn.active {
            color: #ef4444;
        }

        /* â˜…ä¿®æ­£ï¼šãƒ’ãƒ¼ãƒˆãƒãƒƒãƒ—ã®èƒŒæ™¯ã‚’å¤‰æ•°ã« */
        .month-heat-item {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-end;
            border-right: 1px solid var(--c-gray-700);
            background-color: var(--bg-panel);
            position: relative;
        }

        .month-heat-fill {
            width: 100%;
            transition: height 0.5s ease;
            opacity: 0.8;
        }

        .month-heat-label {
            font-size: 10px;
            color: var(--text-sub);
            margin-top: 4px;
            position: absolute;
            bottom: 4px;
            z-index: 10;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.8);
        }

        .tab-content {
            display: none;
            padding-bottom: 120px;
        }

        .tab-content.active {
            display: block;
        }

        #calendar-screen.active {
            display: flex !important;
        }

        .calendar-day {
            aspect-ratio: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border-radius: 0.375rem;
            cursor: pointer;
            position: relative;
            font-size: 0.875rem;
        }

        .calendar-day:hover {
            background-color: var(--c-gray-700);
        }

        .calendar-day.today {
            border: 1px solid #38bdf8;
            color: #38bdf8;
            font-weight: bold;
        }

        .has-event-dot {
            width: 4px;
            height: 4px;
            background-color: #38bdf8;
            border-radius: 50%;
            position: absolute;
            bottom: 4px;
        }

        .has-completed-mark {
            position: absolute;
            bottom: 4px;
            right: 4px;
            font-size: 8px;
            color: #10b981;
        }

        .challenge-mark {
            position: absolute;
            top: 2px;
            right: 2px;
            font-size: 10px;
            color: #fbbf24;
        }

        select.custom-select {
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%2394a3b8' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 0.5rem center;
            background-repeat: no-repeat;
            background-size: 1.5em 1.5em;
            padding-right: 2.5rem;
            appearance: none;
        }

        .fire-aura {
            position: relative;
        }

        .fire-aura::before {
            content: '';
            position: absolute;
            top: -10px;
            left: -10px;
            right: -10px;
            bottom: -10px;
            background: radial-gradient(circle, rgba(255, 69, 0, 0.4) 0%, rgba(255, 215, 0, 0) 70%);
            border-radius: 50%;
            z-index: -1;
            animation: fire-pulse 1.5s infinite alternate;
            filter: blur(8px);
        }

        .fire-aura::after {
            content: '';
            position: absolute;
            top: -5px;
            left: -5px;
            right: -5px;
            bottom: -5px;
            background: radial-gradient(circle, rgba(255, 140, 0, 0.6) 0%, rgba(255, 69, 0, 0) 70%);
            border-radius: 50%;
            z-index: -1;
            animation: fire-pulse 1s infinite alternate-reverse;
            filter: blur(4px);
        }

        @keyframes fire-pulse {
            0% {
                transform: scale(0.95);
                opacity: 0.6;
            }

            100% {
                transform: scale(1.1);
                opacity: 1;
            }
        }

        .text-fire {
            background: linear-gradient(to bottom, #ffd700, #ff4500);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            font-weight: 900;
            filter: drop-shadow(0 0 5px rgba(255, 69, 0, 0.5));
        }

        #debug-mode-indicator {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: repeating-linear-gradient(45deg, #f59e0b, #f59e0b 10px, #000 10px, #000 20px);
            z-index: 100;
        }

        #custom-alert-box {
            animation: slideUp 0.2s ease-out;
        }

        @keyframes slideUp {
            from {
                transform: translateY(10px);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        nav#app-nav {
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.5);
        }

        .weak-checkbox:checked+div {
            background-color: #ef4444;
            color: white;
            border-color: #ef4444;
        }

        /* â˜…ã“ã“ã‹ã‚‰ä¸‹ã¯å‰å›è¿½åŠ ã—ãŸå¤‰æ•°ã®å®šç¾©ï¼ˆãã®ã¾ã¾æ®‹ã—ã¦ãŠã„ã¦ãã ã•ã„ï¼‰ */
        :root {
            /* ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰ */
            --bg-main: #0f172a;
            --bg-panel: #1e293b;
            --text-main: #e2e8f0;
            --text-sub: #94a3b8;
            --accent: #38bdf8;

            --c-gray-900: #111827;
            --c-gray-800: #1f2937;
            --c-gray-700: #374151;
            --c-gray-400: #9ca3af;
        }

        html.light-mode {
            --bg-main: #f1f5f9;
            --bg-panel: #ffffff;
            --text-main: #334155;
            --text-sub: #64748b;
            --accent: #0284c7;

            --c-gray-900: #f1f5f9;
            --c-gray-800: #e2e8f0;
            --c-gray-700: #cbd5e1;
            --c-gray-400: #64748b;
        }

        html.light-mode body {
            color: var(--text-main);
        }

        html.light-mode .text-white {
            color: var(--text-main) !important;
        }

        html.light-mode .text-gray-300 {
            color: var(--text-sub) !important;
        }

        html.light-mode .text-gray-400 {
            color: var(--text-sub) !important;
        }

        html.light-mode .text-gray-500 {
            color: #94a3b8 !important;
        }

        /*119

        /* â˜…è¿½åŠ ï¼šPayPayé¢¨ã®ä¸­å¤®æµ®ãå‡ºã—ãƒœã‚¿ãƒ³ */
        .nav-center-wrapper {
            position: relative;
            width: 60px;
            height: 100%;
        }

        .nav-center-btn {
            position: absolute;
            bottom: 24px;
            /* ãƒãƒ¼ã‚ˆã‚Šä¸Šã«é£›ã³å‡ºã•ã›ã‚‹ */
            left: 50%;
            transform: translateX(-50%);
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: var(--accent);
            /* ã‚¢ã‚¯ã‚»ãƒ³ãƒˆã‚«ãƒ©ãƒ¼ */
            color: var(--bg-main);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.5);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 60;
            border: 4px solid var(--bg-panel);
            /* èƒŒæ™¯è‰²ã§ç¸å–ã‚Šã—ã¦ã€Œåˆ‡ã‚ŠæŠœãã€æ„Ÿã‚’å‡ºã™ */
            transition: transform 0.1s;
        }

        .nav-center-btn:active {
            transform: translateX(-50%) scale(0.95);
        }

        .nav-center-btn i {
            font-size: 20px;
            margin-bottom: 2px;
        }

        .nav-center-btn span {
            font-size: 9px;
            font-weight: bold;
        }

        /* é€±é–“ãƒã‚§ãƒƒã‚¯è¡¨ã®ãƒ‡ã‚¶ã‚¤ãƒ³ */
        .challenge-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
        }

        .challenge-th {
            font-size: 10px;
            color: var(--text-sub);
            text-align: center;
            padding: 4px;
            border-bottom: 1px solid var(--c-gray-700);
            font-weight: normal;
        }

        .challenge-th.today {
            color: var(--accent);
            font-weight: bold;
        }

        .challenge-row {
            transition: background-color 0.2s;
        }

        .challenge-row:hover {
            background-color: rgba(255, 255, 255, 0.05);
        }

        .challenge-name-cell {
            max-width: 100px;
            padding: 8px;
            font-size: 12px;
            font-weight: bold;
            color: var(--text-main);
            border-bottom: 1px solid var(--c-gray-800);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .challenge-check-cell {
            padding: 4px;
            text-align: center;
            border-bottom: 1px solid var(--c-gray-800);
        }

        .check-btn {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            margin: 0 auto;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            background-color: var(--c-gray-800);
            border: 1px solid var(--c-gray-700);
            color: transparent;
        }

        .check-btn.checked {
            background-color: #fbbf24;
            /* Challenge Gold */
            border-color: #fbbf24;
            color: #1e293b;
            box-shadow: 0 2px 5px rgba(251, 191, 36, 0.4);
            transform: scale(1.1);
        }

        /* ä»Šæ—¥ã®åˆ†ãŒæœªå®Œäº†ãªã‚‰å¼·èª¿ */
        .check-btn.today-incomplete {
            border-color: #ef4444;
            box-shadow: 0 0 8px rgba(239, 68, 68, 0.4);
            animation: pulse-border 2s infinite;
        }

        @keyframes pulse-border {
            0% {
                opacity: 1;
            }

            50% {
                opacity: 0.6;
            }

            100% {
                opacity: 1;
            }
        }

        /* â˜…è¿½åŠ ï¼šãƒ‹ãƒ¥ãƒ¼ã‚¹ãƒ†ã‚£ãƒƒã‚«ãƒ¼ã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
        .ticker-slide-enter {
            animation: slide-in-bottom 0.5s cubic-bezier(0.16, 1, 0.3, 1) forwards;
        }

        .ticker-slide-exit {
            animation: slide-out-top 0.5s cubic-bezier(0.16, 1, 0.3, 1) forwards;
        }

        @keyframes slide-in-bottom {
            0% {
                transform: translateY(100%);
                opacity: 0;
            }

            100% {
                transform: translateY(0);
                opacity: 1;
            }
        }

        @keyframes slide-out-top {
            0% {
                transform: translateY(0);
                opacity: 1;
            }

            100% {
                transform: translateY(-100%);
                opacity: 0;
            }
        }

        .ticker-item {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 0 20px;
        }

        .ticker-category-badge {
            font-size: 9px;
            padding: 1px 4px;
            border-radius: 2px;
            margin-right: 6px;
            white-space: nowrap;
            font-weight: bold;
            /* border: 1px solid currentColor; */
            opacity: 0.8;
        }

        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }

        .scrollbar-hide {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
    </style>

</head>

<body class="antialiased font-sans h-screen flex flex-col overflow-hidden text-app-text">

    <!-- Loading Overlay -->
    <div id="initial-loader"
        class="fixed inset-0 z-[1000] flex flex-col items-center justify-center bg-gray-900 transition-opacity duration-500">
        <div class="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-blue-500 mb-4"></div>
        <p class="text-gray-400 text-xs animate-pulse">Loading Study App...</p>
    </div>

    <div id="login-modal" class="fixed inset-0 bg-app-dark z-[999] flex items-center justify-center p-4">
        <div class="bg-app-panel border border-gray-600 rounded-lg w-full max-w-sm p-6 shadow-2xl">
            <h2 class="text-xl font-bold text-white mb-6 text-center">
                å­¦ç¿’ç®¡ç†ã‚¢ãƒ—ãƒª<br>
                <span class="text-[10px] text-red-400 font-normal">â€»å•†ç”¨ã‚¢ãƒ—ãƒªã§ãªã„ã®ã§ç´¹ä»‹ã•ã‚ŒãŸäººã—ã‹ä½¿ã‚ãªã„ã§ãã ã•ã„ã€‚</span>
            </h2>
            <div class="space-y-4">
                <p class="text-xs text-gray-400 mb-4 text-center">Google ToDoãƒªã‚¹ãƒˆã¨åŒæœŸã™ã‚‹ãŸã‚ã«<br>Googleã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„</p>
                <button onclick="performGoogleLogin()"
                    class="flex items-center justify-center w-full bg-white text-gray-700 font-bold py-3 px-4 rounded shadow-md hover:bg-gray-100 transition-colors">
                    <svg class="w-5 h-5 mr-3" viewBox="0 0 24 24">
                        <path
                            d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"
                            fill="#4285F4" />
                        <path
                            d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"
                            fill="#34A853" />
                        <path
                            d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.84z"
                            fill="#FBBC05" />
                        <path
                            d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"
                            fill="#EA4335" />
                    </svg>
                    Googleã§ãƒ­ã‚°ã‚¤ãƒ³
                </button>
                <p id="login-error" class="text-red-400 text-xs text-center min-h-[1rem]"></p>
            </div>
        </div>
    </div>

    <header class="flex items-center px-4 py-2 bg-app-panel border-b border-gray-700 z-10 h-14 shrink-0 gap-3">
        <div class="w-32 shrink-0">
            <select id="subject-select"
                class="custom-select bg-gray-900 border border-gray-600 text-white text-xs rounded px-2 py-1 focus:outline-none focus:border-app-accent w-full truncate">
            </select>
        </div>

        <div id="header-date-display" class="text-sm font-mono font-bold text-gray-200 whitespace-nowrap">--/--</div>

        <div id="header-ticker-box"
            class="hidden sm:block flex-1 relative h-8 bg-gray-900/50 rounded overflow-hidden cursor-pointer group select-none border-none outline-none ring-0"
            style="border: none !important; outline: none !important; box-shadow: none !important;"
            onclick="forceNextTicker()">
            <div class="ticker-wrapper relative w-full h-full">
                <div class="ticker-item text-xs text-gray-500">Loading...</div>
            </div>
            <button
                class="ticker-pause-btn absolute right-1 bottom-0.5 text-[8px] text-gray-600 hover:text-white opacity-0 group-hover:opacity-100 transition-opacity z-20 p-1"
                onclick="toggleTickerPause(event)">
                <i class="fas fa-pause"></i>
            </button>
        </div>

        <div class="flex items-center justify-end gap-2 shrink-0 ml-auto">
            <div class="flex flex-col items-end">
                <div class="text-[10px] text-app-accent font-mono whitespace-nowrap hidden sm:block"
                    id="exam-days-left">ç›®æ¨™ã¾ã§ -- æ—¥</div>
                <div class="text-[9px] text-challenge-gold font-bold whitespace-nowrap hidden sm:block"
                    id="streak-count-header"></div>
            </div>

            <button onclick="syncFromGoogleTasks()"
                class="bg-gray-800 hover:bg-gray-700 text-app-accent border border-gray-600 rounded px-2 py-1.5 flex items-center gap-2 transition-colors active:scale-95 mx-1">
                <i class="fas fa-sync-alt text-xs"></i>
                <span class="text-[10px] font-bold hidden md:inline">åŒæœŸ</span>
            </button>

            <button onclick="openSettingsModal()" class="text-gray-400 hover:text-white p-1.5"><i
                    class="fas fa-cog"></i></button>
        </div>
    </header>

    <main class="flex-1 overflow-y-auto relative scroll-smooth" id="main-container">

        <div id="home-screen" class="tab-content active p-4 pb-32">
            <div class="sm:hidden text-center mb-2">
                <span class="text-[10px] text-app-accent font-mono bg-app-accent/10 px-2 py-1 rounded"
                    id="exam-days-left-mobile">ç›®æ¨™ã¾ã§ -- æ—¥</span>
            </div>
            <div class="sm:hidden text-center mb-4 min-h-[16px]">
                <span class="text-[10px] text-challenge-gold font-bold" id="streak-count-mobile"></span>
            </div>

            <div class="flex flex-col items-center justify-center mb-6">
                <div id="progress-container" class="relative w-32 h-32 transition-all duration-500">
                    <canvas id="progressCircleChart"></canvas>
                    <div class="absolute inset-0 flex flex-col items-center justify-center pointer-events-none">
                        <span class="text-xs text-gray-400" id="progress-label">é€²æ—ç‡</span>
                        <span class="text-2xl font-bold text-white tracking-tighter transition-all duration-300"
                            id="total-progress-text">0%</span>
                    </div>
                </div>
                <div class="mt-2 text-xs text-gray-500" id="current-subject-name-display"></div>
            </div>
            <!-- é›£æ˜“åº¦ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ -->
            <div id="difficulty-filter-area" class="flex flex-wrap justify-start gap-2 mb-4 hidden px-4"></div>

            <div class="mb-8">
                <div class="flex justify-between items-end mb-2">
                    <h2 class="text-xs font-medium text-gray-400 uppercase tracking-widest" id="map-title">å˜å…ƒãƒãƒƒãƒ—</h2>
                </div>
                <div id="category-labels-container" class="flex w-full overflow-hidden border-x border-transparent">
                </div>
                <div id="slit-bar-wrapper" class="slit-wrapper"></div>
                <div class="flex justify-end mt-2 gap-3 text-[10px] text-gray-500" id="map-legend">
                    <div class="flex items-center gap-1">
                        <div class="w-2 h-2 rounded-full bg-app-success"></div>å®Œäº†
                    </div>
                    <div class="flex items-center gap-1">
                        <div class="w-2 h-2 rounded-full bg-challenge-gold"></div>å®Œäº†(è‹¦æ‰‹)
                    </div>
                    <div class="flex items-center gap-1">
                        <div class="w-2 h-2 rounded-full bg-app-weak"></div>æœªå®Œ(è‹¦æ‰‹)
                    </div>
                </div>
            </div>

            <!-- ã‚«ãƒ†ã‚´ãƒªåˆ¥é€²æ—ãƒãƒ¼ -->
            <div id="category-progress-section" class="mb-6 hidden">
                <h2 class="text-xs font-medium text-gray-400 mb-2 flex items-center gap-1">
                    <i class="fas fa-layer-group text-app-accent"></i> ã‚«ãƒ†ã‚´ãƒªåˆ¥é€²æ—
                </h2>
                <div id="category-progress-bars" class="bg-app-panel rounded-lg border border-gray-700 p-3 space-y-2">
                </div>
            </div>

            <div class="bg-app-panel rounded-lg p-4 border border-gray-700 shadow-sm mb-6">
                <h2 class="text-xs font-medium text-gray-400 mb-3 flex items-center justify-between">
                    <span><i class="fas fa-chart-line text-app-accent mr-1"></i> ãƒšãƒ¼ã‚¹äºˆæ¸¬ãƒ»æ¨ç§»</span>
                    <div class="flex flex-col items-end">
                        <span id="predicted-finish-date" class="text-[10px] font-bold text-app-accent"></span>
                        <span class="text-[9px] text-gray-500" id="chart-legend-note">â€»ã‚ªãƒ¬ãƒ³ã‚¸ã¯ç¾åœ¨ã®ãƒšãƒ¼ã‚¹äºˆæ¸¬</span>
                    </div>
                </h2>
                <div class="relative h-48 w-full">
                    <canvas id="paceChart"></canvas>
                </div>
            </div>


        </div>

        <div id="record-screen" class="tab-content p-4 pb-32">
            <section class="mb-6">
                <div
                    class="flex items-center justify-between mb-3 bg-app-panel/50 p-2 rounded-lg border border-gray-700/50">
                    <div class="flex items-center gap-3">
                        <button id="record-prev-day"
                            class="text-gray-400 hover:text-white w-8 h-8 flex items-center justify-center rounded-full hover:bg-gray-700 transition-colors"><i
                                class="fas fa-chevron-left"></i></button>
                        <h2 class="text-sm font-bold text-white flex flex-col items-center">
                            <span id="record-date-label">ä»Šæ—¥ã®äºˆå®š</span>
                            <span id="record-date-display"
                                class="text-[10px] font-normal text-gray-400 uppercase"></span>
                        </h2>
                        <button id="record-next-day"
                            class="text-gray-400 hover:text-white w-8 h-8 flex items-center justify-center rounded-full hover:bg-gray-700 transition-colors"><i
                                class="fas fa-chevron-right"></i></button>
                    </div>
                    <span id="record-task-count"
                        class="text-[10px] bg-app-accent/10 text-app-accent px-2 py-0.5 rounded border border-app-accent/20">0
                        å˜å…ƒ</span>
                </div>

                <div id="challenge-action-area" class="hidden mb-4">
                    <div class="bg-app-panel rounded-lg p-6 border border-gray-700 text-center">
                        <h3 class="text-white font-bold mb-4">ä»Šæ—¥ã®ãƒãƒ£ãƒ¬ãƒ³ã‚¸ã‚’è¨˜éŒ²</h3>
                        <button id="challenge-toggle-btn"
                            class="w-full py-4 rounded-xl font-bold text-lg shadow-lg transition-all duration-300 transform active:scale-95 flex items-center justify-center gap-2">
                            <i class="fas fa-check-circle"></i> <span id="challenge-btn-text">å®Œäº†ã«ã™ã‚‹</span>
                        </button>
                    </div>
                </div>

                <div class="bg-app-panel rounded-lg border border-gray-700 overflow-hidden min-h-[60px]"
                    id="todays-list"></div>
                <div class="mt-3 flex justify-between items-center px-1">
                    <p class="text-[10px] text-gray-500">å…¨ç§‘ç›®ã®äºˆå®šãŒè¡¨ç¤ºã•ã‚Œã¾ã™</p>
                    <button onclick="copyForKeep()"
                        class="text-xs bg-gray-800 hover:bg-gray-700 text-gray-300 px-3 py-1.5 rounded flex items-center gap-2 border border-gray-700 transition-colors active:scale-95"><i
                            class="far fa-copy"></i> ãƒ†ã‚­ã‚¹ãƒˆã‚³ãƒ”ãƒ¼</button>
                </div>
                <div id="copy-feedback" class="text-center text-[10px] text-app-success mt-1 hidden">ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼</div>
            </section>

            <section id="record-queue-section">
                <div class="flex items-center justify-between mb-3">
                    <h2 class="text-sm font-bold text-gray-400 flex items-center gap-2">
                        <span class="w-1 h-4 bg-gray-600 rounded-sm"></span>
                        æ®‹ã‚Šã®å˜å…ƒ (<span id="current-subject-name-record"></span>)
                    </h2>
                </div>
                <div class="bg-app-panel/30 rounded-lg border border-gray-800 overflow-hidden" id="queue-list"></div>
            </section>
        </div>

        <div id="calendar-screen" class="tab-content h-full flex-col p-2 sm:p-4">
            <div class="flex items-center mb-3 shrink-0 gap-4">
                <h2 class="text-lg font-bold text-white flex items-center gap-2 min-w-[120px]">
                    <i class="far fa-calendar-alt text-app-accent"></i>
                    <span id="calendar-title"></span>
                </h2>

                <div class="flex-1 flex justify-end items-center gap-2">
                    <button onclick="currentCalendarDate = new Date(); renderCalendar();"
                        class="text-[10px] bg-gray-700 text-gray-200 font-bold px-3 py-1.5 rounded-full hover:bg-gray-600 transition-colors border border-gray-600">
                        ä»Šæ—¥
                    </button>

                    <div class="flex bg-gray-800 rounded-full p-1 border border-gray-700">
                        <button id="prev-month"
                            class="text-gray-400 hover:text-white px-2 py-0.5 hover:bg-gray-700 rounded-full transition-colors">
                            <i class="fas fa-chevron-left text-xs"></i>
                        </button>
                        <div class="w-[1px] bg-gray-700 mx-1"></div>
                        <button id="next-month"
                            class="text-gray-400 hover:text-white px-2 py-0.5 hover:bg-gray-700 rounded-full transition-colors">
                            <i class="fas fa-chevron-right text-xs"></i>
                        </button>
                    </div>
                </div>
            </div>

            <div class="flex-1 flex flex-col bg-app-panel rounded-xl border border-gray-700 shadow-xl overflow-hidden">
                <div class="grid grid-cols-7 border-b border-gray-700 bg-gray-800/50">
                    <div class="py-2 text-center text-xs font-bold text-red-400">æ—¥</div>
                    <div class="py-2 text-center text-xs font-bold text-gray-400">æœˆ</div>
                    <div class="py-2 text-center text-xs font-bold text-gray-400">ç«</div>
                    <div class="py-2 text-center text-xs font-bold text-gray-400">æ°´</div>
                    <div class="py-2 text-center text-xs font-bold text-gray-400">æœ¨</div>
                    <div class="py-2 text-center text-xs font-bold text-gray-400">é‡‘</div>
                    <div class="py-2 text-center text-xs font-bold text-blue-400">åœŸ</div>
                </div>

                <div id="calendar-grid" class="flex-1 grid grid-cols-7 grid-rows-6"></div>
            </div>

            <div class="mt-2 text-[10px] text-gray-500 shrink-0 px-1">
                <div class="flex flex-wrap items-center gap-x-3 gap-y-1">
                    <span class="flex items-center gap-1"><span
                            class="w-2 h-2 rounded-full bg-app-accent"></span>äºˆå®š</span>
                    <span class="flex items-center gap-1"><span
                            class="w-2 h-2 rounded-full bg-app-success"></span>å®Œäº†</span>
                    <span class="flex items-center gap-1"><span
                            class="w-2 h-2 rounded-full bg-challenge-gold"></span>â˜…ãƒãƒ£ãƒ¬ãƒ³ã‚¸</span>
                </div>
                <div id="calendar-legend" class="mt-1 flex flex-wrap gap-x-3 gap-y-1 opacity-80"></div>
            </div>
        </div>

        <div id="challenge-screen" class="tab-content p-4 pb-32">
            <h2 class="text-lg font-bold text-white mb-4 flex items-center gap-2">
                <i class="fas fa-fire text-challenge-gold"></i> ç¿’æ…£ãƒ»è¨˜éŒ²
            </h2>

            <!-- ã‚¿ãƒ–ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ -->
            <div class="flex mb-4 bg-gray-800 rounded-lg p-1 border border-gray-700">
                <button onclick="switchHabitTab('tab-study-time')" id="btn-tab-study-time"
                    class="flex-1 py-2 rounded-md text-xs font-bold text-gray-400 hover:text-white transition-all">
                    <i class="fas fa-stopwatch text-blue-400 mr-1"></i> å‹‰å¼·æ™‚é–“
                </button>
                <button onclick="switchHabitTab('tab-habit-check')" id="btn-tab-habit-check"
                    class="flex-1 py-2 rounded-md text-xs font-bold text-white bg-gray-700 shadow transition-all">
                    <i class="fas fa-check-square text-challenge-gold mr-1"></i> ãƒã‚§ãƒƒã‚¯
                </button>
                <button onclick="switchHabitTab('tab-life-rhythm')" id="btn-tab-life-rhythm"
                    class="flex-1 py-2 rounded-md text-xs font-bold text-gray-400 hover:text-white transition-all">
                    <i class="fas fa-bed text-purple-400 mr-1"></i> ç”Ÿæ´»ãƒªã‚ºãƒ 
                </button>
            </div>

            <!-- ã‚¿ãƒ–: ç¿’æ…£ãƒã‚§ãƒƒã‚¯è¡¨ -->
            <div id="tab-habit-check" class="bg-app-panel border border-gray-700 rounded-lg p-4 mb-4">
                <div class="overflow-x-auto mb-4">
                    <div id="challenge-matrix-container" class="min-w-[320px]"></div>
                </div>
                <h3 class="text-xs font-bold text-gray-500 mb-2 uppercase">ç¶™ç¶šã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</h3>
                <div id="challenge-stats-grid" class="grid grid-cols-2 gap-3"></div>
            </div>

            <!-- ã‚¿ãƒ–: å‹‰å¼·æ™‚é–“ -->
            <div id="tab-study-time" class="bg-app-panel border border-gray-700 rounded-lg p-4 mb-4 hidden">
                <!-- å…¥åŠ›ã‚¨ãƒªã‚¢ -->
                <div class="bg-gray-800/50 rounded-lg p-3 mb-4 border border-gray-700">
                    <div class="flex items-center justify-between mb-4 bg-gray-900 rounded border border-gray-700 p-1">
                        <button onclick="shiftStudyLogDate(-1)"
                            class="w-8 h-8 flex items-center justify-center text-gray-400 hover:text-white hover:bg-gray-700 rounded transition-colors"><i
                                class="fas fa-chevron-left"></i></button>
                        <input type="date" id="study-log-date"
                            class="bg-transparent text-white text-xs font-bold text-center outline-none"
                            onchange="loadStudyLogDate()">
                        <button onclick="shiftStudyLogDate(1)"
                            class="w-8 h-8 flex items-center justify-center text-gray-400 hover:text-white hover:bg-gray-700 rounded transition-colors"><i
                                class="fas fa-chevron-right"></i></button>
                    </div>
                    <div class="flex items-end gap-2">
                        <div class="flex-1">
                            <label id="study-time-label" class="text-[10px] text-gray-500 block mb-1">ä»Šæ—¥ã®å‹‰å¼·æ™‚é–“</label>
                            <div class="flex gap-2 items-center">
                                <select id="study-log-hours"
                                    class="w-16 bg-gray-900 border-b border-gray-600 text-white text-lg font-mono focus:border-app-accent outline-none text-right appearance-none">
                                </select>
                                <span class="text-xs text-gray-400">æ™‚é–“</span>
                                <div class="flex items-center gap-0.5">
                                    <button onclick="stepMinutes(-1)"
                                        class="w-6 h-7 flex items-center justify-center text-gray-400 hover:text-white bg-gray-800 rounded-l border border-gray-600 active:bg-gray-600">
                                        <i class="fas fa-minus text-[8px]"></i>
                                    </button>
                                    <select id="study-log-minutes"
                                        class="w-12 bg-gray-900 border-y border-gray-600 text-white text-lg font-mono focus:border-app-accent outline-none text-center appearance-none">
                                    </select>
                                    <button onclick="stepMinutes(1)"
                                        class="w-6 h-7 flex items-center justify-center text-gray-400 hover:text-white bg-gray-800 rounded-r border border-gray-600 active:bg-gray-600">
                                        <i class="fas fa-plus text-[8px]"></i>
                                    </button>
                                </div>
                                <span class="text-xs text-gray-400">åˆ†</span>
                            </div>
                        </div>
                        <button onclick="saveStudyLog()"
                            class="bg-blue-600 hover:bg-blue-500 text-white text-[10px] font-bold px-4 py-2 rounded mb-1 whitespace-nowrap shadow-md">ä¿å­˜</button>
                    </div>
                </div>

                <!-- ã‚°ãƒ©ãƒ•ã‚¨ãƒªã‚¢ -->
                <div class="bg-app-panel rounded-lg border border-gray-700 p-2">
                    <div class="flex justify-between items-center mb-2">
                        <div class="flex gap-2">
                            <button onclick="changeStudyChartRange(7)"
                                class="study-chart-range-btn text-[10px] px-2 py-0.5 rounded bg-gray-700 text-white transition-colors"
                                data-range="7">1é€±</button>
                            <button onclick="changeStudyChartRange(14)"
                                class="study-chart-range-btn text-[10px] px-2 py-0.5 rounded text-gray-400 hover:bg-gray-800 transition-colors"
                                data-range="14">2é€±</button>
                            <button onclick="changeStudyChartRange(30)"
                                class="study-chart-range-btn text-[10px] px-2 py-0.5 rounded text-gray-400 hover:bg-gray-800 transition-colors"
                                data-range="30">1ãƒ¶æœˆ</button>
                        </div>
                        <div class="text-[9px] text-gray-500">åˆè¨ˆ: <span id="study-total-display"
                                class="font-bold text-white">0h 0m</span> (æœŸé–“å†…)</div>
                    </div>
                    <div class="relative w-full h-48 bg-gray-900/50 rounded overflow-hidden">
                        <canvas id="studyTimeChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- ã‚¿ãƒ–: ç”Ÿæ´»ãƒªã‚ºãƒ  -->
            <div id="tab-life-rhythm" class="bg-app-panel border border-gray-700 rounded-lg p-4 mb-4 hidden">
                <!-- å…¥åŠ›ã‚¨ãƒªã‚¢ -->
                <div class="bg-gray-800/50 rounded-lg p-3 mb-4 border border-gray-700">
                    <div class="flex items-center justify-between mb-4 bg-gray-900 rounded border border-gray-700 p-1">
                        <button onclick="shiftSleepLogDate(-1)"
                            class="w-8 h-8 flex items-center justify-center text-gray-400 hover:text-white hover:bg-gray-700 rounded transition-colors"><i
                                class="fas fa-chevron-left"></i></button>
                        <input type="date" id="sleep-log-date"
                            class="bg-transparent text-white text-xs font-bold text-center outline-none"
                            onchange="loadSleepLogDate()">
                        <button onclick="shiftSleepLogDate(1)"
                            class="w-8 h-8 flex items-center justify-center text-gray-400 hover:text-white hover:bg-gray-700 rounded transition-colors"><i
                                class="fas fa-chevron-right"></i></button>
                    </div>
                    <div class="flex flex-col gap-3">
                        <div class="flex items-end gap-2">
                            <div class="flex-1">
                                <label class="text-[10px] text-gray-500 block mb-1">èµ·åºŠ</label>
                                <input type="time" id="sleep-log-wake"
                                    class="w-full bg-gray-900 border-b border-gray-600 text-white text-lg font-mono focus:border-app-accent outline-none">
                            </div>
                            <button onclick="saveSleepLog('wake')"
                                class="bg-yellow-600 hover:bg-yellow-500 text-white text-[10px] font-bold px-3 py-2 rounded mb-1 whitespace-nowrap shadow-md">èµ·åºŠè¨˜éŒ²</button>
                        </div>
                        <div class="flex items-end gap-2">
                            <div class="flex-1">
                                <div class="flex items-center justify-between mb-1">
                                    <label class="text-[10px] text-gray-500">å°±å¯</label>
                                    <label id="sleep-log-nextday-label"
                                        class="flex items-center gap-1 cursor-pointer select-none">
                                        <input type="checkbox" id="sleep-log-nextday" class="hidden"
                                            onchange="updateBedNextDayLabel()">
                                        <div class="w-7 h-4 bg-gray-700 rounded-full relative transition-colors duration-200"
                                            id="sleep-log-nextday-track">
                                            <div class="w-3 h-3 bg-gray-400 rounded-full absolute top-0.5 left-0.5 transition-all duration-200"
                                                id="sleep-log-nextday-thumb"></div>
                                        </div>
                                        <span class="text-[10px] text-gray-500" id="sleep-log-nextday-text">ç¿Œæ—¥</span>
                                    </label>
                                </div>
                                <input type="time" id="sleep-log-bed"
                                    class="w-full bg-gray-900 border-b border-gray-600 text-white text-lg font-mono focus:border-app-accent outline-none">
                            </div>
                            <div class="flex flex-col gap-1 mb-1">
                                <button onclick="saveSleepLog('bed')"
                                    class="bg-purple-600 hover:bg-purple-500 text-white text-[10px] font-bold px-3 py-2 rounded whitespace-nowrap shadow-md">å°±å¯è¨˜éŒ²</button>
                                <button onclick="saveSleepLog('allnighter')"
                                    class="bg-gray-700 hover:bg-gray-600 text-orange-300 text-[10px] font-bold px-3 py-1.5 rounded whitespace-nowrap border border-gray-600">ğŸŒ™
                                    ã‚ªãƒ¼ãƒ«</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ã‚°ãƒ©ãƒ•ã‚¨ãƒªã‚¢ -->
                <div class="bg-app-panel rounded-lg border border-gray-700 p-2">
                    <div class="flex justify-end gap-2 mb-2">
                        <button onclick="changeSleepChartRange(7)"
                            class="chart-range-btn text-[10px] px-2 py-0.5 rounded bg-gray-700 text-white transition-colors"
                            data-range="7">1é€±</button>
                        <button onclick="changeSleepChartRange(14)"
                            class="chart-range-btn text-[10px] px-2 py-0.5 rounded text-gray-400 hover:bg-gray-800 transition-colors"
                            data-range="14">2é€±</button>
                        <button onclick="changeSleepChartRange(30)"
                            class="chart-range-btn text-[10px] px-2 py-0.5 rounded text-gray-400 hover:bg-gray-800 transition-colors"
                            data-range="30">1ãƒ¶æœˆ</button>
                    </div>
                    <div class="relative w-full h-48 bg-gray-900/50 rounded overflow-hidden" id="sleep-chart-container">
                        <svg id="sleep-chart-svg" width="100%" height="100%" class="w-full h-full block"></svg>
                    </div>
                    <div class="flex justify-center gap-4 mt-2 text-[10px]">
                        <span class="flex items-center gap-1"><span class="w-2 h-2 rounded-full bg-purple-400"></span>
                            å°±å¯</span>
                        <span class="flex items-center gap-1"><span class="w-2 h-2 rounded-full bg-yellow-400"></span>
                            èµ·åºŠ</span>
                        <span class="flex items-center gap-1"><span class="text-orange-400 text-[8px]">å¾¹å¤œ</span>
                            ã‚ªãƒ¼ãƒ«</span>
                    </div>
                </div>
            </div>
        </div>

        <div id="manage-screen" class="tab-content p-4 pb-32">
            <h2 class="text-lg font-bold text-white mb-4">ç§‘ç›®ãƒ»ãƒãƒ£ãƒ¬ãƒ³ã‚¸ç®¡ç†</h2>
            <div id="manage-subject-list" class="space-y-4"></div>
            <div class="mt-4 border-t border-gray-700 pt-4 space-y-4">
                <div>
                    <label class="text-[10px] font-bold text-gray-400 mb-1 block">å­¦ç¿’ç§‘ç›®ã®è¿½åŠ </label>
                    <div class="flex gap-2">
                        <input type="text" id="new-subject-name" placeholder="æ–°ã—ã„ç§‘ç›®å"
                            class="flex-1 bg-gray-900 border border-gray-700 text-white text-xs rounded px-3 py-2">
                        <button onclick="addNewSubject('study')"
                            class="bg-app-accent text-app-dark text-xs font-bold px-4 py-2 rounded hover:bg-sky-300">è¿½åŠ </button>
                    </div>
                </div>
                <div>
                    <label class="text-[10px] font-bold text-gray-400 mb-1 block">ç¶™ç¶šãƒãƒ£ãƒ¬ãƒ³ã‚¸ã®è¿½åŠ </label>
                    <div class="flex gap-2">
                        <input type="text" id="new-challenge-name" placeholder="ãƒãƒ£ãƒ¬ãƒ³ã‚¸å"
                            class="flex-1 bg-gray-900 border border-gray-700 text-white text-xs rounded px-3 py-2">
                        <button onclick="addNewSubject('challenge')"
                            class="bg-challenge-gold text-app-dark text-xs font-bold px-4 py-2 rounded hover:bg-yellow-400">è¿½åŠ </button>
                    </div>
                </div>
            </div>
            <div id="unit-editor-area"
                class="fixed inset-0 bg-black/80 backdrop-blur-sm z-[150] hidden flex items-center justify-center p-4">
                <div
                    class="bg-app-panel border border-gray-600 rounded-lg w-full max-w-lg p-5 shadow-2xl max-h-[90vh] flex flex-col overflow-hidden">

                    <div class="flex justify-between items-center mb-4 border-b border-gray-700 pb-2 shrink-0">
                        <h3 class="text-lg font-bold text-white">ç§‘ç›®ãƒ»å˜å…ƒç·¨é›†</h3>
                        <button onclick="closeUnitEditor()" class="text-gray-400 hover:text-white"><i
                                class="fas fa-times text-xl"></i></button>
                    </div>

                    <div class="overflow-y-auto flex-1 pr-1 custom-scrollbar">

                        <div class="mb-6">
                            <label class="text-[10px] text-gray-500 block mb-1">ç§‘ç›®åã‚’å¤‰æ›´</label>
                            <div class="flex gap-2">
                                <input type="text" id="edit-subject-name-input"
                                    class="flex-1 bg-gray-900 border border-gray-700 text-white text-sm rounded px-3 py-2">
                                <button onclick="updateSubjectName()"
                                    class="bg-app-accent text-app-dark text-xs font-bold px-4 rounded hover:bg-sky-300">å¤‰æ›´</button>
                            </div>
                        </div>



                        <div class="bg-gray-800/50 rounded border border-gray-700 p-3 mb-4">
                            <label class="text-[10px] text-gray-400 block mb-2 font-bold">å˜å…ƒã®è¿½åŠ ãƒ»ç·¨é›†</label>

                            <div class="flex flex-col gap-2 mb-2">
                                <div class="flex gap-2">
                                    <input type="text" id="new-unit-category" placeholder="ã‚«ãƒ†ã‚´ãƒª"
                                        class="w-1/3 bg-gray-900 border border-gray-700 text-white text-xs rounded px-2 py-2">
                                    <input type="text" id="new-unit-title" placeholder="å˜å…ƒå"
                                        class="flex-1 bg-gray-900 border border-gray-700 text-white text-xs rounded px-2 py-2">
                                </div>

                                <div class="flex flex-col gap-1">
                                    <label class="text-[10px] text-gray-500">é›£æ˜“åº¦ã‚¿ã‚°</label>
                                    <div id="new-unit-difficulty-checks" class="flex flex-wrap gap-2 min-w-[100px]">
                                    </div>
                                </div>
                                <div class="flex gap-2 items-center">
                                    <select id="new-unit-status-select"
                                        class="bg-gray-900 border border-gray-700 text-white text-xs rounded px-2 py-2 focus:border-app-accent">
                                        <option value="pending">æœªå®Œäº†</option>
                                        <option value="completed">å®Œäº† (ä»Šæ—¥)</option>
                                        <option value="completed_init" class="text-yellow-400">å®Œäº† (å…ƒã€…/0æ—¥ç›®)</option>
                                    </select>

                                    <div
                                        class="flex items-center gap-1 bg-gray-900 border border-gray-700 rounded px-2 py-2">
                                        <span class="text-[10px] text-gray-500">å‘¨å›:</span>
                                        <input type="number" id="new-unit-lap" value="0" min="0"
                                            class="w-10 bg-transparent text-white text-xs text-right outline-none">
                                    </div>

                                    <label class="flex items-center cursor-pointer">
                                        <input type="checkbox" id="new-unit-weak" class="hidden weak-checkbox">
                                        <div
                                            class="text-[10px] text-gray-500 bg-gray-900 border border-gray-700 px-3 py-2 rounded select-none hover:bg-gray-800 transition-colors flex items-center gap-1">
                                            <i class="fas fa-exclamation-triangle"></i>
                                        </div>
                                    </label>

                                    <button id="add-update-unit-btn" onclick="saveUnit()"
                                        class="bg-gray-700 text-white text-xs px-3 py-2 rounded hover:bg-gray-600 flex-1 font-bold">è¿½åŠ </button>
                                    <button id="cancel-edit-unit-btn" onclick="cancelEditUnit()"
                                        class="bg-red-900/50 text-red-200 text-xs px-2 py-2 rounded hover:bg-red-900 hidden"><i
                                            class="fas fa-times"></i></button>
                                </div>
                            </div>
                        </div>

                        <div
                            class="flex items-center justify-between mb-2 p-3 bg-gray-800 rounded border border-gray-700 sticky top-0 z-10 shadow-md">
                            <label
                                class="flex items-center gap-2 cursor-pointer text-xs text-gray-300 font-bold select-none">
                                <input type="checkbox" id="select-all-units" onchange="toggleAllUnitChecks(this)"
                                    class="accent-app-accent w-4 h-4">
                                å…¨ã¦é¸æŠ
                            </label>

                            <button onclick="openBulkEditModal()"
                                class="bg-app-accent text-app-dark text-xs font-bold px-4 py-2 rounded hover:bg-sky-300 shadow-sm flex items-center gap-2 transition-transform active:scale-95">
                                <i class="fas fa-pen-to-square"></i> é¸æŠã—ãŸå˜å…ƒã‚’ç·¨é›†
                            </button>
                        </div>

                        <!-- Modals moved to root -->

                        <div id="manage-unit-list" class="space-y-1 pb-4"></div>


                        <!-- é›£æ˜“åº¦ã‚¿ã‚°è¨­å®šï¼ˆç§»å‹•ï¼‰ -->
                        <details class="border-t border-gray-700 mt-4 pt-3">
                            <summary
                                class="text-[10px] text-gray-500 cursor-pointer hover:text-gray-300 select-none mb-2">
                                <i class="fas fa-tags mr-1"></i>é›£æ˜“åº¦ã‚¿ã‚°è¨­å®š
                            </summary>
                            <div class="bg-gray-800/50 rounded border border-gray-700 p-3 space-y-2">
                                <div id="difficulty-label-list" class="space-y-1"></div>
                                <div class="flex gap-2 mt-2">
                                    <input type="text" id="new-diff-key" placeholder="ã‚¿ã‚° (ä¾‹: D)"
                                        class="w-16 bg-gray-900 border border-gray-700 text-white text-[10px] rounded px-2 py-1 text-center">
                                    <input type="text" id="new-diff-label" placeholder="è¡¨ç¤ºå (ä¾‹: Cå•é¡Œ)"
                                        class="flex-1 bg-gray-900 border border-gray-700 text-white text-[10px] rounded px-2 py-1">
                                    <button onclick="addDifficultyLabel()"
                                        class="bg-gray-700 hover:bg-gray-600 text-white text-[10px] px-3 py-1 rounded">è¿½åŠ </button>
                                </div>
                            </div>
                        </details>

                        <!-- AIæ§‹é€ ç·¨é›†ï¼ˆæŠ˜ã‚ŠãŸãŸã¿ãƒ»ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆé–‰ã˜ï¼‰ -->
                        <details class="border-t border-gray-700 mt-4 pt-3">
                            <summary class="text-[10px] text-gray-500 cursor-pointer hover:text-gray-300 select-none">
                                <i class="fas fa-robot mr-1"></i>AIã§ã‚«ãƒ†ã‚´ãƒªæ§‹é€ ã‚’ç·¨é›†
                            </summary>
                            <div class="mt-3 space-y-3">
                                <div>
                                    <button onclick="exportSyllabusStructure()"
                                        class="w-full bg-gray-800 hover:bg-gray-700 text-gray-300 text-[10px] font-bold py-2 rounded border border-gray-700 transition-colors flex items-center justify-center gap-2">
                                        <i class="far fa-copy"></i> æ§‹é€ JSONã‚’ã‚³ãƒ”ãƒ¼ï¼ˆid + category + titleï¼‰
                                    </button>
                                    <p class="text-[9px] text-gray-600 mt-1">â€»AIã«æ¸¡ã—ã¦category, title,
                                        difficultyã‚’ç·¨é›†ã—ã¦ã‚‚ã‚‰ã£ã¦ãã ã•ã„ã€‚idã¯å¤‰æ›´ä¸å¯ã€‚</p>
                                    <button onclick="copyStructurePrompt()"
                                        class="w-full bg-gray-700 hover:bg-gray-600 text-gray-300 text-[10px] py-1 rounded border border-gray-600 transition-colors flex items-center justify-center gap-2 mt-2">
                                        <i class="fas fa-paste"></i> ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆä¾‹ã‚’ã‚³ãƒ”ãƒ¼ï¼ˆé›£æ˜“åº¦ã‚¿ã‚°ä»˜ã‘ç”¨ï¼‰
                                    </button>
                                </div>
                                <div>
                                    <textarea id="syllabus-structure-input"
                                        class="w-full bg-gray-900 border border-gray-700 text-gray-300 text-[10px] rounded p-2 h-24 font-mono"
                                        placeholder="AIãŒç·¨é›†ã—ãŸJSONã‚’ã“ã“ã«è²¼ã‚Šä»˜ã‘"></textarea>
                                    <button onclick="reimportSyllabusStructure()"
                                        class="w-full bg-gray-800 hover:bg-gray-700 text-gray-300 text-[10px] font-bold py-2 rounded border border-gray-700 transition-colors flex items-center justify-center gap-2 mt-1">
                                        <i class="fas fa-file-import"></i> æ§‹é€ ã‚’ä¸Šæ›¸ãï¼ˆcategory / title ã®ã¿æ›´æ–°ï¼‰
                                    </button>
                                </div>
                            </div>
                        </details>
                    </div>
                </div>
            </div>
            <div id="challenge-editor-area"
                class="fixed inset-0 bg-black/80 backdrop-blur-sm z-[150] hidden flex items-center justify-center p-4">
                <div
                    class="bg-app-panel border border-gray-600 rounded-lg w-full max-w-sm p-5 shadow-2xl flex flex-col">

                    <div class="flex justify-between items-center mb-4 border-b border-gray-700 pb-2">
                        <h3 class="text-lg font-bold text-white">ãƒãƒ£ãƒ¬ãƒ³ã‚¸è¨­å®š</h3>
                        <button onclick="closeChallengeEditor()" class="text-gray-400 hover:text-white"><i
                                class="fas fa-times text-xl"></i></button>
                    </div>

                    <div class="space-y-4">
                        <div>
                            <label class="text-[10px] text-gray-500 block mb-1">ãƒãƒ£ãƒ¬ãƒ³ã‚¸å</label>
                            <input type="text" id="edit-challenge-name"
                                class="w-full bg-gray-900 border border-gray-700 text-white text-sm rounded px-3 py-2 focus:border-app-accent outline-none">
                        </div>

                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="text-[10px] text-gray-500 block mb-1">é–‹å§‹æ—¥</label>
                                <input type="date" id="edit-challenge-start"
                                    class="w-full bg-gray-900 border border-gray-700 text-white text-xs rounded px-2 py-2 focus:border-app-accent outline-none">
                            </div>
                            <div>
                                <label class="text-[10px] text-gray-500 block mb-1">ç›®æ¨™æ—¥</label>
                                <input type="date" id="edit-challenge-end"
                                    class="w-full bg-gray-900 border border-gray-700 text-white text-xs rounded px-2 py-2 focus:border-app-accent outline-none">
                            </div>
                        </div>

                        <div class="pt-2 border-t border-gray-700 mt-2">
                            <label class="text-[10px] text-gray-500 block mb-1">è‡ªå‹•ãƒã‚§ãƒƒã‚¯é€£æº (ç”Ÿæ´»ãƒªã‚ºãƒ )</label>
                            <div class="mb-4">
                                <label class="text-xs text-gray-500 block mb-1">è‡ªå‹•ãƒã‚§ãƒƒã‚¯æ¡ä»¶ (ã‚ªãƒ—ã‚·ãƒ§ãƒ³)</label>
                                <select id="edit-challenge-auto-type"
                                    class="w-full bg-gray-900 border border-gray-700 rounded p-2 text-white text-xs mb-2"
                                    onchange="toggleAutoTimeInput()">
                                    <option value="">ãªã— (æ‰‹å‹•ãƒã‚§ãƒƒã‚¯)</option>
                                    <option value="waketime">èµ·åºŠæ™‚é–“ (ã“ã‚Œã‚ˆã‚Šæ—©ã„)</option>
                                    <option value="bedtime">å°±å¯æ™‚é–“ (ã“ã‚Œã‚ˆã‚Šæ—©ã„)</option>
                                    <option value="study_time">å‹‰å¼·æ™‚é–“ (ã“ã‚Œä»¥ä¸Š)</option> <!-- â˜…è¿½åŠ  -->
                                </select>

                                <div id="auto-time-input-area" class="hidden">
                                    <label class="text-xs text-gray-500 block mb-1">ç›®æ¨™å€¤ (æ™‚é–“ã¾ãŸã¯åˆ†)</label>
                                    <div class="flex items-center gap-2">
                                        <input type="text" id="edit-challenge-target-time"
                                            class="flex-1 bg-gray-900 border border-gray-700 text-white text-xs rounded p-2"
                                            placeholder="07:00 ã¾ãŸã¯ 60">
                                        <span class="text-[10px] text-gray-400" id="auto-time-unit-label"></span>
                                    </div>
                                    <p class="text-[10px] text-gray-500 mt-1" id="auto-time-help-text">
                                        â€»èµ·åºŠãƒ»å°±å¯ã¯ã€ŒHH:MMã€ã€å‹‰å¼·æ™‚é–“ã¯ã€Œåˆ†ã€ã§å…¥åŠ›
                                    </p>
                                </div>
                            </div>

                            <div class="pt-2">
                                <button onclick="saveChallengeSettings()"
                                    class="w-full bg-challenge-gold text-app-dark text-sm font-bold py-2.5 rounded hover:bg-yellow-400 transition-colors shadow-md">
                                    è¨­å®šã‚’ä¿å­˜
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div id="gemini-import-area" class="mb-6 border-t border-gray-700 pt-6">
                <h3 class="text-xs font-bold text-gray-400 mb-2 uppercase flex items-center gap-2"><i
                        class="fas fa-robot text-purple-400"></i> AIã§ç§‘ç›®è¿½åŠ  (Gemini)</h3>
                <div class="bg-gray-800/50 p-3 rounded border border-gray-700 mb-3">
                    <div class="relative">
                        <textarea id="gemini-prompt-template"
                            class="w-full bg-gray-900 border border-gray-700 text-gray-300 text-[10px] rounded p-2 h-20"
                            readonly>ã€Œ[ç§‘ç›®å]ã€ã¨ã„ã†ç§‘ç›®ã®å­¦ç¿’é€²æ—ç®¡ç†ç”¨ã®ãƒ‡ãƒ¼ã‚¿ã‚’JSONå½¢å¼ã§ä½œæˆã—ã¦ãã ã•ã„ã€‚
å½¢å¼:
{
  "name": "[ç§‘ç›®å]",
  "syllabus": [
    {"category": "ã‚«ãƒ†ã‚´ãƒªå", "title": "å˜å…ƒå1"},
    {"category": "ã‚«ãƒ†ã‚´ãƒªå", "title": "å˜å…ƒå2"}
  ]
}
â€»syllabusã®å„è¦ç´ ã®categoryã¨titleã¯æ—¥æœ¬èªã§ä½œæˆã—ã¦ãã ã•ã„ã€‚</textarea>
                        <button onclick="copyPrompt()"
                            class="absolute top-1 right-1 bg-gray-700 hover:bg-gray-600 text-white text-[10px] px-2 py-1 rounded">ã‚³ãƒ”ãƒ¼</button>
                    </div>
                </div>
                <div class="flex gap-2">
                    <input type="text" id="gemini-json-input" placeholder='Geminiã®å‡ºåŠ›JSONã‚’ã“ã“ã«è²¼ã‚Šä»˜ã‘'
                        class="flex-1 bg-gray-900 border border-gray-700 text-white text-xs rounded px-3 py-2">
                    <button onclick="importFromGemini()"
                        class="bg-purple-600 hover:bg-purple-500 text-white text-xs font-bold px-4 py-2 rounded">å–ã‚Šè¾¼ã¿</button>
                </div>
            </div>

            <div class="mt-8 border-t border-gray-700 pt-6">
                <h3 class="text-sm font-bold text-gray-400 mb-4 flex items-center gap-2">
                    <i class="fas fa-bullhorn text-orange-400"></i> å­¦ç¿’ãƒ†ã‚£ãƒƒã‚«ãƒ¼è¨­å®š
                </h3>

                <div class="bg-gray-800/50 rounded border border-gray-700 p-4 mb-4">
                    <div class="flex justify-between items-center mb-4 border-b border-gray-700 pb-2">
                        <label class="text-xs font-bold text-gray-300">ãƒ†ã‚£ãƒƒã‚«ãƒ¼è¡¨ç¤º</label>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" id="ticker-enabled-toggle" class="sr-only peer"
                                onchange="toggleTickerEnabled()">
                            <div
                                class="w-11 h-6 bg-gray-600 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-800 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600">
                            </div>
                        </label>
                    </div>

                    <div class="flex justify-between items-center mb-2">
                        <label class="text-xs font-bold text-gray-300">ã‚«ãƒ†ã‚´ãƒªä¸€è¦§</label>
                        <div class="flex gap-2">
                            <button onclick="openBulkWeightEditor()"
                                class="text-[10px] text-sky-400 hover:text-sky-300 underline">é‡ã¿ä¸€æ‹¬ç·¨é›†</button>
                            <button onclick="resetTickerData()"
                                class="text-[10px] text-red-400 hover:text-red-300 underline">åˆæœŸåŒ–</button>
                        </div>
                    </div>
                    <div id="ticker-category-list" class="space-y-2 mb-4"></div>
                    <button onclick="addNewTickerCategory()"
                        class="w-full py-2 bg-gray-700 hover:bg-gray-600 text-white text-xs font-bold rounded border border-gray-600 mb-4"><i
                            class="fas fa-plus"></i> ã‚«ãƒ†ã‚´ãƒªã‚’è¿½åŠ </button>

                    <label class="text-xs font-bold text-gray-300 block mb-2">ãƒ‡ãƒ¼ã‚¿ä¸€æ‹¬ã‚¤ãƒ³ãƒãƒ¼ãƒˆ (JSON)</label>
                    <div class="relative mb-2">
                        <textarea id="ticker-json-input"
                            class="w-full bg-gray-900 border border-gray-700 text-gray-300 text-[10px] rounded p-2 h-20 font-mono"
                            placeholder='{"categories": [...], "messages": [...]}'></textarea>
                        <button onclick="copyTickerPrompt()"
                            class="absolute top-1 right-1 bg-gray-700 hover:bg-gray-600 text-white text-[10px] px-2 py-1 rounded flex items-center gap-1">
                            ã‚³ãƒ”ãƒ¼
                        </button>
                    </div>
                    <div class="flex justify-end">
                        <button onclick="importTickerData()"
                            class="bg-app-accent text-app-dark text-xs font-bold px-4 py-2 rounded hover:bg-sky-300">
                            è¿½åŠ ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
                        </button>
                    </div>
                </div>
                <div class="text-[10px] text-gray-500 text-right">
                    ç™»éŒ²ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æ•°: <span id="ticker-msg-count">0</span> ä»¶
                </div>
            </div>

            <div id="ticker-category-editor"
                class="fixed inset-0 bg-black/80 backdrop-blur-sm z-[200] hidden flex items-center justify-center p-4">
                <div
                    class="bg-app-panel border border-gray-600 rounded-lg w-full max-w-md p-5 shadow-2xl flex flex-col max-h-[90vh]">
                    <div class="flex justify-between items-center mb-4 border-b border-gray-700 pb-2">
                        <h3 class="text-lg font-bold text-white">ã‚«ãƒ†ã‚´ãƒªç·¨é›†</h3>
                        <button onclick="closeTickerCategoryEditor()" class="text-gray-400 hover:text-white"><i
                                class="fas fa-times text-xl"></i></button>
                    </div>

                    <div class="overflow-y-auto flex-1 pr-1 custom-scrollbar">
                        <div class="space-y-4 mb-6">
                            <div>
                                <label class="text-[10px] text-gray-500 block mb-1">ã‚«ãƒ†ã‚´ãƒªå</label>
                                <input type="text" id="edit-ticker-cat-name"
                                    class="w-full bg-gray-900 border border-gray-700 text-white text-xs rounded px-3 py-2">
                            </div>

                            <div>
                                <label class="text-[10px] text-gray-500 block mb-2">ã‚«ãƒ©ãƒ¼</label>
                                <div id="edit-ticker-cat-color-palette" class="grid grid-cols-8 gap-2">
                                </div>
                                <input type="hidden" id="edit-ticker-cat-color-value">
                            </div>

                            <div>
                                <label class="text-[10px] text-gray-500 block mb-1">å‡ºç¾é‡ã¿: <span
                                        id="edit-ticker-cat-weight-value" class="font-bold text-white">10</span></label>
                                <input type="range" id="edit-ticker-cat-weight" min="1" max="20"
                                    class="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer">
                            </div>

                            <button onclick="saveTickerCategoryInfo()"
                                class="w-full bg-gray-700 hover:bg-gray-600 text-white text-xs font-bold py-2 rounded border border-gray-600">è¨­å®šã‚’æ›´æ–°</button>
                        </div>

                        <div class="border-t border-gray-700 pt-4">
                            <label class="text-xs font-bold text-gray-300 block mb-2">ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒªã‚¹ãƒˆ</label>
                            <div class="flex gap-2 mb-2">
                                <input type="text" id="new-ticker-msg-input" placeholder="æ–°ã—ã„ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸"
                                    class="flex-1 bg-gray-900 border border-gray-700 text-white text-xs rounded px-3 py-2">
                                <button onclick="addTickerMessageInEditor()"
                                    class="bg-app-accent text-app-dark text-xs font-bold px-3 py-2 rounded hover:bg-sky-300">è¿½åŠ </button>
                            </div>
                            <div id="editor-ticker-msg-list"
                                class="space-y-1 bg-gray-900 p-2 rounded border border-gray-700 min-h-[150px]">
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ãƒ†ã‚£ãƒƒã‚«ãƒ¼é‡ã¿ä¸€æ‹¬ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
            <div id="ticker-bulk-weight-editor"
                class="fixed inset-0 bg-black/80 backdrop-blur-sm z-[210] hidden flex items-center justify-center p-4">
                <div
                    class="bg-app-panel border border-gray-600 rounded-lg w-full max-w-md p-5 shadow-2xl flex flex-col max-h-[90vh]">
                    <div class="flex justify-between items-center mb-4 border-b border-gray-700 pb-2">
                        <h3 class="text-lg font-bold text-white">é‡ã¿ä¸€æ‹¬ç·¨é›†</h3>
                        <button onclick="closeBulkWeightEditor()" class="text-gray-400 hover:text-white"><i
                                class="fas fa-times text-xl"></i></button>
                    </div>

                    <div id="bulk-weight-list" class="overflow-y-auto flex-1 pr-1 custom-scrollbar space-y-3 mb-4">
                        <!-- ã“ã“ã«ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ãŒå‹•çš„ã«ç”Ÿæˆã•ã‚Œã‚‹ -->
                    </div>

                    <div class="flex gap-2">
                        <button onclick="closeBulkWeightEditor()"
                            class="flex-1 bg-gray-800 text-gray-300 text-xs font-bold py-2.5 rounded border border-gray-600 hover:bg-gray-700">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                        <button onclick="saveBulkWeights()"
                            class="flex-1 bg-app-accent text-app-dark text-xs font-bold py-2.5 rounded hover:bg-sky-300 shadow-md">
                            ä¿å­˜ã™ã‚‹
                        </button>
                    </div>
                </div>
            </div>
        </div>

    </main>

    <nav id="app-nav"
        class="fixed bottom-0 left-0 w-full bg-app-panel/95 backdrop-blur-md border-t border-gray-700 flex justify-between items-end h-16 shrink-0 z-50 px-1 overflow-visible">

        <button
            class="nav-btn flex-1 flex flex-col items-center justify-center pb-2 h-full text-gray-500 hover:text-white transition-colors"
            data-target="home-screen">
            <i class="fas fa-chart-pie text-lg mb-1"></i><span
                class="text-[9px] font-medium tracking-tighter">ãƒ›ãƒ¼ãƒ </span>
        </button>

        <button
            class="nav-btn flex-1 flex flex-col items-center justify-center pb-2 h-full text-gray-500 hover:text-white transition-colors"
            data-target="calendar-screen">
            <i class="far fa-calendar-alt text-lg mb-1"></i><span
                class="text-[9px] font-medium tracking-tighter">ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼</span>
        </button>

        <div class="nav-center-wrapper">
            <button class="nav-center-btn" onclick="switchTab('record-screen')">
                <i class="fas fa-pencil-alt"></i><span>è¨˜éŒ²</span>
            </button>
        </div>

        <button
            class="nav-btn flex-1 flex flex-col items-center justify-center pb-2 h-full text-gray-500 hover:text-white transition-colors"
            data-target="challenge-screen">
            <i class="fas fa-fire text-lg mb-1"></i><span class="text-[9px] font-medium tracking-tighter">ç¿’æ…£</span>
        </button>

        <button
            class="nav-btn flex-1 flex flex-col items-center justify-center pb-2 h-full text-gray-500 hover:text-white transition-colors"
            data-target="manage-screen">
            <i class="fas fa-sliders-h text-lg mb-1"></i><span class="text-[9px] font-medium tracking-tighter">ç®¡ç†</span>
        </button>
    </nav>

    <div id="date-modal"
        class="fixed inset-0 bg-black/80 backdrop-blur-sm z-[100] hidden flex items-center justify-center p-4">
        <div
            class="bg-app-panel border border-gray-600 rounded-lg w-full max-w-sm p-5 shadow-2xl flex flex-col max-h-[90vh]">
            <div class="flex justify-between items-center mb-4 border-b border-gray-700 pb-2">
                <h3 id="modal-date-title" class="text-lg font-bold text-white"></h3>
                <button onclick="closeModal()" class="text-gray-400 hover:text-white"><i
                        class="fas fa-times text-xl"></i></button>
            </div>
            <div class="mb-4 overflow-y-auto flex-1">
                <div id="modal-study-content">
                    <button id="set-exam-btn"
                        class="w-full py-2 px-3 bg-gray-700 hover:bg-gray-600 text-yellow-400 rounded text-xs font-bold mb-4 flex items-center justify-center gap-2 border border-gray-600 shadow-sm">
                        <i class="fas fa-flag"></i> <span id="exam-btn-text">ç›®æ¨™æ—¥ã«è¨­å®š</span>
                    </button>
                    <h4
                        class="text-xs text-app-success mb-2 font-bold uppercase tracking-wider flex items-center gap-1">
                        <i class="fas fa-check-circle"></i> å®Œäº†å®Ÿç¸¾
                    </h4>
                    <div id="modal-completed-list"
                        class="bg-gray-900/50 rounded border border-gray-700 mb-4 p-2 text-sm text-gray-400 min-h-[40px]">
                    </div>
                    <h4 class="text-xs text-gray-400 mb-2 font-bold uppercase tracking-wider">å­¦ç¿’äºˆå®š</h4>
                    <div id="modal-task-list" class="bg-gray-900 rounded border border-gray-700 mb-2"></div>
                    <div class="flex gap-2 items-center border-t border-gray-700 pt-2 mt-2">
                        <div class="relative flex-1 min-w-0">
                            <select id="unit-selector"
                                class="w-full bg-gray-900 border border-gray-700 text-white text-xs rounded px-2 py-2 appearance-none focus:outline-none focus:border-app-accent truncate pr-6 cursor-pointer">
                            </select>
                            <div
                                class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-400">
                                <i class="fas fa-chevron-down text-[10px]"></i>
                            </div>
                        </div>
                        <button onclick="addUnitToDate()"
                            class="bg-app-accent text-app-dark font-bold px-3 py-2 rounded hover:bg-sky-300 shrink-0 flex items-center justify-center">
                            <i class="fas fa-plus"></i>
                        </button>
                    </div>
                </div>
                <div id="modal-challenge-content" class="hidden">
                    <p class="text-sm text-gray-300 mb-4" id="modal-challenge-status">ã“ã®æ—¥ã®ãƒãƒ£ãƒ¬ãƒ³ã‚¸è¨˜éŒ²:</p>
                    <button id="toggle-challenge-date-btn"
                        class="w-full py-3 rounded-lg font-bold text-sm shadow-md"></button>
                </div>
            </div>
            <button onclick="closeModal()"
                class="w-full py-2 bg-gray-800 hover:bg-gray-700 text-gray-300 rounded text-sm border border-gray-600">é–‰ã˜ã‚‹</button>
        </div>
    </div>

    <div id="settings-modal"
        class="fixed inset-0 bg-black/80 backdrop-blur-sm z-[120] hidden flex items-center justify-center p-4">
        <div class="bg-app-panel border border-gray-600 rounded-lg w-full max-w-sm p-5 shadow-2xl">
            <div class="flex justify-between items-center mb-4 border-b border-gray-700 pb-2">
                <div class="flex items-baseline gap-2">
                    <h3 class="text-lg font-bold text-white">è¨­å®š</h3>
                    <span id="app-version-display" class="text-[10px] text-gray-500 font-mono">v1.0.0</span>
                </div>
                <button onclick="closeSettingsModal()" class="text-gray-400 hover:text-white"><i
                        class="fas fa-times text-xl"></i></button>
            </div>
            <div class="space-y-6">
                <div>
                    <h4 class="text-xs font-bold text-gray-400 mb-2 uppercase tracking-widest">è¡¨ç¤ºè¨­å®š</h4>
                    <button id="theme-toggle-btn" onclick="toggleTheme()"
                        class="w-full py-2 bg-gray-700 hover:bg-gray-600 text-white rounded text-xs flex items-center justify-center gap-2 border border-gray-600">
                        <i class="fas fa-moon"></i> <span>ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰ä¸­</span>
                    </button>
                </div>
                <div>
                    <h4 class="text-xs font-bold text-gray-400 mb-2 uppercase tracking-widest">ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ</h4>
                    <button onclick="firebase.auth().signOut()"
                        class="w-full py-2 bg-gray-700 hover:bg-gray-600 text-white rounded text-xs mb-2">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
                </div>

                <div>
                    <h4 class="text-xs font-bold text-gray-400 mb-2 uppercase tracking-widest">ãƒ‡ãƒ¼ã‚¿ç®¡ç†</h4>
                    <div class="text-[10px] text-app-success mb-2">â€»ãƒ‡ãƒ¼ã‚¿ã¯ã‚¯ãƒ©ã‚¦ãƒ‰ã«è‡ªå‹•ä¿å­˜ã•ã‚Œã¦ã„ã¾ã™</div>

                    <div class="flex flex-col gap-2">
                        <button onclick="exportToGoogleSheets()"
                            class="w-full py-2.5 bg-green-700 hover:bg-green-600 text-white rounded text-xs font-bold border border-green-500 flex items-center justify-center gap-2 transition-colors">
                            <i class="fas fa-table"></i> Geminiåˆ†æç”¨ã‚·ãƒ¼ãƒˆã‚’ä½œæˆ (ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆ)
                        </button>

                        <div class="flex gap-2">
                            <button onclick="exportData()"
                                class="flex-1 py-2.5 bg-app-panel border border-app-accent text-app-accent rounded text-xs font-bold hover:bg-app-accent/10"><i
                                    class="fas fa-download"></i> JSONãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—</button>
                            <button onclick="document.getElementById('import-file').click()"
                                class="flex-1 py-2.5 bg-app-panel border border-gray-600 text-gray-300 rounded text-xs font-bold hover:bg-gray-700"><i
                                    class="fas fa-upload"></i> å¾©å…ƒ</button>
                            <input type="file" id="import-file" class="hidden" accept=".json"
                                onchange="importData(this)">
                        </div>
                    </div>
                </div>
                <div class="pt-2 border-t border-gray-800">
                    <button onclick="location.reload(true)"
                        class="w-full py-2 text-[10px] text-gray-500 hover:text-white mb-2">æœ€æ–°ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’å†èª­ã¿è¾¼ã¿
                        (å¼·åˆ¶ãƒªãƒ­ãƒ¼ãƒ‰)</button>
                    <button onclick="requestReset()"
                        class="w-full py-2 text-[10px] text-red-400 opacity-50 hover:opacity-100">ãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆ</button>
                </div>
            </div>
        </div>
    </div>

    <div id="app-modal"
        class="fixed inset-0 bg-black/80 backdrop-blur-md z-[200] hidden flex items-center justify-center p-6">
        <div id="custom-alert-box"
            class="bg-app-panel border border-gray-600 rounded-xl w-full max-w-xs p-6 shadow-2xl">
            <h3 id="app-modal-title" class="text-lg font-bold text-white mb-3">ç¢ºèª</h3>
            <p id="app-modal-body" class="text-sm text-gray-300 mb-6 leading-relaxed"></p>
            <div id="app-modal-footer" class="flex gap-3">
                <button id="app-modal-cancel"
                    class="flex-1 py-2 bg-gray-800 text-gray-400 rounded-lg text-sm font-bold border border-gray-700">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button id="app-modal-ok"
                    class="flex-1 py-2 bg-red-600 text-white rounded-lg text-sm font-bold shadow-lg">å®Ÿè¡Œã™ã‚‹</button>
            </div>
        </div>
    </div>

    <div id="bulk-edit-modal"
        class="fixed inset-0 bg-black/80 backdrop-blur-sm z-[200] hidden flex items-center justify-center p-4">
        <div class="bg-app-panel border border-gray-600 rounded-lg w-full max-w-sm p-5 shadow-2xl flex flex-col">
            <div class="flex justify-between items-center mb-4 border-b border-gray-700 pb-2">
                <h3 class="text-lg font-bold text-white">ä¸€æ‹¬ç·¨é›†</h3>
                <button onclick="closeBulkEditModal()" class="text-gray-400 hover:text-white"><i
                        class="fas fa-times text-xl"></i></button>
            </div>

            <div class="space-y-5">
                <div class="bg-app-accent/10 border border-app-accent/20 rounded p-2 text-center">
                    <span id="bulk-selected-count" class="text-app-accent font-bold text-sm">0</span>
                    <span class="text-xs text-gray-400">ä»¶ã®å˜å…ƒã‚’é¸æŠä¸­</span>
                </div>

                <div>
                    <label class="text-[10px] text-gray-500 block mb-1 font-bold">ã‚«ãƒ†ã‚´ãƒªã‚’å¤‰æ›´</label>
                    <input type="text" id="bulk-edit-category" placeholder="å¤‰æ›´ã—ãªã„å ´åˆã¯ç©ºæ¬„"
                        class="w-full bg-gray-900 border border-gray-700 text-white text-xs rounded px-3 py-2">
                </div>

                <div>
                    <label class="text-[10px] text-gray-500 block mb-1 font-bold">é›£æ˜“åº¦ã‚¿ã‚° (ä¸Šæ›¸ã)</label>
                    <div id="bulk-edit-difficulty-checks"
                        class="flex flex-wrap gap-2 p-2 bg-gray-900/50 rounded border border-gray-700"></div>
                </div>

                <div>
                    <label class="text-[10px] text-gray-500 block mb-1 font-bold">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ»å®Œäº†æ—¥</label>
                    <div class="flex flex-col gap-2">
                        <select id="bulk-edit-status"
                            class="w-full bg-gray-900 border border-gray-700 text-white text-xs rounded px-3 py-2"
                            onchange="toggleBulkDateInputInModal()">
                            <option value="no-change">å¤‰æ›´ã—ãªã„</option>
                            <option value="pending">æœªå®Œäº†ã«æˆ»ã™</option>
                            <option value="completed">å®Œäº† (ä»Šæ—¥)</option>
                            <option value="completed_date">å®Œäº† (æ—¥ä»˜ã‚’æŒ‡å®š)</option>
                            <option value="initial">æ—¢é‚ (0æ—¥ç›®) ã«ã™ã‚‹</option>
                        </select>
                        <input type="date" id="bulk-edit-date"
                            class="hidden w-full bg-gray-900 border border-gray-700 text-white text-xs rounded px-3 py-2">
                    </div>
                </div>



                <div>
                    <label class="text-[10px] text-gray-500 block mb-1 font-bold">å‘¨å›æ•°</label>
                    <input type="number" id="bulk-edit-lap" placeholder="å¤‰æ›´ã—ãªã„å ´åˆã¯ç©ºæ¬„" min="0"
                        class="w-full bg-gray-900 border border-gray-700 text-white text-xs rounded px-3 py-2">
                </div>

                <div class="pt-2 flex gap-2">
                    <button onclick="closeBulkEditModal()"
                        class="flex-1 bg-gray-800 text-gray-300 text-xs font-bold py-2.5 rounded border border-gray-600 hover:bg-gray-700">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                    <button onclick="applyCombinedBulkEdit()"
                        class="flex-1 bg-app-accent text-app-dark text-xs font-bold py-2.5 rounded hover:bg-sky-300 shadow-md">
                        å¤‰æ›´ã‚’é©ç”¨
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div id="single-unit-edit-modal"
        class="fixed inset-0 bg-black/80 backdrop-blur-sm z-[200] hidden flex items-center justify-center p-4">
        <div class="bg-app-panel border border-gray-600 rounded-lg w-full max-w-sm p-5 shadow-2xl flex flex-col">
            <div class="flex justify-between items-center mb-4 border-b border-gray-700 pb-2">
                <h3 class="text-lg font-bold text-white">å˜å…ƒã®ç·¨é›†</h3>
                <button onclick="closeSingleUnitEditModal()" class="text-gray-400 hover:text-white"><i
                        class="fas fa-times text-xl"></i></button>
            </div>

            <div class="space-y-4">
                <div class="flex gap-2">
                    <div class="w-1/3">
                        <label class="text-[10px] text-gray-500 block mb-1 font-bold">ã‚«ãƒ†ã‚´ãƒª</label>
                        <input type="text" id="single-edit-category"
                            class="w-full bg-gray-900 border border-gray-700 text-white text-xs rounded px-3 py-2">
                    </div>
                    <div class="flex-1">
                        <label class="text-[10px] text-gray-500 block mb-1 font-bold">å˜å…ƒå</label>
                        <input type="text" id="single-edit-title"
                            class="w-full bg-gray-900 border border-gray-700 text-white text-xs rounded px-3 py-2">
                    </div>
                </div>
                <div>
                    <label class="text-[10px] text-gray-500 block mb-1 font-bold">é›£æ˜“åº¦ã‚¿ã‚°</label>
                    <div id="single-edit-difficulty-checks"
                        class="flex flex-wrap gap-2 p-2 bg-gray-900/50 rounded border border-gray-700"></div>
                </div>

                <div>
                    <label class="text-[10px] text-gray-500 block mb-1 font-bold">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ»å®Œäº†æ—¥</label>
                    <div class="flex flex-col gap-2">
                        <select id="single-edit-status"
                            class="w-full bg-gray-900 border border-gray-700 text-white text-xs rounded px-3 py-2"
                            onchange="toggleSingleEditDateInput()">
                            <option value="pending">æœªå®Œäº†</option>
                            <option value="completed">å®Œäº† (ä»Šæ—¥)</option>
                            <option value="completed_date">å®Œäº† (æ—¥ä»˜ã‚’æŒ‡å®š)</option>
                            <option value="initial">æ—¢é‚ (0æ—¥ç›®)</option>
                        </select>
                        <input type="date" id="single-edit-date"
                            class="hidden w-full bg-gray-900 border border-gray-700 text-white text-xs rounded px-3 py-2">
                    </div>
                </div>

                <div class="flex gap-3">
                    <div class="flex-1">
                        <label class="text-[10px] text-gray-500 block mb-1 font-bold">å‘¨å›æ•°</label>
                        <input type="number" id="single-edit-lap" min="0"
                            class="w-full bg-gray-900 border border-gray-700 text-white text-xs rounded px-3 py-2">
                    </div>
                    <div class="flex-1 flex flex-col justify-end">
                        <label
                            class="flex items-center gap-2 cursor-pointer bg-gray-900 border border-gray-700 rounded px-3 py-2 hover:bg-gray-800 transition-colors h-[34px]">
                            <input type="checkbox" id="single-edit-weak" class="accent-app-weak">
                            <span class="text-xs text-gray-300 flex items-center gap-1"><i
                                    class="fas fa-exclamation-triangle text-app-weak"></i> è‹¦æ‰‹</span>
                        </label>
                    </div>
                </div>

                <div class="pt-2 flex gap-2">
                    <button onclick="closeSingleUnitEditModal()"
                        class="flex-1 bg-gray-800 text-gray-300 text-xs font-bold py-2.5 rounded border border-gray-600 hover:bg-gray-700">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                    <button onclick="saveSingleUnitEdit()"
                        class="flex-1 bg-app-accent text-app-dark text-xs font-bold py-2.5 rounded hover:bg-sky-300 shadow-md">
                        æ›´æ–°ã™ã‚‹
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div id="app-toast"
        class="fixed bottom-24 left-1/2 -translate-x-1/2 bg-gray-800 text-white px-4 py-2 rounded-full text-xs font-bold border border-gray-600 shadow-2xl z-[300] hidden transition-opacity duration-300 opacity-0">
    </div>

    <script>
        // --- 1. Variables & Base Data ---
        const APP_VERSION = "v4.4";
        const ALL_SUBJECTS_ID = 'all';
        const SUBJECT_FIXED_COLORS = { chemistry: 'text-app-accent', math: 'text-green-400', physics: 'text-purple-400' };
        const COLOR_PALETTE = ['text-sky-400', 'text-emerald-400', 'text-violet-400', 'text-amber-400', 'text-rose-400', 'text-fuchsia-400', 'text-cyan-400', 'text-lime-400', 'text-indigo-400', 'text-pink-400', 'text-yellow-400', 'text-teal-400', 'text-blue-500', 'text-green-500', 'text-purple-500', 'text-orange-500', 'text-red-500', 'text-blue-300', 'text-green-300', 'text-purple-300', 'text-orange-300', 'text-rose-300', 'text-emerald-300', 'text-sky-300'];
        const TICKER_COLOR_CLASSES = [
            'text-red-400', 'text-orange-400', 'text-amber-400', 'text-yellow-400',
            'text-lime-400', 'text-green-400', 'text-emerald-400', 'text-teal-400',
            'text-cyan-400', 'text-sky-400', 'text-blue-400', 'text-indigo-400',
            'text-violet-400', 'text-purple-400', 'text-fuchsia-400', 'text-pink-400',
            'text-rose-400', 'text-gray-400'
        ];

        const defaultSubjects = {
            chemistry: { id: 'chemistry', type: 'study', name: 'åŒ–å­¦', examDate: null, startDate: null, isActive: true, syllabus: [], history: {} }
        };

        const defaultTicker = {
            categories: [
                { id: 'tips', name: 'Tips', color: 'text-blue-400', weight: 10 },
                { id: 'quote', name: 'åè¨€', color: 'text-yellow-400', weight: 5 }
            ],
            messages: [], // åˆæœŸã¯ç©º
            isPaused: false,
            isEnabled: true
        };



        let appData = getBlankData();
        let currentRecordDate = new Date();
        let currentCalendarDate = new Date();
        let selectedDateString = null;
        let editingSubjectId = null;
        let editingUnitIndex = null;

        let tickerInterval = null;
        let editingTickerCatId = null;

        // --- 2. Utils ---

        function escapeHtml(text) {
            if (text === null || text === undefined) return '';
            return String(text)
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }
        function getToday() { return new Date(); }
        function getTodayStr() { return formatDate(getToday()); }
        function formatDate(date) { const y = date.getFullYear(); const m = String(date.getMonth() + 1).padStart(2, '0'); const d = String(date.getDate()).padStart(2, '0'); return `${y}-${m}-${d}`; }
        function formatShortDate(date) { return `${date.getMonth() + 1}/${date.getDate()}`; }
        function getActiveSubjects() { return Object.values(appData.subjects).filter(s => s.isActive && s.type === 'study'); }
        function getActiveChallenges() { return Object.values(appData.subjects).filter(s => s.isActive && s.type === 'challenge'); }

        function getSubjectColor(subjId) {
            if (SUBJECT_FIXED_COLORS[subjId]) return SUBJECT_FIXED_COLORS[subjId];
            const subj = appData.subjects[subjId];
            if (!subj) return 'text-gray-400';
            if (subj.type === 'challenge') return 'text-challenge-gold';
            let hash = 0; const name = subj.name;
            for (let i = 0; i < name.length; i++) { hash = name.charCodeAt(i) + ((hash << 5) - hash); }
            const index = Math.abs(hash) % COLOR_PALETTE.length;
            return COLOR_PALETTE[index];
        }

        function showToast(msg) {
            const toast = document.getElementById('app-toast');
            if (!toast) return;
            toast.textContent = msg; toast.classList.remove('hidden');
            setTimeout(() => { toast.classList.remove('opacity-0'); toast.classList.add('opacity-100'); }, 10);
            setTimeout(() => { toast.classList.replace('opacity-100', 'opacity-0'); setTimeout(() => toast.classList.add('hidden'), 300); }, 2500);
        }

        function showAppConfirm(title, body, onOk) {
            const modal = document.getElementById('app-modal');
            document.getElementById('app-modal-title').textContent = title;
            document.getElementById('app-modal-body').textContent = body;
            const okBtn = document.getElementById('app-modal-ok');
            const cancelBtn = document.getElementById('app-modal-cancel');
            modal.classList.remove('hidden');
            const newOkBtn = okBtn.cloneNode(true); okBtn.parentNode.replaceChild(newOkBtn, okBtn);
            newOkBtn.onclick = () => { modal.classList.add('hidden'); onOk(); };
            cancelBtn.onclick = () => { modal.classList.add('hidden'); };
        }

        function copyTextToClipboard(text) {
            const textArea = document.createElement("textarea"); textArea.value = text; document.body.appendChild(textArea); textArea.select(); document.execCommand('copy'); document.body.removeChild(textArea);
        }

        // =========================================================
        // --- 3. Data Logic (Firebase Cloud Sync & Secure Auth) ---
        // =========================================================

        // Firebase config is loaded from firebase-config.js

        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const db = firebase.firestore();

        let currentUserDocId = null;

        let googleAccessToken = null; // â˜…è¿½åŠ ï¼šGoogle APIç”¨ãƒˆãƒ¼ã‚¯ãƒ³

        // â˜…ä¿®æ­£ç‰ˆï¼šé€£æ‰“é˜²æ­¢æ©Ÿèƒ½ä»˜ãã®ãƒ­ã‚°ã‚¤ãƒ³é–¢æ•°
        // â˜…ä¿®æ­£ç‰ˆï¼šãƒ­ã‚°ã‚¢ã‚¦ãƒˆå¾Œã®å†ãƒ­ã‚°ã‚¤ãƒ³ã‚‚å¯èƒ½ãªãƒ­ã‚°ã‚¤ãƒ³é–¢æ•°
        let isLoginProcessing = false;

        function performGoogleLogin(onSuccess) {
            // å‡¦ç†ä¸­ãªã‚‰ä½•ã‚‚ã—ãªã„
            if (isLoginProcessing) return;
            isLoginProcessing = true;

            const btn = document.querySelector('button[onclick="performGoogleLogin()"]');
            if (btn) {
                btn.style.opacity = "0.5";
                btn.innerText = "æ¥ç¶šä¸­...";
            }

            const provider = new firebase.auth.GoogleAuthProvider();
            provider.addScope('https://www.googleapis.com/auth/tasks');
            provider.addScope('https://www.googleapis.com/auth/spreadsheets');

            firebase.auth().signInWithPopup(provider)
                .then((result) => {
                    googleAccessToken = result.credential.accessToken;
                    document.getElementById('login-error').textContent = "";

                    // â˜…ã“ã“ãŒä¿®æ­£ç‚¹ï¼šæˆåŠŸæ™‚ã‚‚ã—ã£ã‹ã‚Šãƒ•ãƒ©ã‚°ã¨ãƒœã‚¿ãƒ³ã‚’å…ƒã«æˆ»ã™
                    isLoginProcessing = false;
                    if (btn) {
                        btn.style.opacity = "1";
                        btn.innerHTML = `<svg class="w-5 h-5 mr-3" viewBox="0 0 24 24"><path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" fill="#4285F4"/><path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/><path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.84z" fill="#FBBC05"/><path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/></svg>Googleã§ãƒ­ã‚°ã‚¤ãƒ³`;
                    }
                    // ãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸå¾Œã®ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚’å®Ÿè¡Œ
                    if (typeof onSuccess === 'function') onSuccess();
                })
                .catch((error) => {
                    console.error(error);
                    let msg = "ãƒ­ã‚°ã‚¤ãƒ³å¤±æ•—: " + error.message;

                    if (error.code === 'auth/cancelled-popup-request') {
                        msg = "ã‚¨ãƒ©ãƒ¼: ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ãŒæ—¢ã«é–‹ã„ã¦ã„ã‚‹ã‹ã€é€£æ‰“ã•ã‚Œã¾ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚";
                    } else if (error.code === 'auth/popup-closed-by-user') {
                        msg = "ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ãŒé–‰ã˜ã‚‰ã‚Œã¾ã—ãŸã€‚";
                    } else if (error.code === 'auth/popup-blocked') {
                        msg = "ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ãŒãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã¾ã—ãŸã€‚ãƒ–ãƒ©ã‚¦ã‚¶ã®è¨­å®šã‚’è¨±å¯ã—ã¦ãã ã•ã„ã€‚";
                    } else if (error.message.includes("The requested action is invalid")) {
                        msg = "è¨­å®šã‚¨ãƒ©ãƒ¼: Firebaseã®ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã§ã€Œæ‰¿èªæ¸ˆã¿ãƒ‰ãƒ¡ã‚¤ãƒ³ã€ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚";
                    }

                    document.getElementById('login-error').textContent = msg;

                    // å¤±æ•—æ™‚ã‚‚æˆ»ã™
                    isLoginProcessing = false;
                    if (btn) {
                        btn.style.opacity = "1";
                        btn.innerHTML = `<svg class="w-5 h-5 mr-3" viewBox="0 0 24 24"><path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" fill="#4285F4"/><path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/><path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.84z" fill="#FBBC05"/><path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/></svg>Googleã§ãƒ­ã‚°ã‚¤ãƒ³`;
                    }
                });
        }

        // â˜…è¿½åŠ ï¼šGoogle ToDoãƒªã‚¹ãƒˆã¸é€ä¿¡ã™ã‚‹é–¢æ•°
        // â˜…å¤‰æ›´ï¼šGoogle ToDoãƒªã‚¹ãƒˆã¸é€ä¿¡ã™ã‚‹é–¢æ•°ï¼ˆè¦ªåˆ‡ãƒãƒ¼ã‚¸ãƒ§ãƒ³ï¼‰
        function addToGoogleTasks(title, dateStr) {
            // åˆéµãŒãªã„å ´åˆã€ã‚¢ãƒ©ãƒ¼ãƒˆã‚’å‡ºã—ã¦æ•™ãˆã‚‹
            if (!googleAccessToken) {
                showToast("âš ï¸ Googleæœªæ¥ç¶šã€‚è¨­å®šã‹ã‚‰å†ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„");
                return;
            }

            const due = dateStr + 'T00:00:00.000Z';

            fetch('https://tasks.googleapis.com/tasks/v1/lists/@default/tasks', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${googleAccessToken}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    title: `[å­¦ç¿’] ${title}`,
                    due: due
                })
            }).then(response => {
                if (response.ok) {
                    showToast("Google ToDoã«ã‚‚è¿½åŠ ã—ã¾ã—ãŸ");
                } else {
                    console.error("Task sync failed", response);
                    showToast("âš ï¸ åŒæœŸã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ");
                }
            });
        } // â˜…ã“ã“ã§åŒºåˆ‡ã‚‹ã®ãŒæ­£è§£ã§ã™ï¼

        // â˜…ä¿®æ­£ç‰ˆï¼šGeminiå‘ã‘ã®æ³¨é‡ˆè¿½åŠ  ï¼† å†ãƒ­ã‚°ã‚¤ãƒ³ãƒ•ãƒ­ãƒ¼ã‚’è¦ªåˆ‡ã«ã—ãŸé–¢æ•°
        async function exportToGoogleSheets() {
            // ãƒˆãƒ¼ã‚¯ãƒ³ãƒã‚§ãƒƒã‚¯ï¼ˆæœŸé™åˆ‡ã‚Œå¯¾å¿œï¼‰
            if (!googleAccessToken) {
                // Googleæœªæ¥ç¶šã®å ´åˆã€ãƒ­ã‚°ã‚¤ãƒ³å¾Œã«è‡ªå‹•ã§ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã‚’å†å®Ÿè¡Œ
                showToast("Googleã«æ¥ç¶šä¸­...");
                performGoogleLogin(() => {
                    showToast("ãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸï¼ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã‚’é–‹å§‹ã—ã¾ã™...");
                    exportToGoogleSheets();
                });
                return;
            }

            showToast("ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‚’æ›´æ–°ä¸­...");

            try {
                let spreadsheetId = appData.geminiSpreadsheetId;
                let isNewSheet = false;

                // 1. ã‚·ãƒ¼ãƒˆã®å­˜åœ¨ç¢ºèª
                if (spreadsheetId) {
                    const checkRes = await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${spreadsheetId}`, {
                        method: 'GET',
                        headers: { 'Authorization': `Bearer ${googleAccessToken}` }
                    });
                    if (!checkRes.ok) {
                        console.log("å‰å›ã®ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚æ–°è¦ä½œæˆã—ã¾ã™ã€‚");
                        spreadsheetId = null; // ãƒªã‚»ãƒƒãƒˆ
                    }
                }

                // 2. æ–°è¦ä½œæˆ (IDãŒãªã„å ´åˆ)
                if (!spreadsheetId) {
                    showToast("æ–°ã—ã„ã‚·ãƒ¼ãƒˆã‚’ä½œæˆä¸­...");
                    const createRes = await fetch('https://sheets.googleapis.com/v4/spreadsheets', {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${googleAccessToken}`, 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            properties: { title: `å­¦ç¿’ç®¡ç†ãƒ‡ãƒ¼ã‚¿ (Geminié€£æºç”¨)` },
                            sheets: [
                                { properties: { title: 'ã‚µãƒãƒªãƒ¼(é€²æ—)', gridProperties: { frozenRowCount: 1 } } },
                                { properties: { title: 'å…¨å˜å…ƒãƒªã‚¹ãƒˆ', gridProperties: { frozenRowCount: 1 } } },
                                { properties: { title: 'æ—¥æ¬¡æ¨ç§»(Daily)', gridProperties: { frozenRowCount: 1 } } },
                                { properties: { title: 'ãƒãƒ£ãƒ¬ãƒ³ã‚¸è¨˜éŒ²', gridProperties: { frozenRowCount: 1 } } },
                                { properties: { title: 'ç”Ÿæ´»ãƒªã‚ºãƒ ', gridProperties: { frozenRowCount: 1 } } },
                                { properties: { title: 'å‹‰å¼·æ™‚é–“', gridProperties: { frozenRowCount: 1 } } } // â˜…è¿½åŠ 
                            ]
                        })
                    });

                    if (!createRes.ok) throw new Error("ã‚·ãƒ¼ãƒˆä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ");

                    const sheetData = await createRes.json();
                    spreadsheetId = sheetData.spreadsheetId;
                    appData.geminiSpreadsheetId = spreadsheetId;
                    saveData();
                    isNewSheet = true;
                }

                // 3. ãƒ‡ãƒ¼ã‚¿ã®æº–å‚™
                const today = getToday();

                // (A) ã‚µãƒãƒªãƒ¼
                const summaryRows = [['ç§‘ç›®å', 'é€²æ—ç‡(%)', 'å®Œäº†æ•°', 'å…¨å˜å…ƒæ•°', 'é–‹å§‹æ—¥', 'çµŒéæ—¥æ•°', 'å¹³å‡ãƒšãƒ¼ã‚¹(å˜å…ƒ/æ—¥)', 'å®Œäº†äºˆæ¸¬æ—¥', 'çŠ¶æ…‹']];
                Object.values(appData.subjects).forEach(s => {
                    if (s.type === 'study') {
                        const total = s.syllabus ? s.syllabus.length : 0;
                        const done = s.syllabus ? s.syllabus.filter(u => u.status === 'completed').length : 0;
                        const progress = total > 0 ? Math.round((done / total) * 100) : 0;
                        const startDate = s.startDate ? new Date(s.startDate) : new Date();
                        const elapsed = Math.max(1, Math.floor((today - startDate) / 86400000));
                        const pace = (done / elapsed).toFixed(2);
                        let estDate = '-';
                        if (done > 0 && total > done) {
                            const remaining = total - done;
                            const daysNeeded = Math.ceil(remaining / (done / elapsed));
                            const d = new Date(today);
                            d.setDate(d.getDate() + daysNeeded);
                            estDate = formatDate(d);
                        } else if (total > 0 && total === done) estDate = 'å®Œäº†æ¸ˆ';

                        summaryRows.push([
                            s.name, progress, done, total,
                            s.startDate || '-', elapsed, pace, estDate,
                            s.isActive ? 'å­¦ç¿’ä¸­' : 'åœæ­¢ä¸­'
                        ]);
                    }
                });

                // (B) å…¨å˜å…ƒãƒªã‚¹ãƒˆ
                const detailRows = [['ç§‘ç›®', 'ã‚«ãƒ†ã‚´ãƒª', 'å˜å…ƒå', 'çŠ¶æ…‹', 'å®Œäº†æ—¥', 'è‹¦æ‰‹ãƒ•ãƒ©ã‚°', 'å‘¨å›æ•°', 'ãƒ¡ãƒ¢']];
                Object.values(appData.subjects).forEach(s => {
                    if (s.type === 'study' && s.syllabus) {
                        s.syllabus.forEach(u => {
                            detailRows.push([
                                s.name, u.category, u.title,
                                u.status === 'completed' ? 'å®Œäº†' : 'æœªå®Œäº†',
                                u.completedDate === 'initial' ? 'æ—¢é‚' : (u.completedDate || ''),
                                u.isWeak ? 'è‹¦æ‰‹' : '',
                                u.lapCount || 0,
                                u.memo || ''
                            ]);
                        });
                    }
                });

                // (C) æ—¥æ¬¡æ¨ç§» (Daily)
                const historyRows = [['æ—¥ä»˜', 'ç§‘ç›®å', 'é€²æ—ç‡(%)']];
                Object.values(appData.subjects).forEach(s => {
                    if (s.type === 'study' && s.isActive) {
                        let start = s.startDate ? new Date(s.startDate) : null;
                        if (!start && s.history) {
                            const dates = Object.keys(s.history).sort();
                            if (dates.length > 0) start = new Date(dates[0]);
                        }
                        if (!start) start = new Date(today);

                        let cursor = new Date(start);
                        let lastVal = 0;
                        while (cursor <= today) {
                            const dStr = formatDate(cursor);
                            if (s.history && s.history[dStr] !== undefined) lastVal = s.history[dStr];
                            historyRows.push([dStr, s.name, lastVal]);
                            cursor.setDate(cursor.getDate() + 1);
                        }
                    }
                });

                // (D) ãƒãƒ£ãƒ¬ãƒ³ã‚¸è¨˜éŒ²
                const challengeRows = [['æ—¥ä»˜', 'ãƒãƒ£ãƒ¬ãƒ³ã‚¸å', 'é”æˆ', 'æ›œæ—¥', 'ã€å‚™è€ƒ: ã“ã®ã‚·ãƒ¼ãƒˆã«ã¯å®Ÿæ–½ã—ãŸæ—¥ã®ã¿è¨˜éŒ²ã•ã‚Œã¦ã„ã¾ã™ã€‚æ—¥ä»˜ãŒãªã„æ—¥ã¯æœªå®Ÿæ–½ã§ã™ã€‚ã€‘']];
                const weekDays = ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'];
                Object.values(appData.subjects).forEach(s => {
                    if (s.type === 'challenge' && s.challengeHistory) {
                        Object.keys(s.challengeHistory).sort().forEach(date => {
                            const d = new Date(date);
                            challengeRows.push([date, s.name, 'TRUE', weekDays[d.getDay()], '']);
                        });
                    }
                });

                // (Z) ãƒ˜ãƒ«ãƒ‘ãƒ¼: åˆ†ã‚’ã€ŒXæ™‚é–“Yåˆ†ã€ã«å¤‰æ›
                const formatDuration = (m) => {
                    if (m === '' || m === null || isNaN(m)) return '';
                    const hours = Math.floor(m / 60);
                    const mins = m % 60;
                    return `${hours}æ™‚é–“${mins}åˆ†`;
                };

                // (E) ç”Ÿæ´»ãƒªã‚ºãƒ 
                const sleepLogRows = [['æ—¥ä»˜', 'èµ·åºŠæ™‚é–“', 'å°±å¯æ™‚é–“', 'ç¡çœ æ™‚é–“']];
                if (appData.sleepLog) {
                    const sortedDates = Object.keys(appData.sleepLog).sort();
                    sortedDates.forEach(date => {
                        const log = appData.sleepLog[date];
                        let duration = '';
                        // å½“æ—¥ã®èµ·åºŠæ™‚é–“
                        const wake = timeToMinutes(log.wake);

                        // å‰æ—¥ã®å°±å¯æ™‚é–“ã‚’å–å¾—
                        const dObj = new Date(date);
                        dObj.setDate(dObj.getDate() - 1);
                        const prevDate = formatDate(dObj);
                        const prevLog = appData.sleepLog[prevDate];

                        if (wake !== null && wake !== 9999 && prevLog && prevLog.bed && prevLog.bed !== 'allnighter') {
                            const prevBed = timeToMinutes(prevLog.bed, true, prevLog.bedNextDay);
                            if (prevBed !== null && prevBed !== 9999) {
                                // å‰æ—¥å°±å¯ã€œå½“æ—¥èµ·åºŠ
                                duration = (wake + 1440) - prevBed;
                            }
                        }
                        const bedDisplay = log.bed === 'allnighter' ? 'ã‚ªãƒ¼ãƒ«' : (log.bed || '');
                        sleepLogRows.push([date, log.wake || '', bedDisplay, formatDuration(duration)]);
                    });
                }

                // (F) å‹‰å¼·æ™‚é–“
                const studyLogRows = [['æ—¥ä»˜', 'å‹‰å¼·æ™‚é–“']];
                if (appData.studyLog) {
                    Object.keys(appData.studyLog).sort().forEach(date => {
                        const log = appData.studyLog[date];
                        studyLogRows.push([date, formatDuration(log.time)]);
                    });
                }

                // 4. å®Œå…¨ã‚¯ãƒªã‚¢ & æ›¸ãè¾¼ã¿
                if (!isNewSheet) {
                    await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${spreadsheetId}/values:batchClear`, {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${googleAccessToken}`, 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            ranges: [
                                "'ã‚µãƒãƒªãƒ¼(é€²æ—)'!A:Z",
                                "'å…¨å˜å…ƒãƒªã‚¹ãƒˆ'!A:Z",
                                "'æ—¥æ¬¡æ¨ç§»(Daily)'!A:Z",
                                "'ãƒãƒ£ãƒ¬ãƒ³ã‚¸è¨˜éŒ²'!A:Z",
                                "'ç”Ÿæ´»ãƒªã‚ºãƒ '!A:Z",
                                "'å‹‰å¼·æ™‚é–“'!A:Z"
                            ]
                        })
                    });
                }

                const dataBody = [];
                dataBody.push({ range: `'ã‚µãƒãƒªãƒ¼(é€²æ—)'!A1`, values: summaryRows });
                dataBody.push({ range: `'å…¨å˜å…ƒãƒªã‚¹ãƒˆ'!A1`, values: detailRows });
                dataBody.push({ range: `'æ—¥æ¬¡æ¨ç§»(Daily)'!A1`, values: historyRows });
                dataBody.push({ range: `'ãƒãƒ£ãƒ¬ãƒ³ã‚¸è¨˜éŒ²'!A1`, values: challengeRows });
                dataBody.push({ range: `'ç”Ÿæ´»ãƒªã‚ºãƒ '!A1`, values: sleepLogRows });
                dataBody.push({ range: `'å‹‰å¼·æ™‚é–“'!A1`, values: studyLogRows });

                if (dataBody.length > 0) {
                    await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${spreadsheetId}/values:batchUpdate`, {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${googleAccessToken}`, 'Content-Type': 'application/json' },
                        body: JSON.stringify({ valueInputOption: 'USER_ENTERED', data: dataBody })
                    });
                }

                showToast("æ›´æ–°å®Œäº†ï¼ã‚·ãƒ¼ãƒˆã‚’é–‹ãã¾ã™");
                window.open(`https://docs.google.com/spreadsheets/d/${spreadsheetId}`, '_blank');

            } catch (e) {
                console.error(e);
                // ã‚¨ãƒ©ãƒ¼æ™‚ã®å†ãƒ­ã‚°ã‚¤ãƒ³èª˜å°ã‚‚è¦ªåˆ‡ã«ã™ã‚‹
                if (e.message.includes("401") || e.message.includes("auth")) {
                    if (confirm("èªè¨¼ã®æœ‰åŠ¹æœŸé™ãŒåˆ‡ã‚Œã¾ã—ãŸã€‚\nå†ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã‚„ã‚Šç›´ã—ã¾ã™ã‹ï¼Ÿ")) {
                        performGoogleLogin();
                    }
                } else {
                    alert("ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚\nè©³ç´°: " + e.message);
                }
            }
        }

        function saveData() {
            if (currentUserDocId) {
                // ãƒ­ã‚°ã‚¤ãƒ³ä¸­ã¯Firestore(ã‚¯ãƒ©ã‚¦ãƒ‰)ã«ä¿å­˜
                db.collection("study_apps").doc(currentUserDocId).set(JSON.parse(JSON.stringify(appData)))
                    .then(() => console.log("Data saved to cloud"))
                    .catch((error) => console.error("Save error:", error));
            } else {
                // æœªãƒ­ã‚°ã‚¤ãƒ³æ™‚ã¯ãƒ­ãƒ¼ã‚«ãƒ«ä¿å­˜ï¼ˆå¿µã®ãŸã‚ï¼‰
                localStorage.setItem('studyApp_v2_data', JSON.stringify(appData));
            }
        }

        function startListening() {
            if (!currentUserDocId) return;
            db.collection("study_apps").doc(currentUserDocId).onSnapshot((doc) => {
                if (doc.exists) {
                    console.log("Data received from cloud");
                    const cloudData = doc.data();
                    appData = migrateData(cloudData);
                    appData.debugDate = null;
                    initTicker(); // ãƒ‡ãƒ¼ã‚¿ãƒ­ãƒ¼ãƒ‰å¾Œã«ãƒ†ã‚£ãƒƒã‚«ãƒ¼é–‹å§‹
                    recordHistory();
                    updateUI();
                } else {
                    console.log("No data found, initializing...");
                    saveData();
                }
            }, (error) => {
                console.error("Sync error:", error);
                if (error.code === 'permission-denied') {
                    alert("ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“ã€‚");
                }
            });
        }

        function migrateData(data) {
            if (!data.subjects) return data;
            Object.values(data.subjects).forEach(subj => {
                if (subj.isActive === undefined) subj.isActive = true;
                if (!subj.type) subj.type = 'study';
                if (!subj.history) subj.history = {};
                if (subj.type === 'challenge' && !subj.challengeHistory) subj.challengeHistory = {};
                if (!subj.difficultyLabels) subj.difficultyLabels = { A: 'A', B: 'B', C: 'C' };
                if (!subj.difficultyOrder) subj.difficultyOrder = Object.keys(subj.difficultyLabels); // â˜…è¿½åŠ ï¼šä¸¦ã³é †é…åˆ—
                if (!subj.difficultyFilter) subj.difficultyFilter = Object.keys(subj.difficultyLabels);
            });
            if (!data.ticker) data.ticker = JSON.parse(JSON.stringify(defaultTicker));
            if (data.ticker.isEnabled === undefined) data.ticker.isEnabled = true;
            if (!data.sleepLog) data.sleepLog = {};
            return data;
        }

        // â˜… é›£æ˜“åº¦ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
        function getDifficultyLabels(subjId) {
            const subj = appData.subjects[subjId];
            return subj?.difficultyLabels || { A: 'A', B: 'B', C: 'C' };
        }
        function getDifficultyFilter(subjId) {
            const subj = appData.subjects[subjId];
            return subj?.difficultyFilter || Object.keys(getDifficultyLabels(subjId));
        }
        function populateDifficultySelect(selectEl, subjId, currentVal, includeNoChange) {
            selectEl.innerHTML = '';
            if (includeNoChange) {
                const opt = document.createElement('option');
                opt.value = 'no-change';
                opt.textContent = 'å¤‰æ›´ã—ãªã„';
                selectEl.appendChild(opt);
            }
            // const noneOpt = document.createElement('option'); noneOpt.value = ''; noneOpt.textContent = 'ï¼ˆãªã—ï¼‰'; selectEl.appendChild(noneOpt); // å‰Šé™¤
            const labels = getDifficultyLabels(subjId);
            const subj = appData.subjects[subjId];
            const order = (subj && subj.difficultyOrder) ? subj.difficultyOrder : Object.keys(labels);

            order.forEach(key => {
                // ãƒ©ãƒ™ãƒ«ãŒå­˜åœ¨ã™ã‚‹å ´åˆã®ã¿è¡¨ç¤ºï¼ˆå‰Šé™¤ã•ã‚ŒãŸã‚¿ã‚°å¯¾ç­–ï¼‰
                if (labels[key]) {
                    const label = labels[key] || key;
                    const opt = document.createElement('option');
                    opt.value = key;
                    opt.textContent = label;
                    if (key === currentVal) opt.selected = true;
                    selectEl.appendChild(opt);
                }
            });
        }
        function isUnitInFilter(unit, subjId) {
            const filter = getDifficultyFilter(subjId);
            const tags = Array.isArray(unit.difficulty) ? unit.difficulty : (unit.difficulty ? [unit.difficulty] : []);
            if (tags.length === 0) return true; // ã‚¿ã‚°ãªã—ã¯å¸¸ã«å«ã‚ã‚‹
            return tags.some(t => filter.includes(t));
        }

        function renderDifficultyCheckboxes(containerId, subjId, currentTags = []) {
            const container = document.getElementById(containerId);
            if (!container) return;
            container.innerHTML = '';

            // é…åˆ—åŒ–ã¨æ–‡å­—åˆ—äº’æ›
            const current = Array.isArray(currentTags) ? currentTags : (currentTags ? [currentTags] : []);

            const labels = getDifficultyLabels(subjId);
            const subj = appData.subjects[subjId];
            const order = (subj && subj.difficultyOrder) ? subj.difficultyOrder : Object.keys(labels);

            order.forEach(key => {
                // ãƒ©ãƒ™ãƒ«ãŒå­˜åœ¨ã™ã‚‹ã‚‚ã®ã®ã¿è¡¨ç¤º
                if (!labels[key]) return;

                const label = labels[key] || key;
                const labelEl = document.createElement('label');
                labelEl.className = 'flex items-center gap-1 cursor-pointer bg-gray-800 px-2 py-1 rounded border border-gray-700 hover:border-gray-500 select-none';

                const input = document.createElement('input');
                input.type = 'checkbox';
                input.value = key;
                input.checked = current.includes(key);
                input.className = 'accent-app-accent';
                if (containerId === 'bulk-edit-difficulty-checks') input.dataset.bulkDiff = 'true';

                const span = document.createElement('span');
                span.className = 'text-[10px] text-gray-300';
                span.textContent = label; // ãƒ©ãƒ™ãƒ«ã®ã¿è¡¨ç¤º

                labelEl.appendChild(input);
                labelEl.appendChild(span);
                container.appendChild(labelEl);
            });

            if (Object.keys(labels).length === 0) {
                container.innerHTML = '<span class="text-[10px] text-gray-500">ã‚¿ã‚°è¨­å®šãªã—</span>';
            }
        }

        function recordHistory() {
            const dateStr = getTodayStr();
            Object.values(appData.subjects).forEach(subj => {
                if (subj.type === 'study') {
                    if (!subj.history) subj.history = {};
                    const total = subj.syllabus ? subj.syllabus.length : 0;
                    if (total === 0) return;
                    const completed = subj.syllabus.filter(i => i.status === 'completed').length;
                    subj.history[dateStr] = Math.round((completed / total) * 100);
                }
            });
            saveData();
        }

        function getProgressAt(s, d) {
            if (!s || !s.history) return 0;
            if (s.history[d] !== undefined) return s.history[d];
            const sorted = Object.keys(s.history).sort();
            let last = null;
            for (const x of sorted) { if (x <= d) last = x; else break; }
            return last ? s.history[last] : 0;
        }

        function calculateLeastSquares(points) {
            const n = points.length; if (n < 2) return null;
            let sx = 0, sy = 0, sxy = 0, sx2 = 0;
            for (const p of points) { sx += p.x; sy += p.y; sxy += p.x * p.y; sx2 += p.x * p.x; }
            const slope = (n * sxy - sx * sy) / (n * sx2 - sx * sx);
            const intercept = (sy - slope * sx) / n;
            return { slope, intercept };
        }

        function calculateChallengeStats(subj) {
            const start = subj.startDate ? new Date(subj.startDate) : getToday();
            const today = getToday();
            const totalDays = Math.max(1, Math.floor((today - start) / 86400000) + 1);
            let currentStreak = 0; let streakBroken = false;
            for (let i = 0; i < totalDays; i++) {
                const d = new Date(today); d.setDate(d.getDate() - i); const dStr = formatDate(d);
                if (subj.challengeHistory[dStr]) { if (!streakBroken) currentStreak++; } else { if (i > 0) streakBroken = true; }
            }
            let doneDays = 0; for (let k in subj.challengeHistory) { if (subj.challengeHistory[k] && new Date(k) >= start && new Date(k) <= today) doneDays++; }
            return { totalDays, doneDays, currentStreak, percentage: Math.round((doneDays / totalDays) * 100) };
        }

        function getStreakMessage(streak) {
            if (streak === 0) return "ä»Šæ—¥ã‹ã‚‰ã‚¹ã‚¿ãƒ¼ãƒˆï¼";
            if (streak < 3) return "ã„ã„èª¿å­ï¼";
            if (streak < 7) return "ä¸‰æ—¥åŠä¸»è„±å‡ºï¼";
            if (streak < 14) return "ç¿’æ…£åŒ–ã®å…†ã—ï¼";
            if (streak < 30) return "ç¶™ç¶šã®é”äººï¼";
            return "ãƒ¬ã‚¸ã‚§ãƒ³ãƒ‰ç´šï¼";
        }

        // =========================================================
        // --- Ticker Logic ---
        // =========================================================
        function initTicker() {
            updateTickerVisibility();
            if (tickerInterval) clearInterval(tickerInterval);
            tickerInterval = null;

            if (!appData.ticker.isEnabled) return;

            const wrappers = document.querySelectorAll('.ticker-wrapper');

            if (appData.ticker.isPaused) {
                wrappers.forEach(wrapper => {
                    wrapper.innerHTML = '<div class="ticker-item text-xs text-gray-500">Loading...</div>';
                });
            } else {
                renderTicker(); // First render
                tickerInterval = setInterval(updateTicker, 10000);
            }
            updateTickerPauseBtn();
        }

        function updateTickerVisibility() {
            const box = document.getElementById('header-ticker-box');
            if (!box) return;
            if (appData.ticker.isEnabled) {
                box.classList.add('sm:block');
            } else {
                box.classList.remove('sm:block');
            }
            if (!box.classList.contains('hidden')) box.classList.add('hidden');
        }

        function updateTicker() {
            if (appData.ticker.isPaused) return;

            const wrappers = document.querySelectorAll('.ticker-wrapper');
            if (wrappers.length === 0) return;

            const nextMsg = getWeightedRandomMessage();

            wrappers.forEach(wrapper => {
                if (!nextMsg) {
                    wrapper.innerHTML = '<div class="ticker-item text-xs text-gray-500">ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒã‚ã‚Šã¾ã›ã‚“</div>';
                    return;
                }

                // æ—¢å­˜ã®è¦ç´ ã‚’ã™ã¹ã¦å–å¾—
                const oldItems = Array.from(wrapper.children);

                // æ¬¡ã®è¦ç´ ã‚’ä½œæˆ
                const nextEl = document.createElement('div');
                nextEl.className = 'ticker-item ticker-slide-enter';

                const cat = appData.ticker.categories.find(c => c.id === nextMsg.categoryId);
                const colorClass = cat ? cat.color : 'text-gray-400';
                const catName = cat ? cat.name : '';

                nextEl.innerHTML = `
                    <span class="ticker-category-badge ${colorClass}">${escapeHtml(catName)}</span>
                    <span class="text-xs text-gray-200 truncate">${escapeHtml(nextMsg.text)}</span>
                `;

                wrapper.appendChild(nextEl);

                // å¤ã„è¦ç´ ã‚’é€€å ´ã•ã›ã‚‹
                oldItems.forEach(el => {
                    el.classList.remove('ticker-slide-enter');
                    el.classList.add('ticker-slide-exit');
                    setTimeout(() => { if (el.parentNode) el.remove(); }, 480);
                });
            });
        }

        function renderTicker() {
            // å¼·åˆ¶çš„ã«æ›´æ–°ã‚’ã‹ã‘ã‚‹ï¼ˆåˆæœŸè¡¨ç¤ºç”¨ï¼‰
            updateTicker();
        }

        function forceNextTicker() {
            // ç„¡åŠ¹åŒ–ä¸­ã‚„ä¸€æ™‚åœæ­¢ä¸­ã¯ã‚¯ãƒªãƒƒã‚¯ã—ã¦ã‚‚é€²ã¾ãªã„ã‚ˆã†ã«ã™ã‚‹
            if (!appData.ticker.isEnabled || appData.ticker.isPaused) return;

            updateTicker();
            clearInterval(tickerInterval);
            tickerInterval = setInterval(updateTicker, 10000);
        }

        function toggleTickerEnabled() {
            const isEnabled = document.getElementById('ticker-enabled-toggle').checked;
            appData.ticker.isEnabled = isEnabled;
            saveData();
            initTicker();
        }

        function toggleTickerPause(e) {
            if (e) e.stopPropagation();
            appData.ticker.isPaused = !appData.ticker.isPaused;
            saveData();
            initTicker();
        }

        function updateTickerPauseBtn() {
            const btns = document.querySelectorAll('.ticker-pause-btn');
            btns.forEach(btn => {
                btn.innerHTML = appData.ticker.isPaused ? '<i class="fas fa-play text-app-accent"></i>' : '<i class="fas fa-pause"></i>';
                btn.style.opacity = appData.ticker.isPaused ? "1" : ""; // åœæ­¢ä¸­ã¯å¸¸ã«è¡¨ç¤º
            });
        }

        function getWeightedRandomMessage() {
            const ticker = appData.ticker;
            if (!ticker || !ticker.messages || ticker.messages.length === 0) return null;

            // ã‚«ãƒ†ã‚´ãƒªã”ã¨ã®é‡ã¿ãƒãƒƒãƒ—ä½œæˆ
            const defaultWeight = 1;
            const weightedMessages = ticker.messages.map(msg => {
                const cat = ticker.categories.find(c => c.id === msg.categoryId);
                const weight = cat ? (parseInt(cat.weight) || 1) : defaultWeight;
                return { msg, weight };
            });

            const sum = weightedMessages.reduce((acc, item) => acc + item.weight, 0);
            let r = Math.random() * sum;

            for (const item of weightedMessages) {
                if (r < item.weight) return item.msg;
                r -= item.weight;
            }
            return weightedMessages[0].msg;
        }


        function addNewTickerCategory() {
            const id = 'cat_' + Date.now();
            const newCat = { id: id, name: 'æ–°è¦ã‚«ãƒ†ã‚´ãƒª', color: 'text-gray-400', weight: 10 };
            appData.ticker.categories.push(newCat);
            saveData();
            renderTickerSettings();
            openTickerCategoryEditor(id);
        }

        function deleteTickerCategory(catId) {
            const category = appData.ticker.categories.find(c => c.id === catId);
            if (!category) return;
            showAppConfirm("ã‚«ãƒ†ã‚´ãƒªã®å‰Šé™¤", `ã‚«ãƒ†ã‚´ãƒªã€Œ${category.name}ã€ã¨ã€ç´ã¥ããƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¨ã¦å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`, () => {
                appData.ticker.categories = appData.ticker.categories.filter(c => c.id !== catId);
                appData.ticker.messages = appData.ticker.messages.filter(m => m.categoryId !== catId);
                saveData();
                renderTickerSettings();
                initTicker();
                showToast("å‰Šé™¤ã—ã¾ã—ãŸ");
            });
        }

        function openBulkWeightEditor() {
            const list = document.getElementById('bulk-weight-list');
            list.innerHTML = '';
            appData.ticker.categories.forEach(cat => {
                const div = document.createElement('div');
                div.innerHTML = `
                    <label class="text-[10px] text-gray-400 block mb-1">${escapeHtml(cat.name)}: <span class="font-bold text-white" id="bulk-weight-value-${cat.id}">${cat.weight}</span></label>
                    <input type="range" id="bulk-weight-slider-${cat.id}" min="1" max="20" value="${cat.weight}" class="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer">
                `;
                list.appendChild(div);
                const slider = document.getElementById(`bulk-weight-slider-${cat.id}`);
                const valueLabel = document.getElementById(`bulk-weight-value-${cat.id}`);
                slider.oninput = () => {
                    valueLabel.textContent = slider.value;
                };
            });
            document.getElementById('ticker-bulk-weight-editor').classList.remove('hidden');
        }

        function closeBulkWeightEditor() {
            document.getElementById('ticker-bulk-weight-editor').classList.add('hidden');
        }

        function saveBulkWeights() {
            appData.ticker.categories.forEach(cat => {
                const slider = document.getElementById(`bulk-weight-slider-${cat.id}`);
                if (slider) {
                    cat.weight = parseInt(slider.value);
                }
            });
            saveData();
            renderTickerSettings();
            closeBulkWeightEditor();
            showToast("é‡ã¿ã‚’ä¸€æ‹¬æ›´æ–°ã—ã¾ã—ãŸ");
        }


        // â–¼â–¼â–¼ ä¿®æ­£ç®‡æ‰€ã“ã“ã‹ã‚‰ â–¼â–¼â–¼

        function openTickerCategoryEditor(catId) {
            editingTickerCatId = catId;
            const cat = appData.ticker.categories.find(c => c.id === catId);
            if (!cat) return;

            document.getElementById('edit-ticker-cat-name').value = cat.name;

            const colorValueInput = document.getElementById('edit-ticker-cat-color-value');
            colorValueInput.value = cat.color;

            const palette = document.getElementById('edit-ticker-cat-color-palette');
            palette.innerHTML = '';
            TICKER_COLOR_CLASSES.forEach(colorClass => {
                const swatch = document.createElement('div');
                const bgColor = colorClass.replace('text-', 'bg-');
                swatch.className = `w-full h-8 rounded cursor-pointer border-2 ${bgColor} transition-all`;
                swatch.dataset.colorClass = colorClass;

                if (cat.color === colorClass) {
                    swatch.classList.add('border-white', 'ring-2', 'ring-offset-2', 'ring-offset-app-panel', 'ring-white');
                } else {
                    swatch.classList.add('border-transparent');
                }

                swatch.onclick = () => {
                    colorValueInput.value = colorClass;
                    Array.from(palette.children).forEach(child => {
                        child.classList.remove('border-white', 'ring-2', 'ring-offset-2', 'ring-offset-app-panel', 'ring-white');
                        child.classList.add('border-transparent');
                    });
                    swatch.classList.remove('border-transparent');
                    swatch.classList.add('border-white', 'ring-2', 'ring-offset-2', 'ring-offset-app-panel', 'ring-white');
                };
                palette.appendChild(swatch);
            });

            const weightSlider = document.getElementById('edit-ticker-cat-weight');
            const weightValue = document.getElementById('edit-ticker-cat-weight-value');
            weightSlider.value = cat.weight;
            weightValue.textContent = cat.weight;
            weightSlider.oninput = () => {
                weightValue.textContent = weightSlider.value;
            };

            renderEditorTickerMessages();
            document.getElementById('ticker-category-editor').classList.remove('hidden');
        }

        function closeTickerCategoryEditor() {
            document.getElementById('ticker-category-editor').classList.add('hidden');
            editingTickerCatId = null;
        }

        function saveTickerCategoryInfo() {
            const cat = appData.ticker.categories.find(c => c.id === editingTickerCatId);
            if (cat) {
                cat.name = document.getElementById('edit-ticker-cat-name').value.trim() || 'åç§°æœªè¨­å®š';
                cat.color = document.getElementById('edit-ticker-cat-color-value').value;
                cat.weight = parseInt(document.getElementById('edit-ticker-cat-weight').value) || 10;
                saveData();
                renderTickerSettings();
                initTicker();
                showToast("ã‚«ãƒ†ã‚´ãƒªè¨­å®šã‚’æ›´æ–°ã—ã¾ã—ãŸ");
                closeTickerCategoryEditor();
            }
        }

        function renderEditorTickerMessages() {
            const list = document.getElementById('editor-ticker-msg-list');
            list.innerHTML = '';

            const targetMsgs = appData.ticker.messages
                .map((msg, index) => ({ msg, index }))
                .filter(item => item.msg.categoryId === editingTickerCatId);

            if (targetMsgs.length === 0) {
                list.innerHTML = '<div class="text-xs text-gray-500 text-center py-4">ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒã‚ã‚Šã¾ã›ã‚“</div>';
            } else {
                targetMsgs.forEach(item => {
                    const div = document.createElement('div');
                    div.className = "flex justify-between items-center border-b border-gray-800 py-2 last:border-0 group";
                    div.innerHTML = `
                        <span class="text-xs text-gray-300 flex-1 mr-2 break-all">${escapeHtml(item.msg.text)}</span>
                        <button onclick="deleteTickerMessageInEditor(${item.index})" class="text-gray-500 hover:text-red-400 px-2"><i class="fas fa-trash"></i></button>
                    `;
                    list.appendChild(div);
                });
            }
        }

        function addTickerMessageInEditor() {
            const input = document.getElementById('new-ticker-msg-input');
            const text = input.value.trim();
            if (!text) return;

            appData.ticker.messages.push({ categoryId: editingTickerCatId, text: text });
            saveData();
            input.value = '';
            renderEditorTickerMessages();
            renderTickerSettings(); // ä»¶æ•°æ›´æ–°ã®ãŸã‚
            initTicker();
        }

        function deleteTickerMessageInEditor(index) {
            const message = appData.ticker.messages[index];
            if (!message) return;
            showAppConfirm("ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®å‰Šé™¤", `ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã€Œ${message.text}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`, () => {
                appData.ticker.messages.splice(index, 1);
                saveData();
                renderEditorTickerMessages();
                renderTickerSettings();
                showToast("ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å‰Šé™¤ã—ã¾ã—ãŸ");
            });
        }

        // â˜…è¿½åŠ : æœªå®šç¾©ã ã£ãŸé–¢æ•°ã‚’å®Ÿè£…
        function renderTickerSettings() {
            const list = document.getElementById('ticker-category-list');
            if (!list) return;
            list.innerHTML = '';

            const tickerEnabledToggle = document.getElementById('ticker-enabled-toggle');
            if (tickerEnabledToggle) {
                tickerEnabledToggle.checked = !!appData.ticker.isEnabled;
            }

            const categories = appData.ticker.categories || [];

            if (categories.length === 0) {
                list.innerHTML = '<div class="text-xs text-gray-500 text-center py-2">ã‚«ãƒ†ã‚´ãƒªãŒã‚ã‚Šã¾ã›ã‚“</div>';
            } else {
                categories.forEach(cat => {
                    const div = document.createElement('div');
                    div.className = "flex justify-between items-center bg-gray-800 p-2 rounded border border-gray-700 mb-2";
                    div.innerHTML = `
                        <div class="flex items-center gap-2 overflow-hidden">
                            <span class="text-[10px] px-1.5 py-0.5 rounded border border-current font-bold ${cat.color}">${escapeHtml(cat.name)}</span>
                            <span class="text-[9px] text-gray-500 shrink-0">é‡ã¿:${cat.weight}</span>
                        </div>
                        <div class="flex gap-1 shrink-0">
                            <button onclick="openTickerCategoryEditor('${cat.id}')" class="text-gray-400 hover:text-white px-2 py-1"><i class="fas fa-pen"></i></button>
                            <button onclick="deleteTickerCategory('${cat.id}')" class="text-gray-400 hover:text-red-400 px-2 py-1"><i class="fas fa-trash"></i></button>
                        </div>
                    `;
                    list.appendChild(div);
                });
            }

            // å…¨ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æ•°ã®æ›´æ–°
            const msgCountEl = document.getElementById('ticker-msg-count');
            if (msgCountEl) {
                msgCountEl.textContent = (appData.ticker.messages || []).length;
            }
        }

        // â–²â–²â–² ä¿®æ­£ç®‡æ‰€ã“ã“ã¾ã§ â–²â–²â–²


        function copyTickerPrompt() {
            const text = `å­¦ç¿’ç®¡ç†ã‚¢ãƒ—ãƒªã®ãƒ‹ãƒ¥ãƒ¼ã‚¹ãƒ†ã‚£ãƒƒã‚«ãƒ¼ç”¨ãƒ‡ãƒ¼ã‚¿ã‚’JSONå½¢å¼ã§ä½œæˆã—ã¦ãã ã•ã„ã€‚\n\nå½¢å¼:\n{\n  "categories": [\n    {"id": "tips", "name": "å­¦ç¿’ã®ã‚³ãƒ„", "color": "text-blue-400", "weight": 10},\n    {"id": "quote", "name": "å‰äººã®åè¨€", "color": "text-yellow-400", "weight": 5}\n  ],\n  "messages": [\n    {"categoryId": "tips", "text": "ãƒãƒ¢ãƒ‰ãƒ¼ãƒ­ãƒ†ã‚¯ãƒ‹ãƒƒã‚¯ã‚’ä½¿ã£ã¦ã¿ã‚ˆã†"},\n    {"categoryId": "quote", "text": "å¤©æ‰ã¨ã¯1%ã®ã²ã‚‰ã‚ãã¨99%ã®åŠªåŠ›ã§ã‚ã‚‹"}\n  ]\n}\n\næ¡ä»¶:\n- å­¦ç¿’ã®ãƒ¢ãƒãƒ™ãƒ¼ã‚·ãƒ§ãƒ³ãŒä¸ŠãŒã‚‹å†…å®¹\n- çŸ­ãç°¡æ½”ã«(30æ–‡å­—ä»¥å†…)\n- åˆè¨ˆ20ä»¶ç¨‹åº¦`;
            copyTextToClipboard(text);
            showToast("ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ");
        }


        // --- 4. Render Logic (Renders UI parts) ---
        function updateHeaderDate() {
            const d = getToday(); const days = ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'];
            document.getElementById('header-date-display').textContent = `${d.getMonth() + 1}/${d.getDate()}(${days[d.getDay()]})`;

            // â˜…è¿½åŠ ï¼šãƒãƒ¼ã‚¸ãƒ§ãƒ³æƒ…å ±ã‚’è¨­å®šç”»é¢ã«åæ˜ 
            const versionEl = document.getElementById('app-version-display');
            if (versionEl) versionEl.textContent = APP_VERSION;
        }

        function updateExamDaysDisplay() {
            const today = getToday();
            if (appData.currentSubjectId === ALL_SUBJECTS_ID) {
                let minDiff = Infinity; let found = false;
                getActiveSubjects().forEach(s => { if (s.examDate) { const d = Math.ceil((new Date(s.examDate) - today) / 86400000); if (d >= 0 && d < minDiff) { minDiff = d; found = true; } } });
                const text = found ? `ç›®æ¨™ã¾ã§ ${minDiff} æ—¥` : 'ç›®æ¨™æ—¥æœªè¨­å®š';
                document.getElementById('exam-days-left').textContent = text; document.getElementById('exam-days-left-mobile').textContent = text;
            } else {
                const subj = appData.subjects[appData.currentSubjectId];
                if (!subj || !subj.examDate) {
                    const text = "ç›®æ¨™æ—¥æœªè¨­å®š";
                    document.getElementById('exam-days-left').textContent = text; document.getElementById('exam-days-left-mobile').textContent = text;
                } else {
                    const diff = Math.ceil((new Date(subj.examDate) - today) / 86400000);
                    const text = diff >= 0 ? `ç›®æ¨™ã¾ã§ ${diff} æ—¥` : `ç›®æ¨™ã‹ã‚‰ ${Math.abs(diff)} æ—¥çµŒé`;
                    document.getElementById('exam-days-left').textContent = text; document.getElementById('exam-days-left-mobile').textContent = text;
                }
            }
        }

        function refreshSubjectSelectUI() {
            const sel = document.getElementById('subject-select'); sel.innerHTML = '';
            const allOpt = document.createElement('option'); allOpt.value = ALL_SUBJECTS_ID; allOpt.textContent = 'ç·åˆ (å­¦ç¿’ç§‘ç›®)'; sel.appendChild(allOpt);
            const studyGroup = document.createElement('optgroup'); studyGroup.label = "å­¦ç¿’ä¸­";
            const challengeGroup = document.createElement('optgroup'); challengeGroup.label = "ç¶™ç¶šãƒãƒ£ãƒ¬ãƒ³ã‚¸";
            const inactiveGroup = document.createElement('optgroup'); inactiveGroup.label = "æœªå­¦ç¿’";
            Object.values(appData.subjects).forEach(subj => {
                const opt = document.createElement('option'); opt.value = subj.id; opt.textContent = subj.name;
                if (!subj.isActive) inactiveGroup.appendChild(opt);
                else if (subj.type === 'challenge') challengeGroup.appendChild(opt);
                else studyGroup.appendChild(opt);
            });
            if (studyGroup.children.length) sel.appendChild(studyGroup);
            if (challengeGroup.children.length) sel.appendChild(challengeGroup);
            if (inactiveGroup.children.length) sel.appendChild(inactiveGroup);
            if (appData.currentSubjectId !== ALL_SUBJECTS_ID && !appData.subjects[appData.currentSubjectId]) appData.currentSubjectId = ALL_SUBJECTS_ID;
            sel.value = appData.currentSubjectId;
            sel.onchange = (e) => { appData.currentSubjectId = e.target.value; saveData(); updateUI(); };
        }

        function getCurrentSyllabus() {
            if (appData.currentSubjectId === ALL_SUBJECTS_ID) return getActiveSubjects().flatMap(subj => (subj.syllabus || []).map(item => ({ ...item, _subjectId: subj.id, _subjectName: subj.name })));
            return appData.subjects[appData.currentSubjectId]?.syllabus || [];
        }
        // â˜…ä¿®æ­£ç‰ˆï¼šç¸¦é•·åŒ–ã€ç™½ç·šåŒºåˆ‡ã‚Šã€å˜å…ƒåä¸­å¤®æƒãˆã€æ–‡å­—éš ã‚Œé˜²æ­¢
        // â˜…ä¿®æ­£ç‰ˆï¼šã‚«ãƒ†ã‚´ãƒªåã®æ–‡å­—æ•°åˆ¶é™ã‚’æ’¤å»ƒã—ãŸå˜å…ƒãƒãƒƒãƒ—æç”»é–¢æ•°
        function renderSlitBar() {
            const labelContainer = document.getElementById('category-labels-container');
            const slitWrapper = document.getElementById('slit-bar-wrapper');
            labelContainer.innerHTML = '';
            slitWrapper.innerHTML = '';

            let syllabus = getCurrentSyllabus();
            // é›£æ˜“åº¦ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼é©ç”¨
            const subjId = appData.currentSubjectId;
            if (subjId !== ALL_SUBJECTS_ID) {
                syllabus = syllabus.filter(u => isUnitInFilter(u, subjId));
            }
            if (syllabus.length === 0) return;

            // ã‚«ãƒ†ã‚´ãƒªãƒ©ãƒ™ãƒ«ç”Ÿæˆ
            const groups = [];
            let currentLabel = null;
            syllabus.forEach(item => {
                const labelKey = appData.currentSubjectId === ALL_SUBJECTS_ID ? item._subjectName : item.category;
                if (currentLabel !== labelKey) { groups.push({ label: labelKey, count: 1 }); currentLabel = labelKey; }
                else groups[groups.length - 1].count++;
            });
            groups.forEach(group => {
                const div = document.createElement('div');
                div.className = 'category-label-top';
                div.style.width = `${(group.count / syllabus.length) * 100}%`;

                // â˜…ä¿®æ­£ï¼š4æ–‡å­—åˆ¶é™(substring)ã‚’å‰Šé™¤ã—ã€ãã®ã¾ã¾è¡¨ç¤º
                div.textContent = group.label || '';

                // å¿µã®ãŸã‚ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—ï¼ˆãƒã‚¦ã‚¹ãƒ›ãƒãƒ¼ã§å…¨æ–‡è¡¨ç¤ºï¼‰ã‚‚è¿½åŠ 
                div.title = group.label || '';

                labelContainer.appendChild(div);
            });

            // ã‚¹ãƒªãƒƒãƒˆç”Ÿæˆ
            syllabus.forEach(item => {
                const slit = document.createElement('div');
                let slitClass = `slit-item ${item.status}`;
                if (item.status === 'completed' && item.isWeak) slitClass += ' weak';
                else if (item.status === 'pending' && item.isWeak) slitClass += ' weak-pending';

                slit.className = slitClass;
                slit.style.flex = "1 1 0%";
                slit.style.display = "flex";
                slit.style.flexDirection = "column";

                // --- 1. å˜å…ƒåã‚¨ãƒªã‚¢ (ä¸Šéƒ¨ãƒ»å¯å¤‰ãƒ»ä¸­å¤®æƒãˆ) ---
                const textArea = document.createElement('div');
                textArea.style.flex = '1 1 auto';
                textArea.style.display = 'flex';
                textArea.style.flexDirection = 'column';
                textArea.style.justifyContent = 'center';
                textArea.style.alignItems = 'center';
                textArea.style.minHeight = '0';
                textArea.style.padding = '4px 0';

                const text = document.createElement('span');
                text.className = 'slit-text';
                text.textContent = item.title;
                text.style.whiteSpace = 'nowrap';

                // ãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚ºè¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯
                const len = item.title.length;
                const availableHeight = 115;
                const defaultFontSize = 9;

                if (len * defaultFontSize > availableHeight) {
                    const newSize = Math.max(4, Math.floor(availableHeight / len));
                    text.style.fontSize = `${newSize}px`;
                    text.style.letterSpacing = '0px';
                } else {
                    text.style.fontSize = `${defaultFontSize}px`;
                    text.style.letterSpacing = '1px';
                }
                textArea.appendChild(text);

                // --- 2. åŒºåˆ‡ã‚Šç·š (ç™½ç·š) ---
                const separator = document.createElement('div');
                separator.style.flex = '0 0 1px';
                separator.style.height = '1px';

                // â˜…ä¿®æ­£ï¼šãƒ©ã‚¤ãƒˆãƒ¢ãƒ¼ãƒ‰ã‹ã¤æœªå®Œäº†(ç™½èƒŒæ™¯)ã®å ´åˆã¯é»’ç³»ã®ç·šã«ã™ã‚‹
                const isLight = document.documentElement.classList.contains('light-mode');
                const isDarkBg = item.status === 'completed' || item.status === 'weak-pending';
                separator.style.backgroundColor = (isLight && !isDarkBg) ? 'rgba(0, 0, 0, 0.1)' : 'rgba(255, 255, 255, 0.25)';
                separator.style.width = '100%';

                // --- 3. ä¸‹éƒ¨å›ºå®šã‚¨ãƒªã‚¢ (è‹¦æ‰‹ + å›æ•°) ---
                const bottomArea = document.createElement('div');
                bottomArea.style.flex = '0 0 auto';
                bottomArea.style.display = 'flex';
                bottomArea.style.flexDirection = 'column';
                bottomArea.style.alignItems = 'center';
                bottomArea.style.padding = '2px 0';

                // 3-1. è‹¦æ‰‹ãƒœã‚¿ãƒ³
                const weakBtn = document.createElement('div');
                weakBtn.className = 'slit-weak-btn';
                weakBtn.style.flex = '0 0 12px';
                weakBtn.style.height = '12px';
                weakBtn.style.fontSize = '9px';
                weakBtn.style.display = 'flex';
                weakBtn.style.alignItems = 'center';
                weakBtn.style.justifyContent = 'center';
                if (item.isWeak) weakBtn.classList.add('active');
                weakBtn.innerHTML = '<i class="fas fa-exclamation-triangle"></i>';
                weakBtn.onclick = (e) => toggleUnitWeakGlobal(item._subjectId || appData.currentSubjectId, item.id, e);

                // 3-2. å‘¨å›æ•°è¡¨ç¤º
                const lapDiv = document.createElement('div');
                lapDiv.style.flex = '0 0 10px';
                lapDiv.style.height = '10px';
                lapDiv.style.fontSize = '9px';
                lapDiv.style.lineHeight = '10px';
                lapDiv.className = 'font-mono text-center w-full';
                const count = item.lapCount || 0;
                lapDiv.textContent = count;
                if (item.status === 'completed') {
                    lapDiv.style.color = 'rgba(0,0,0,0.7)';
                    if (count >= 2) lapDiv.style.fontWeight = 'bold';
                } else {
                    // â˜…ä¿®æ­£ï¼šãƒ©ã‚¤ãƒˆãƒ¢ãƒ¼ãƒ‰ãªã‚‰é»’æ–‡å­—ã€ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰ãªã‚‰ç™½æ–‡å­—
                    lapDiv.style.color = (isLight && item.status !== 'weak-pending') ? 'rgba(0,0,0,0.4)' : 'rgba(255,255,255,0.4)';
                }

                bottomArea.appendChild(weakBtn);
                bottomArea.appendChild(lapDiv);

                slit.appendChild(textArea);
                slit.appendChild(separator);
                slit.appendChild(bottomArea);

                slitWrapper.appendChild(slit);
            });
        }


        // â˜…ä¿®æ­£ç‰ˆï¼šé›£æ˜“åº¦ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼UIæç”»ï¼ˆé…åˆ—ã‚¿ã‚°å¯¾å¿œãƒ»é‡è¤‡æ’é™¤ä¿®æ­£ï¼‰
        function renderDifficultyFilter() {
            const area = document.getElementById('difficulty-filter-area');
            const subjId = appData.currentSubjectId;
            if (subjId === ALL_SUBJECTS_ID || !appData.subjects[subjId] || appData.subjects[subjId].type === 'challenge') {
                area.classList.add('hidden'); return;
            }
            const subj = appData.subjects[subjId];
            const labels = subj.difficultyLabels || {};

            // å®Ÿéš›ã«syllabusã«ä½¿ã‚ã‚Œã¦ã„ã‚‹é›£æ˜“åº¦ã ã‘è¡¨ç¤ºï¼ˆé…åˆ—ã®ä¸­èº«ã‚’å±•é–‹ã—ã¦Setã¸ï¼‰
            const usedDiffs = new Set();
            (subj.syllabus || []).forEach(u => {
                const d = u.difficulty;
                if (d) {
                    if (Array.isArray(d)) d.forEach(val => usedDiffs.add(val));
                    else usedDiffs.add(d);
                }
            });

            if (usedDiffs.size === 0) { area.classList.add('hidden'); return; }

            area.classList.remove('hidden');
            area.innerHTML = '<span class="text-[9px] text-gray-500 mr-1 flex items-center">å¯¾è±¡:</span>';
            const filter = subj.difficultyFilter || Object.keys(labels);
            const order = subj.difficultyOrder || Object.keys(labels);

            // usedDiffsã«å«ã¾ã‚Œã‚‹ã‚‚ã®ã‚’ã€orderé †ã«ã‚½ãƒ¼ãƒˆã—ã¦è¡¨ç¤º
            order.filter(key => usedDiffs.has(key)).forEach(key => {
                const isOn = filter.includes(key);
                const label = labels[key] || key;
                const chip = document.createElement('button');
                // ãƒ‡ã‚¶ã‚¤ãƒ³èª¿æ•´ï¼šä¸¸ã¿ã¨è‰²
                chip.className = `text-[10px] px-2.5 py-1 rounded-full border transition-all flex items-center justify-center min-w-[24px] ${isOn
                    ? 'bg-app-accent text-app-dark border-app-accent font-bold shadow-sm'
                    : 'bg-gray-800 text-gray-400 border-gray-600 hover:border-gray-500'}`;
                chip.textContent = label;
                chip.onclick = () => {
                    if (isOn) {
                        subj.difficultyFilter = filter.filter(f => f !== key);
                    } else {
                        subj.difficultyFilter = [...filter, key];
                    }
                    saveData(); updateUI();
                };
                area.appendChild(chip);
            });
        }

        // â˜…è¿½åŠ ï¼šãƒ›ãƒ¼ãƒ ç”»é¢ã®ã‚«ãƒ†ã‚´ãƒªåˆ¥é€²æ—ãƒãƒ¼æç”»
        function renderCategoryProgress(syllabus) {
            const section = document.getElementById('category-progress-section');
            const container = document.getElementById('category-progress-bars');
            if (!section || !container) return;

            // ã‚«ãƒ†ã‚´ãƒªåˆ¥ã«é›†è¨ˆ
            const catMap = {};
            syllabus.forEach(u => {
                const cat = u.category || 'æœªåˆ†é¡';
                if (!catMap[cat]) catMap[cat] = { total: 0, done: 0 };
                catMap[cat].total++;
                if (u.status === 'completed') catMap[cat].done++;
            });
            const categories = Object.entries(catMap);

            // ã‚«ãƒ†ã‚´ãƒª2å€‹æœªæº€ãªã‚‰éè¡¨ç¤º
            if (categories.length < 2) { section.classList.add('hidden'); return; }
            section.classList.remove('hidden');
            container.innerHTML = '';

            categories.forEach(([name, { total, done }]) => {
                const pct = total > 0 ? Math.round((done / total) * 100) : 0;
                const isAllDone = pct === 100;
                const row = document.createElement('div');
                row.className = 'flex items-center gap-2';
                row.innerHTML = `
                    <span class="text-[10px] ${isAllDone ? 'text-emerald-400 font-bold' : 'text-gray-400'} w-24 truncate shrink-0" title="${name}">${name}</span>
                    <div class="flex-1 h-1.5 bg-gray-700 rounded-full overflow-hidden">
                        <div class="h-full rounded-full transition-all duration-500 ${isAllDone ? 'bg-emerald-400' : 'bg-app-accent'}" style="width:${pct}%"></div>
                    </div>
                    <span class="text-[9px] ${isAllDone ? 'text-emerald-400 font-bold' : 'text-gray-500'} w-12 text-right shrink-0">${isAllDone ? 'âœ“' : ''} ${done}/${total}</span>
                `;
                container.appendChild(row);
            });
        }

        function renderMonthHeatmap(subj) {
            const container = document.getElementById('slit-bar-wrapper'); container.innerHTML = '';
            const labels = document.getElementById('category-labels-container'); labels.innerHTML = '';
            const start = subj.startDate ? new Date(subj.startDate) : getToday();
            const end = subj.examDate ? new Date(subj.examDate) : new Date(start.getFullYear(), start.getMonth() + 5, 1);
            let cursor = new Date(start.getFullYear(), start.getMonth(), 1);
            while (cursor <= end || cursor.getMonth() === end.getMonth()) {
                const year = cursor.getFullYear(); const month = cursor.getMonth();
                const daysInMonth = new Date(year, month + 1, 0).getDate();
                let doneCount = 0;
                for (let d = 1; d <= daysInMonth; d++) { if (subj.challengeHistory[formatDate(new Date(year, month, d))]) doneCount++; }
                const percent = Math.round((doneCount / daysInMonth) * 100);
                const lDiv = document.createElement('div'); lDiv.className = 'category-label-top'; lDiv.style.flex = "1"; lDiv.textContent = `${month + 1}æœˆ`; labels.appendChild(lDiv);
                const bDiv = document.createElement('div'); bDiv.className = 'month-heat-item';
                bDiv.innerHTML = `<div class="month-heat-fill" style="height: ${percent}%; background-color: rgba(251, 191, 36, ${Math.max(0.2, percent / 100)});"></div><span class="month-heat-label">${percent}%</span>`;
                container.appendChild(bDiv);
                cursor.setMonth(cursor.getMonth() + 1);
                if (cursor > end && cursor.getMonth() !== end.getMonth()) break;
            }
        }
        // â˜…è¿½åŠ ï¼šè¨˜éŒ²ç”»é¢ã®ãƒªã‚¹ãƒˆã‚’æç”»ã™ã‚‹é–¢æ•°
        function renderRecordLists() {
            const dateStr = formatDate(currentRecordDate);
            document.getElementById('record-date-display').textContent = dateStr;
            const isToday = dateStr === getTodayStr();
            document.getElementById('record-date-label').textContent = isToday ? "ä»Šæ—¥ã®äºˆå®š" : "äºˆå®šãƒªã‚¹ãƒˆ";

            // ä»Šæ—¥ã®ãƒªã‚¹ãƒˆè¡¨ç¤º
            const todaysList = document.getElementById('todays-list');
            todaysList.innerHTML = '';
            const schedule = appData.schedules[dateStr] || [];
            document.getElementById('record-task-count').textContent = `${schedule.length} å˜å…ƒ`;

            if (schedule.length === 0) {
                todaysList.innerHTML = `<div class="text-xs text-gray-500 text-center py-8">äºˆå®šã¯ã‚ã‚Šã¾ã›ã‚“<br><span class="text-[9px] opacity-70">${isToday ? 'ç®¡ç†ç”»é¢ã‹ã‚‰å˜å…ƒã‚’è¿½åŠ ã—ã¾ã—ã‚‡ã†' : ''}</span></div>`;
            } else {
                // ã‚«ãƒ†ã‚´ãƒªåˆ¥ã«ã‚°ãƒ«ãƒ¼ãƒ—åŒ–
                const groups = {};
                schedule.forEach(task => {
                    const subj = appData.subjects[task.subjectId];
                    if (!subj) return;
                    const unit = subj.syllabus.find(u => u.id === task.unitId);
                    if (!unit) return;
                    const groupKey = unit.category || subj.name || 'æœªåˆ†é¡';
                    if (!groups[groupKey]) groups[groupKey] = [];
                    groups[groupKey].push({ unit, subj, task });
                });
                renderGroupedList(todaysList, groups, true, 'sched');
            }

            // æ®‹ã‚Šã®å˜å…ƒï¼ˆã‚­ãƒ¥ãƒ¼ï¼‰è¡¨ç¤º
            const queueList = document.getElementById('queue-list');
            queueList.innerHTML = '';
            const currentSubj = appData.subjects[appData.currentSubjectId];

            if (appData.currentSubjectId !== ALL_SUBJECTS_ID && currentSubj && currentSubj.type === 'study') {
                document.getElementById('current-subject-name-record').textContent = currentSubj.name;
                const pendingUnits = currentSubj.syllabus.filter(u => u.status === 'pending');
                const todaysUnitIds = schedule.map(s => s.unitId);
                const displayUnits = pendingUnits.filter(u => !todaysUnitIds.includes(u.id));

                if (displayUnits.length === 0) {
                    queueList.innerHTML = '<div class="text-xs text-gray-500 text-center py-4">æœªå®Œäº†ã®å˜å…ƒã¯ã‚ã‚Šã¾ã›ã‚“</div>';
                } else {
                    // ã‚«ãƒ†ã‚´ãƒªåˆ¥ã«ã‚°ãƒ«ãƒ¼ãƒ—åŒ–
                    const groups = {};
                    displayUnits.forEach(unit => {
                        const groupKey = unit.category || 'æœªåˆ†é¡';
                        if (!groups[groupKey]) groups[groupKey] = [];
                        groups[groupKey].push({ unit, subj: currentSubj, task: { subjectId: currentSubj.id } });
                    });
                    renderGroupedList(queueList, groups, false, 'queue');
                }
            } else {
                document.getElementById('current-subject-name-record').textContent = 'ç§‘ç›®ã‚’é¸æŠ';
                queueList.innerHTML = '<div class="text-xs text-gray-500 text-center py-4">ç§‘ç›®ã‚’æŒ‡å®šã™ã‚‹ã¨<br>æœªå®Œäº†ã‚¿ã‚¹ã‚¯ãŒè¡¨ç¤ºã•ã‚Œã¾ã™</div>';
            }

            // ãƒãƒ£ãƒ¬ãƒ³ã‚¸ãƒœã‚¿ãƒ³ã®è¡¨ç¤ºåˆ¶å¾¡
            const challengeArea = document.getElementById('challenge-action-area');
            if (currentSubj && currentSubj.type === 'challenge') {
                challengeArea.classList.remove('hidden');
                const isDone = !!currentSubj.challengeHistory[dateStr];
                const btn = document.getElementById('challenge-toggle-btn');
                const btnText = document.getElementById('challenge-btn-text');
                if (isDone) {
                    btn.className = "w-full py-4 rounded-xl font-bold text-lg shadow-lg bg-app-success text-app-dark flex items-center justify-center gap-2";
                    btnText.textContent = "é”æˆæ¸ˆã¿ï¼";
                    btn.onclick = () => toggleChallengeDate(currentSubj.id, dateStr, false);
                } else {
                    btn.className = "w-full py-4 rounded-xl font-bold text-lg shadow-lg bg-gray-700 text-gray-400 hover:bg-challenge-gold hover:text-app-dark transition-all flex items-center justify-center gap-2";
                    btnText.textContent = "å®Œäº†ã«ã™ã‚‹";
                    btn.onclick = () => toggleChallengeDate(currentSubj.id, dateStr, true);
                }
            } else {
                challengeArea.classList.add('hidden');
            }
        }

        // â˜…è¿½åŠ ï¼šã‚«ãƒ†ã‚´ãƒªåˆ¥ã‚°ãƒ«ãƒ¼ãƒ—ãƒªã‚¹ãƒˆæç”»
        const _collapsedGroups = {};
        function renderGroupedList(container, groups, isScheduled, prefix) {
            Object.entries(groups).forEach(([categoryName, items]) => {
                const key = `${prefix}_${categoryName}`;
                if (typeof _collapsedGroups[key] === 'undefined') _collapsedGroups[key] = false;

                // ã‚«ãƒ†ã‚´ãƒªå†…ã®å®Œäº†æ•°
                const total = items.length;
                const done = items.filter(i => i.unit.status === 'completed').length;
                const pct = total > 0 ? Math.round((done / total) * 100) : 0;
                const isAllDone = pct === 100;

                // ã‚«ãƒ†ã‚´ãƒªãƒ˜ãƒƒãƒ€ãƒ¼
                const header = document.createElement('div');
                header.className = 'flex items-center gap-2 px-3 py-2 cursor-pointer select-none border-b border-gray-700/50 hover:bg-gray-800/30 transition-colors';
                header.innerHTML = `
                    <i class="fas fa-chevron-${_collapsedGroups[key] ? 'right' : 'down'} text-[8px] text-gray-500 w-3"></i>
                    <span class="text-[11px] font-bold ${isAllDone ? 'text-emerald-400' : 'text-gray-300'} flex-1 truncate">${categoryName}</span>
                    <div class="flex items-center gap-2 shrink-0">
                        <div class="w-16 h-1.5 bg-gray-700 rounded-full overflow-hidden">
                            <div class="h-1.5 rounded-full transition-all ${isAllDone ? 'bg-emerald-400' : 'bg-app-accent'}" style="width:${pct}%"></div>
                        </div>
                        <span class="text-[9px] ${isAllDone ? 'text-emerald-400 font-bold' : 'text-gray-500'} w-10 text-right">${done}/${total}</span>
                    </div>
                `;
                header.onclick = () => {
                    _collapsedGroups[key] = !_collapsedGroups[key];
                    renderRecordLists();
                };
                container.appendChild(header);

                // ä¸­èº«ï¼ˆæŠ˜ã‚ŠãŸãŸã¿ä¸­ã¯éè¡¨ç¤ºï¼‰
                if (!_collapsedGroups[key]) {
                    items.forEach(({ unit, subj, task }) => {
                        const row = createTaskRow(unit, isScheduled ? subj.name : null, isScheduled, task);
                        row.style.paddingLeft = '28px'; // ã‚¤ãƒ³ãƒ‡ãƒ³ãƒˆ
                        container.appendChild(row);
                    });
                }
            });
        }

        // â˜…ä¿®æ­£æ¸ˆã¿ï¼šã‚¿ã‚¹ã‚¯è¡Œã‚’ä½œæˆã™ã‚‹é–¢æ•°
        function createTaskRow(item, subjectName, isScheduled, taskData) {
            const row = document.createElement('div');
            row.className = "flex items-center justify-between p-3 border-b border-gray-700/50 hover:bg-gray-800/50 transition-colors group";

            const leftDiv = document.createElement('div');
            leftDiv.className = "flex items-center gap-3 flex-1 min-w-0";

            const checkDiv = document.createElement('div');
            const isCompleted = item.status === 'completed';
            checkDiv.className = `w-8 h-8 rounded-full flex items-center justify-center border cursor-pointer transition-all active:scale-90 ${isCompleted ? 'bg-app-success border-app-success text-app-dark' : 'border-gray-500 text-transparent active:border-app-accent'}`;
            checkDiv.innerHTML = '<i class="fas fa-check text-xs"></i>';
            checkDiv.onclick = (e) => {
                e.stopPropagation();
                toggleStatusGlobal(taskData.subjectId, item.id);
            };
            checkDiv.addEventListener('touchend', (e) => {
                e.preventDefault();
                e.stopPropagation();
                toggleStatusGlobal(taskData.subjectId, item.id);
            });

            const textDiv = document.createElement('div');
            textDiv.className = "flex flex-col truncate";

            const titleDiv = document.createElement('div');
            titleDiv.className = `text-xs font-medium truncate ${isCompleted ? 'text-gray-500 line-through' : 'text-gray-200'}`;
            titleDiv.textContent = item.title;

            const subDiv = document.createElement('div');
            subDiv.className = "text-[9px] text-gray-500 truncate";
            if (subjectName) subDiv.textContent = `[${subjectName}]`;

            textDiv.appendChild(titleDiv);
            textDiv.appendChild(subDiv);
            leftDiv.appendChild(checkDiv);
            leftDiv.appendChild(textDiv);
            row.appendChild(leftDiv);

            if (isScheduled && taskData) {
                const delBtn = document.createElement('button');
                delBtn.className = "text-gray-600 hover:text-red-400 p-2 opacity-0 group-hover:opacity-100 transition-opacity";
                delBtn.innerHTML = '<i class="fas fa-trash-alt"></i>';
                delBtn.onclick = () => {
                    const dateStr = formatDate(currentRecordDate);
                    const list = appData.schedules[dateStr];
                    if (list) {
                        const idx = list.indexOf(taskData);
                        if (idx > -1) removeTaskFromDate(dateStr, idx);
                    }
                };
                row.appendChild(delBtn);
            } else if (!isScheduled) {
                const addBtn = document.createElement('button');
                addBtn.className = "text-app-accent hover:text-white p-2 opacity-0 group-hover:opacity-100 transition-opacity";
                addBtn.innerHTML = '<i class="fas fa-plus-circle"></i>';
                addBtn.onclick = () => {
                    const dateStr = formatDate(currentRecordDate);
                    if (!appData.schedules[dateStr]) appData.schedules[dateStr] = [];
                    appData.schedules[dateStr].push({ subjectId: taskData.subjectId, unitId: item.id });
                    saveData();
                    renderRecordLists();
                };
                row.appendChild(addBtn);
            }

            return row;
        }



        function toggleUnitWeakGlobal(subjectId, unitId, event) {
            if (event) event.stopPropagation();
            const subj = appData.subjects[subjectId];
            const item = subj?.syllabus.find(s => s.id === unitId);
            if (item) {
                item.isWeak = !item.isWeak;
                saveData();
                updateUI();
            }
        }

        // â˜…ä¿®æ­£ç‰ˆï¼šå‘¨å›ã‚«ã‚¦ãƒ³ãƒˆå¯¾å¿œã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹åˆ‡æ›¿é–¢æ•°
        function toggleStatusGlobal(subjectId, unitId) {
            const subj = appData.subjects[subjectId];
            const item = subj?.syllabus.find(s => s.id === unitId);
            if (!item) return;

            if (item.status === 'pending') {
                // [1] æœªå®Œäº† â†’ å®Œäº† (1å‘¨ç›®é”æˆ)
                item.status = 'completed';
                item.lapCount = (item.lapCount || 0) + 1;
                item.completedDate = getTodayStr();
                showToast(`å®Œäº†ï¼ (ç¾åœ¨: ${item.lapCount}å‘¨ç›®)`);
                // syncToGoogleTasks(item.title, true);
            } else {
                // [2] å®Œäº†æ¸ˆã¿ â†’ ã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸå ´åˆ
                // ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’å‡ºã™
                const isLapUp = confirm(`ã€å‘¨å›è¨˜éŒ²ã€‘\nã€Œ${item.title}ã€ã®å‘¨å›æ•°ã‚’å¢—ã‚„ã—ã¾ã™ã‹ï¼Ÿ\n\n[OK] = å‘¨å›æ•°ã‚’å¢—ã‚„ã™ (+1)\n[ã‚­ãƒ£ãƒ³ã‚»ãƒ«] = æœªå®Œäº†ã«æˆ»ã™`);

                if (isLapUp) {
                    // å‘¨å›æ•°ã‚’å¢—ã‚„ã—ã¦ã€å®Œäº†æ—¥ã‚’ä»Šæ—¥ã«æ›´æ–°
                    item.lapCount = (item.lapCount || 1) + 1;
                    item.completedDate = getTodayStr();
                    showToast(`å‘¨å›è¨˜éŒ²ã‚’æ›´æ–°ã—ã¾ã—ãŸ (ç¾åœ¨: ${item.lapCount}å‘¨ç›®)`);
                    // syncToGoogleTasks(item.title, true); // Googleå´ã«ã‚‚å¿µã®ãŸã‚é€šçŸ¥
                } else {
                    // æœªå®Œäº†ã«æˆ»ã™ (Undo)
                    item.status = 'pending';
                    item.completedDate = null;
                    if (item.lapCount > 0) item.lapCount--;
                    showToast("æœªå®Œäº†ã«æˆ»ã—ã¾ã—ãŸ");
                    // syncToGoogleTasks(item.title, false);
                }
            }

            recordHistory();
            updateUI();
        }

        // â˜…ä¿®æ­£ç‰ˆï¼šãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ãŸç¬é–“ã«ç”»é¢ã‚’æ›´æ–°ã—ã¦è‰²ã‚’å¤‰ãˆã‚‹é–¢æ•°
        function toggleChallengeDate(subjId, dateStr, forceState) {
            const subj = appData.subjects[subjId];
            if (!subj) return;

            // ãƒ‡ãƒ¼ã‚¿ã®ä¿å­˜ï¼ˆON/OFFåˆ‡ã‚Šæ›¿ãˆï¼‰
            if (forceState) {
                subj.challengeHistory[dateStr] = true;
            } else {
                delete subj.challengeHistory[dateStr];
            }
            saveData();

            // â˜…é‡è¦ï¼šã“ã“ã§ç¿’æ…£ãƒªã‚¹ãƒˆã‚’å†æç”»ã—ã¦ã€ãƒœã‚¿ãƒ³ã®è‰²ã‚’å³åº§ã«å¤‰ãˆã‚‹
            if (document.getElementById('challenge-screen').classList.contains('active')) {
                renderChallengeScreen();
            }

            // ä»–ã®ç”»é¢ï¼ˆé€²æ—ã‚°ãƒ©ãƒ•ã‚„ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ï¼‰ã‚‚åŒæœŸã•ã›ã‚‹
            // updateUI(); // â€»ã‚‚ã—å‹•ä½œãŒé‡ã„å ´åˆã¯ã“ã®è¡Œã‚’ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆã—ã¦ã‚‚OK

            // ãƒ˜ãƒƒãƒ€ãƒ¼ã®é€£ç¶šæ—¥æ•°è¡¨ç¤ºãªã©ã‚’æ›´æ–°ã™ã‚‹ãŸã‚ã«å¿…è¦
            updateHeaderDate();
            updateExamDaysDisplay();
            // updateUI() ã®ä¸­èº«ã®ä¸€éƒ¨ã‚’æ‰‹å‹•å®Ÿè¡Œã—ã¦è»½é‡åŒ–
            const isChallenge = appData.currentSubjectId !== ALL_SUBJECTS_ID && appData.subjects[appData.currentSubjectId]?.type === 'challenge';
            if (isChallenge) {
                const stats = calculateChallengeStats(subj);
                const streakText = stats.currentStreak === 0 ? getStreakMessage(0) : `${stats.currentStreak}æ—¥é€£ç¶šç¶™ç¶šä¸­ï¼`;
                document.getElementById('streak-count-header').textContent = streakText;
            }
        }

        // â˜…ä¿®æ­£ç‰ˆï¼šç”»é¢ã‚µã‚¤ã‚ºã«åˆã‚ã›ã¦ä¼¸ç¸®ã—ã€è¦‹ã‚„ã™ã•ã‚’å‘ä¸Šã•ã›ãŸã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼æç”»
        function renderCalendar() {
            const grid = document.getElementById('calendar-grid');
            const title = document.getElementById('calendar-title');
            grid.innerHTML = '';

            const year = currentCalendarDate.getFullYear();
            const month = currentCalendarDate.getMonth();
            title.textContent = `${year}å¹´ ${month + 1}æœˆ`;

            const firstDay = new Date(year, month, 1).getDay();
            const lastDate = new Date(year, month + 1, 0).getDate();

            // å‰æœˆã®æ—¥ä»˜åŸ‹ã‚ï¼ˆç©ºç™½ã§ã¯ãªãè–„ã„ã‚°ãƒ¬ãƒ¼ã§è¡¨ç¤ºã™ã‚‹å ´åˆï¼‰
            // ä»Šå›ã¯ã‚·ãƒ³ãƒ—ãƒ«ã«ç©ºç™½ã‚»ãƒ«ã§åŸ‹ã‚ã¾ã™ãŒã€æ ç·šã¯æç”»ã—ã¾ã™
            const totalCells = 42; // 6é€±é–“åˆ†ç¢ºä¿ã—ã¦ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆå´©ã‚Œã‚’é˜²ã

            updateCalendarLegend();

            // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ç”Ÿæˆãƒ«ãƒ¼ãƒ—
            for (let i = 0; i < totalCells; i++) {
                const dayNum = i - firstDay + 1;
                const cell = document.createElement('div');

                // ã‚»ãƒ«ã®åŸºæœ¬ã‚¹ã‚¿ã‚¤ãƒ«ï¼ˆæ ç·šã€ä¼¸ç¸®è¨­å®šï¼‰
                cell.className = "border-b border-r border-gray-700/50 relative p-1 flex flex-col items-center hover:bg-white/5 transition-colors cursor-pointer group min-h-[50px]";

                // å³ç«¯ã®æ ç·šã‚’æ¶ˆã™ï¼ˆè¦ªã®æ ãŒã‚ã‚‹ãŸã‚ï¼‰
                if ((i + 1) % 7 === 0) cell.classList.remove('border-r');
                // æœ€ä¸‹æ®µã®æ ç·šã‚’æ¶ˆã™
                if (i >= 35) cell.classList.remove('border-b');

                if (dayNum > 0 && dayNum <= lastDate) {
                    const dateObj = new Date(year, month, dayNum);
                    const dateStr = formatDate(dateObj);
                    const isToday = dateStr === getTodayStr();

                    // --- æ—¥ä»˜æ•°å­—ã®ãƒ‡ã‚¶ã‚¤ãƒ³ ---
                    const daySpan = document.createElement('span');
                    daySpan.className = `text-sm font-bold w-6 h-6 flex items-center justify-center rounded-full mb-1 z-10 ${isToday
                        ? 'bg-app-accent text-app-dark shadow-lg ring-2 ring-app-accent/30'
                        : 'text-gray-300 group-hover:bg-gray-700'
                        }`;
                    daySpan.textContent = dayNum;
                    cell.appendChild(daySpan);

                    // --- ãƒ‡ãƒ¼ã‚¿ã®åˆ¤å®š ---
                    const currentId = appData.currentSubjectId;
                    const isAll = currentId === ALL_SUBJECTS_ID;
                    const currentSubj = appData.subjects[currentId];
                    const isStudyMode = isAll || (currentSubj && currentSubj.type === 'study');
                    const isChallengeMode = !isAll && (currentSubj && currentSubj.type === 'challenge');

                    let marksContainer = document.createElement('div');
                    marksContainer.className = "flex flex-wrap justify-center gap-0.5 w-full px-1";

                    // 1. ç›®æ¨™æ—¥ãƒ•ãƒ©ã‚°
                    if (isStudyMode) {
                        const subjects = isAll ? getActiveSubjects() : [currentSubj];
                        const examSubjs = subjects.filter(s => s.examDate && formatDate(new Date(s.examDate)) === dateStr);
                        if (examSubjs.length > 0) {
                            const flag = document.createElement('div');
                            flag.className = "absolute top-1 right-1 animate-pulse";
                            flag.innerHTML = examSubjs.map(s => `<i class="fas fa-flag text-[10px] ${getSubjectColor(s.id)} filter drop-shadow"></i>`).join('');
                            cell.appendChild(flag);
                        }
                    }

                    // 2. äºˆå®šãƒ»å®Œäº†ãƒãƒ¼ã‚¯
                    if (isStudyMode) {
                        // äºˆå®šãŒã‚ã‚‹ã‹
                        const hasEvent = (appData.schedules[dateStr] || []).some(t => {
                            const s = appData.subjects[t.subjectId];
                            if (!s || !s.isActive) return false;
                            return isAll ? s.type === 'study' : t.subjectId === currentId;
                        });

                        // å®Œäº†ã—ãŸã‚‚ã®ãŒã‚ã‚‹ã‹
                        let hasCompleted = false;
                        const subjects = isAll ? getActiveSubjects() : [currentSubj];
                        for (const s of subjects) {
                            if (s.syllabus && s.syllabus.some(u => u.completedDate === dateStr)) {
                                hasCompleted = true; break;
                            }
                        }

                        if (hasEvent) {
                            marksContainer.innerHTML += `<div class="w-1.5 h-1.5 rounded-full bg-app-accent mb-0.5"></div>`;
                        }
                        if (hasCompleted) {
                            marksContainer.innerHTML += `<div class="w-1.5 h-1.5 rounded-full bg-app-success mb-0.5"></div>`;
                        }
                    }

                    // 3. ãƒãƒ£ãƒ¬ãƒ³ã‚¸é”æˆãƒãƒ¼ã‚¯
                    if (isChallengeMode && currentSubj.challengeHistory && currentSubj.challengeHistory[dateStr]) {
                        // ãƒãƒ£ãƒ¬ãƒ³ã‚¸ãƒ¢ãƒ¼ãƒ‰ãªã‚‰æ—¥ä»˜ã®èƒŒæ™¯ã‚’å°‘ã—è±ªè¯ã«ã™ã‚‹ã‹ã€å¤§ããªæ˜Ÿã‚’ã¤ã‘ã‚‹
                        marksContainer.innerHTML += `<i class="fas fa-star text-challenge-gold text-[10px] filter drop-shadow-md"></i>`;
                        cell.classList.add('bg-challenge-gold/5');
                    }

                    cell.appendChild(marksContainer);
                    cell.onclick = () => openDateModal(dateStr);
                } else {
                    // æ—¥ä»˜ãŒãªã„ã‚»ãƒ«ï¼ˆç©ºã‚»ãƒ«ï¼‰
                    cell.className += " bg-gray-900/30 cursor-default"; // å°‘ã—æš—ã
                }

                grid.appendChild(cell);
            }
        }

        function updateCalendarLegend() {
            const legendEl = document.getElementById('calendar-legend'); if (!legendEl) return;
            const subjectsWithGoal = getActiveSubjects().filter(s => s.examDate);
            let html = subjectsWithGoal.length > 0 ? `<span class="mr-2">â€» ç›®æ¨™æ—¥ã®è‰²:</span> ${subjectsWithGoal.map(s => `<span class="${getSubjectColor(s.id)} flex items-center gap-1"><i class="fas fa-flag text-[10px]"></i>${escapeHtml(s.name)}</span>`).join(' ')}` : '<span class="text-gray-600">â€» ç›®æ¨™æ—¥ã¯è©³ç´°ã‹ã‚‰è¨­å®šã§ãã¾ã™</span>';
            legendEl.innerHTML = html;
        }

        // â˜…è¿½åŠ ï¼šç¿’æ…£ãƒã‚§ãƒƒã‚¯è¡¨ã‚’æç”»ã™ã‚‹é–¢æ•°
        function renderChallengeScreen() {
            const container = document.getElementById('challenge-matrix-container');
            const statsContainer = document.getElementById('challenge-stats-grid');

            const challenges = getActiveChallenges();

            if (challenges.length === 0) {
                container.innerHTML = '<div class="p-8 text-center text-xs text-gray-500">ã€Œç®¡ç†ã€ã‚¿ãƒ–ã‹ã‚‰<br>ç¶™ç¶šãƒãƒ£ãƒ¬ãƒ³ã‚¸ã‚’è¿½åŠ ã—ã¦ãã ã•ã„</div>';
                statsContainer.innerHTML = '';
                return;
            }

            // æ—¥ä»˜ãƒ˜ãƒƒãƒ€ãƒ¼ã®ç”Ÿæˆ (ä»Šæ—¥ã‹ã‚‰6æ—¥å‰ã¾ã§)
            const dates = [];
            const today = getToday();
            for (let i = 0; i < 7; i++) {
                const d = new Date(today);
                d.setDate(d.getDate() - i);
                dates.push(d);
            }
            // è¡¨ç¤ºé †: å·¦(éå») -> å³(ä»Šæ—¥) ã«ã™ã‚‹ã‹ã€å·¦(ä»Šæ—¥) -> å³(éå») ã«ã™ã‚‹ã‹
            // ç›´è¿‘ã‚’è¦‹ãŸã„ã®ã§ å·¦(ä»Šæ—¥) -> å³(éå») ã®é †ã§ä¸¦ã¹ã¾ã™

            let html = '<table class="challenge-table"><thead><tr>';
            html += '<th class="challenge-th" style="width: 30%;">é …ç›®</th>';

            dates.forEach(d => {
                const isToday = formatDate(d) === getTodayStr();
                const dStr = `${d.getMonth() + 1}/${d.getDate()}`;
                const week = ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'][d.getDay()];
                html += `<th class="challenge-th ${isToday ? 'today' : ''}">${dStr}<br><span class="text-[9px]">${week}</span></th>`;
            });
            html += '</tr></thead><tbody>';

            // å„ãƒãƒ£ãƒ¬ãƒ³ã‚¸ã®è¡Œç”Ÿæˆ
            challenges.forEach(subj => {
                html += `<tr class="challenge-row">`;
                html += `<td class="challenge-name-cell">${escapeHtml(subj.name)}</td>`;

                dates.forEach(d => {
                    const dateStr = formatDate(d);
                    const isDone = !!subj.challengeHistory[dateStr];
                    const isToday = dateStr === getTodayStr();

                    let btnClass = isDone ? 'check-btn checked' : 'check-btn';
                    if (isToday && !isDone) btnClass += ' today-incomplete'; // ä»Šæ—¥æœªå®Œäº†ãªã‚‰èµ¤æ 

                    html += `<td class="challenge-check-cell">
                        <button onclick="toggleChallengeDate('${subj.id}', '${dateStr}', ${!isDone})" class="${btnClass}">
                            <i class="fas fa-check"></i>
                        </button>
                    </td>`;
                });
                html += '</tr>';
            });
            html += '</tbody></table>';
            container.innerHTML = html;

            // ç¶™ç¶šæ—¥æ•°ã®è¡¨ç¤º
            statsContainer.innerHTML = '';
            challenges.forEach(subj => {
                const stats = calculateChallengeStats(subj);
                statsContainer.innerHTML += `
                    <div class="bg-gray-800 p-3 rounded border border-gray-700 flex justify-between items-center">
                        <span class="text-[10px] text-gray-300 font-bold truncate pr-2">${escapeHtml(subj.name)}</span>
                        <div class="text-right">
                            <span class="text-lg font-bold text-challenge-gold">${stats.currentStreak}</span>
                            <span class="text-[9px] text-gray-500">æ—¥é€£ç¶š</span>
                        </div>
                    </div>`;
            });
        }

        // â˜…è¿½åŠ ï¼šã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆç”¨ã®ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
        function switchTab(targetId) {
            // ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®è¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆ
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.getElementById(targetId).classList.add('active');
            document.getElementById('main-container').scrollTop = 0;

            // ã‚‚ã—ã‚¯ãƒªãƒƒã‚¯ã—ãŸã®ãŒé€šå¸¸ã®nav-btnãªã‚‰è‰²ã‚’ã¤ã‘ã‚‹ï¼ˆä¸­å¤®ãƒœã‚¿ãƒ³ã¯è‰²å›ºå®šãªã®ã§ç„¡è¦–ï¼‰
            const clickedBtn = document.querySelector(`.nav-btn[data-target="${targetId}"]`);
            if (clickedBtn) {
                clickedBtn.classList.replace('text-gray-500', 'text-app-accent');
            }

            // ç”»é¢ã”ã¨ã®æç”»æ›´æ–°
            if (targetId === 'challenge-screen') {
                renderChallengeScreen();
                loadSleepLogDate();
                // å°‘ã—é…å»¶ã•ã›ã¦æç”»ã™ã‚‹ã“ã¨ã§ã€display:blockåæ˜ å¾Œã®ã‚µã‚¤ã‚ºã‚’å–å¾—ã•ã›ã‚‹
                setTimeout(renderSleepChart, 50);
            }
            if (targetId === 'manage-screen') {
                renderManageScreen();
                renderTickerSettings();
            }
            if (targetId === 'record-screen') renderRecordLists();
            if (targetId === 'home-screen') updateUI(); // ãƒ›ãƒ¼ãƒ ã«æˆ»ã£ãŸæ™‚ã‚‚æ›´æ–°
        }

        // â˜…ä¿®æ­£ç‰ˆï¼šç·åˆãƒ¢ãƒ¼ãƒ‰ã§ã‚‚å…¨ç§‘ç›®ã®ãƒªã‚¹ãƒˆã‚’è¡¨ç¤ºã—ã¦ç·¨é›†ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹
        function renderManageScreen() {
            const list = document.getElementById('manage-subject-list');
            list.innerHTML = '';

            // â˜…å¤‰æ›´ç‚¹ï¼šã“ã“ã§ã€Œç·åˆãƒ¢ãƒ¼ãƒ‰ãªã‚‰returnã€ã—ã¦ã„ãŸå‡¦ç†ã‚’å‰Šé™¤ã—ã¾ã—ãŸ

            const active = [], challenges = [], inactive = [];

            // å…¨ã¦ã®ç§‘ç›®ã‚’åˆ†é¡
            Object.values(appData.subjects).forEach(s => {
                if (!s.isActive) inactive.push(s);
                else if (s.type === 'challenge') challenges.push(s);
                else active.push(s);
            });

            // è¡Œã‚’ä½œæˆã™ã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
            const createRow = (s) => `
                <div class="flex justify-between items-center bg-gray-800 p-3 rounded border border-gray-700 mb-2">
                    <div>
                        <div class="text-sm font-bold text-white">${escapeHtml(s.name)}</div>
                        </div>
                    <div class="flex gap-2">
                        <button onclick="toggleSubjectActive('${escapeHtml(s.id)}')" class="text-xs ${s.isActive ? 'text-gray-400' : 'text-app-accent'}">
                            <i class="fas ${s.isActive ? 'fa-archive' : 'fa-box-open'}"></i>
                        </button>
                        <button onclick="${s.type === 'challenge' ? `editChallenge('${escapeHtml(s.id)}')` : `editSubject('${escapeHtml(s.id)}')`}" class="text-xs bg-gray-700 text-white px-2 py-1 rounded border border-gray-600">ç·¨é›†</button>
                        <button onclick="deleteSubjectRequest('${escapeHtml(s.id)}')" class="text-xs bg-red-900/30 text-red-200 px-2 py-1 rounded border border-red-900/50"><i class="fas fa-trash"></i></button>
                    </div>
                </div>`;

            // ãƒªã‚¹ãƒˆæç”»
            if (active.length) list.innerHTML += `<h4 class="text-xs text-gray-500 font-bold mb-2 pl-1">å­¦ç¿’ç§‘ç›®</h4>` + active.map(createRow).join('');
            if (challenges.length) list.innerHTML += `<h4 class="text-xs text-gray-500 font-bold mb-2 mt-4 pl-1">ãƒãƒ£ãƒ¬ãƒ³ã‚¸</h4>` + challenges.map(createRow).join('');
            if (inactive.length) list.innerHTML += `<h4 class="text-xs text-gray-500 font-bold mb-2 mt-4 pl-1 text-gray-600">ã‚¢ãƒ¼ã‚«ã‚¤ãƒ– (æœªå­¦ç¿’)</h4>` + inactive.map(createRow).join('');

            renderTickerSettings(); // ãƒ†ã‚£ãƒƒã‚«ãƒ¼è¨­å®šã‚‚æ›´æ–°

            if (active.length + challenges.length + inactive.length === 0) {
                list.innerHTML = '<p class="text-center text-xs text-gray-500 py-4">ç§‘ç›®ãŒã‚ã‚Šã¾ã›ã‚“ã€‚<br>ä¸‹ã‹ã‚‰è¿½åŠ ã—ã¦ãã ã•ã„ã€‚</p>';
            }
        }

        // --- HANDLERS ---
        function addNewSubject(type) {
            const nameInput = document.getElementById(type === 'challenge' ? 'new-challenge-name' : 'new-subject-name');
            const name = nameInput.value.trim(); if (!name) return;
            const id = 'subj_' + Date.now();
            if (type === 'challenge') appData.subjects[id] = { id, type: 'challenge', name, examDate: null, startDate: getTodayStr(), isActive: true, challengeHistory: {} };
            else appData.subjects[id] = { id, type: 'study', name, examDate: null, startDate: null, isActive: true, history: {}, syllabus: [] };
            nameInput.value = ''; saveData(); updateUI(); showToast('è¿½åŠ ã—ã¾ã—ãŸ');
        }
        function toggleSubjectActive(id) { if (appData.subjects[id]) { appData.subjects[id].isActive = !appData.subjects[id].isActive; saveData(); updateUI(); } }
        function deleteSubjectRequest(id) { showAppConfirm("å‰Šé™¤ç¢ºèª", `ã€Œ${appData.subjects[id].name}ã€ã‚’å®Œå…¨ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`, () => { delete appData.subjects[id]; if (appData.currentSubjectId === id) appData.currentSubjectId = ALL_SUBJECTS_ID; saveData(); updateUI(); }); }
        function editSubject(id) {
            editingSubjectId = id;
            document.getElementById('edit-subject-name-input').value = appData.subjects[id].name;
            document.getElementById('unit-editor-area').classList.remove('hidden');
            document.getElementById('challenge-editor-area').classList.add('hidden');
            renderDifficultyCheckboxes('new-unit-difficulty-checks', id, []);
            renderUnitList();
            resetUnitInput();
            renderDifficultyLabels();
        }

        // â˜… é›£æ˜“åº¦ãƒ©ãƒ™ãƒ«ç®¡ç† (ä¸¦ã³æ›¿ãˆå¯¾å¿œç‰ˆ)
        function renderDifficultyLabels() {
            const container = document.getElementById('difficulty-label-list');
            if (!container || !editingSubjectId) return;
            const subj = appData.subjects[editingSubjectId];
            if (!subj) return;

            const labels = subj.difficultyLabels || {};
            // ä¸¦ã³é †é…åˆ—ãŒãªã„å ´åˆã¯ã‚­ãƒ¼ã®é…åˆ—ã§åˆæœŸåŒ–ã—ã¦ä¿å­˜
            if (!subj.difficultyOrder) {
                subj.difficultyOrder = Object.keys(labels);
                saveData();
            }

            // ä¸¦ã³é †ã«å«ã¾ã‚Œã¦ã„ãªã„ã‚­ãƒ¼ãŒã‚ã‚Œã°æœ«å°¾ã«è¿½åŠ ï¼ˆæ•´åˆæ€§ä¿æŒï¼‰
            Object.keys(labels).forEach(k => {
                if (!subj.difficultyOrder.includes(k)) subj.difficultyOrder.push(k);
            });
            // é€†ã«å­˜åœ¨ã—ãªã„ã‚­ãƒ¼ãŒå«ã¾ã‚Œã¦ã„ã‚Œã°å‰Šé™¤
            subj.difficultyOrder = subj.difficultyOrder.filter(k => labels.hasOwnProperty(k));

            container.innerHTML = '';

            subj.difficultyOrder.forEach((key, index) => {
                const label = labels[key];
                const row = document.createElement('div');
                row.className = 'flex items-center gap-2 bg-gray-900/50 p-1.5 rounded border border-gray-700/50';

                // ä¸Šç§»å‹•ãƒœã‚¿ãƒ³
                const upBtn = index > 0
                    ? `<button onclick="moveDifficultyLabel('${key}', -1)" class="text-gray-500 hover:text-white px-1"><i class="fas fa-chevron-up text-[10px]"></i></button>`
                    : `<span class="w-4 inline-block"></span>`;

                // ä¸‹ç§»å‹•ãƒœã‚¿ãƒ³
                const downBtn = index < subj.difficultyOrder.length - 1
                    ? `<button onclick="moveDifficultyLabel('${key}', 1)" class="text-gray-500 hover:text-white px-1"><i class="fas fa-chevron-down text-[10px]"></i></button>`
                    : `<span class="w-4 inline-block"></span>`;

                row.innerHTML = `
                    <div class="flex flex-col gap-0.5">
                        ${upBtn}
                        ${downBtn}
                    </div>
                    <span class="text-[10px] text-gray-400 font-mono w-6 text-center shrink-0 font-bold">${key}</span>
                    <span class="text-[10px] text-gray-600">â†’</span>
                    <input type="text" value="${label}" id="diff-label-${key}"
                        class="flex-1 bg-gray-900 border border-gray-700 text-white text-[10px] rounded px-2 py-1 outline-none focus:border-app-accent">
                    <button onclick="updateDifficultyLabel('${key}')"
                        class="text-app-accent hover:text-sky-300 text-[10px] px-2" title="ä¿å­˜"><i class="fas fa-save"></i></button>
                    <button onclick="removeDifficultyLabel('${key}')"
                        class="text-gray-600 hover:text-red-400 text-[10px] px-2" title="å‰Šé™¤"><i class="fas fa-trash-alt"></i></button>
                `;
                container.appendChild(row);
            });
        }

        // â˜…è¿½åŠ ï¼šé›£æ˜“åº¦ã‚¿ã‚°ã®ä¸¦ã³æ›¿ãˆ
        function moveDifficultyLabel(key, direction) {
            const subj = appData.subjects[editingSubjectId];
            if (!subj || !subj.difficultyOrder) return;

            const idx = subj.difficultyOrder.indexOf(key);
            if (idx === -1) return;

            const newIdx = idx + direction;
            if (newIdx < 0 || newIdx >= subj.difficultyOrder.length) return;

            // å…¥ã‚Œæ›¿ãˆ
            const temp = subj.difficultyOrder[newIdx];
            subj.difficultyOrder[newIdx] = subj.difficultyOrder[idx];
            subj.difficultyOrder[idx] = temp;

            saveData();
            renderDifficultyLabels();
        }

        function addDifficultyLabel() {
            const key = document.getElementById('new-diff-key').value.trim().toUpperCase();
            const label = document.getElementById('new-diff-label').value.trim();
            if (!key) { showToast('ã‚¿ã‚°ã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }

            const subj = appData.subjects[editingSubjectId];
            if (!subj.difficultyLabels) subj.difficultyLabels = {};
            if (subj.difficultyLabels[key]) { showToast('ãã®ã‚¿ã‚°ã¯æ—¢ã«å­˜åœ¨ã—ã¾ã™'); return; }

            subj.difficultyLabels[key] = label || key;

            // ä¸¦ã³é †ã®æœ«å°¾ã«è¿½åŠ 
            if (!subj.difficultyOrder) subj.difficultyOrder = Object.keys(subj.difficultyLabels);
            if (!subj.difficultyOrder.includes(key)) subj.difficultyOrder.push(key);

            // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã«ã‚‚è¿½åŠ ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆONï¼‰
            if (!subj.difficultyFilter) subj.difficultyFilter = [];
            if (!subj.difficultyFilter.includes(key)) subj.difficultyFilter.push(key);

            document.getElementById('new-diff-key').value = '';
            document.getElementById('new-diff-label').value = '';

            saveData();
            renderDifficultyLabels();
            showToast(`ã‚¿ã‚° ${key} ã‚’è¿½åŠ ã—ã¾ã—ãŸ`);
        }

        function removeDifficultyLabel(key) {
            if (!confirm(`ã‚¿ã‚°ã€Œ${key}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\nï¼ˆè¨­å®šæ¸ˆã¿ã®å˜å…ƒãƒ‡ãƒ¼ã‚¿ã‹ã‚‰ã¯å‰Šé™¤ã•ã‚Œã¾ã›ã‚“ï¼‰`)) return;
            const subj = appData.subjects[editingSubjectId];
            delete subj.difficultyLabels[key];

            // ä¸¦ã³é †ã‹ã‚‰ã‚‚å‰Šé™¤
            if (subj.difficultyOrder) {
                subj.difficultyOrder = subj.difficultyOrder.filter(k => k !== key);
            }

            subj.difficultyFilter = (subj.difficultyFilter || []).filter(f => f !== key);

            saveData();
            renderDifficultyLabels();
            updateUI();
        }

        function updateDifficultyLabel(key) {
            const newVal = document.getElementById(`diff-label-${key}`).value.trim();
            const subj = appData.subjects[editingSubjectId];
            if (!subj.difficultyLabels) subj.difficultyLabels = {};
            subj.difficultyLabels[key] = newVal || key;
            saveData();
            showToast(`ã‚¿ã‚° ${key} ã‚’ä¿å­˜ã—ã¾ã—ãŸ`);
        }

        function editChallenge(id) {
            editingSubjectId = id;
            const s = appData.subjects[id];
            document.getElementById('edit-challenge-name').value = s.name;
            document.getElementById('edit-challenge-start').value = s.startDate || '';
            document.getElementById('edit-challenge-end').value = s.examDate || '';

            // è‡ªå‹•ãƒã‚§ãƒƒã‚¯è¨­å®šã®åæ˜ 
            const autoType = s.autoCheckType || '';
            document.getElementById('edit-challenge-auto-type').value = autoType;
            document.getElementById('edit-challenge-target-time').value = s.autoCheckTime || '';
            toggleAutoTimeInput();

            document.getElementById('challenge-editor-area').classList.remove('hidden');
            document.getElementById('unit-editor-area').classList.add('hidden');
        }

        function updateSubjectName() { const n = document.getElementById('edit-subject-name-input').value.trim(); if (n) { appData.subjects[editingSubjectId].name = n; saveData(); updateUI(); } }

        function saveChallengeSettings() {
            const s = appData.subjects[editingSubjectId];
            s.name = document.getElementById('edit-challenge-name').value;
            s.startDate = document.getElementById('edit-challenge-start').value || null;
            s.examDate = document.getElementById('edit-challenge-end').value || null;

            // è‡ªå‹•ãƒã‚§ãƒƒã‚¯è¨­å®šã®ä¿å­˜
            s.autoCheckType = document.getElementById('edit-challenge-auto-type').value;
            s.autoCheckTime = document.getElementById('edit-challenge-target-time').value;

            saveData();
            updateUI();
            document.getElementById('challenge-editor-area').classList.add('hidden');
        }

        function toggleAutoTimeInput() {
            const type = document.getElementById('edit-challenge-auto-type').value;
            const area = document.getElementById('auto-time-input-area');
            const input = document.getElementById('edit-challenge-target-time');
            const help = document.getElementById('auto-time-help-text');

            if (type) {
                area.classList.remove('hidden');
                if (type === 'study_time') {
                    input.type = 'number';
                    input.placeholder = '60 (åˆ†)';
                    help.textContent = 'â€»ç›®æ¨™ã¨ã™ã‚‹å‹‰å¼·æ™‚é–“ã‚’ã€Œåˆ†ã€ã§å…¥åŠ›ã—ã¦ãã ã•ã„ (ä¾‹: 1æ™‚é–“ãªã‚‰60)';
                } else {
                    input.type = 'time';
                    input.placeholder = '';
                    help.textContent = 'â€»ç›®æ¨™ã¨ã™ã‚‹æ™‚åˆ»ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„';
                }
            } else {
                area.classList.add('hidden');
            }
        }

        function closeUnitEditor() { document.getElementById('unit-editor-area').classList.add('hidden'); }
        function closeChallengeEditor() { document.getElementById('challenge-editor-area').classList.add('hidden'); }
        // â˜…ä¿®æ­£ç‰ˆï¼šãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ä»˜ãã®å˜å…ƒãƒªã‚¹ãƒˆç”Ÿæˆé–¢æ•°
        // â˜…ä¿®æ­£ç‰ˆï¼šã€Œæ—¢é‚ã€ã®æ–‡å­—ã‚’è¡¨ç¤ºã™ã‚‹ã‚ˆã†ã«ã—ãŸãƒªã‚¹ãƒˆæç”»é–¢æ•°
        function renderUnitList() {
            const list = document.getElementById('manage-unit-list');
            list.innerHTML = '';
            const subj = appData.subjects[editingSubjectId];

            const allCheck = document.getElementById('select-all-units');
            if (allCheck) allCheck.checked = false;

            if (!subj || !subj.syllabus) return;

            subj.syllabus.forEach((item, idx) => {
                const div = document.createElement('div');
                div.className = `flex justify-between items-center bg-gray-900 p-2 rounded border border-gray-800 text-[10px] ${idx === editingUnitIndex ? 'border-app-accent bg-gray-800' : ''}`;

                let statusIcon = '<i class="far fa-circle text-gray-600"></i>';
                if (item.status === 'completed') {
                    statusIcon = '<i class="fas fa-check-circle text-app-success"></i>';
                }

                const lapBadge = item.lapCount > 0 ? `<span class="bg-gray-700 text-gray-300 px-1.5 rounded-full text-[9px] ml-1">x${item.lapCount}</span>` : '';
                const weakIndicator = item.isWeak ? '<i class="fas fa-exclamation-triangle text-app-weak text-[9px] ml-1"></i>' : '';

                // â˜…è¿½åŠ ï¼šå®Œäº†æ—¥ã¾ãŸã¯ã€Œæ—¢é‚ã€ã®è¡¨ç¤º
                let dateDisplay = '';
                if (item.status === 'completed') {
                    const dateText = (item.completedDate === 'initial') ? 'æ—¢é‚' : (item.completedDate ? item.completedDate.substring(5).replace('-', '/') : '');
                    dateDisplay = `<span class="text-[9px] text-gray-500 ml-2">(${dateText})</span>`;
                }

                div.innerHTML = `
                    <div class="flex items-center gap-2 flex-1 min-w-0">
                        <input type="checkbox" class="unit-select-checkbox accent-app-accent cursor-pointer" value="${idx}">
                        <div class="w-4 text-center">${statusIcon}</div>
                        <span class="truncate flex-1 cursor-pointer" onclick="editUnit(${idx})">
                            <span class="text-app-sub">[${escapeHtml(item.category)}]</span> ${escapeHtml(item.title)}
                            ${dateDisplay}
                            ${lapBadge}
                            ${weakIndicator}
                        </span>
                    </div>
                    <div class="flex gap-1 items-center">
                        <button onclick="editUnit(${idx})" class="text-gray-500 hover:text-white px-2 py-1"><i class="fas fa-pen"></i></button>
                        <button onclick="deleteUnitRequest(${idx})" class="text-gray-500 hover:text-red-400 px-2 py-1"><i class="fas fa-trash"></i></button>
                    </div>`;
                list.appendChild(div);
            });
        }
        // â˜…è¿½åŠ ï¼šã‚«ãƒ†ã‚´ãƒªä¸€æ‹¬å¤‰æ›´ã®ãŸã‚ã®é–¢æ•°ç¾¤
        function toggleAllUnitChecks(source) {
            const checks = document.querySelectorAll('.unit-select-checkbox');
            checks.forEach(c => c.checked = source.checked);
        }

        // â˜…è¿½åŠ ï¼šçµ±åˆã•ã‚ŒãŸä¸€æ‹¬ç·¨é›†æ©Ÿèƒ½
        function openBulkEditModal() {
            const checks = document.querySelectorAll('.unit-select-checkbox:checked');
            if (checks.length === 0) {
                showToast("ç·¨é›†ã™ã‚‹å˜å…ƒã‚’é¸æŠã—ã¦ãã ã•ã„");
                return;
            }
            // é¸æŠä»¶æ•°ã‚’è¡¨ç¤ºã—ã¦ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
            document.getElementById('bulk-selected-count').textContent = checks.length;

            // å…¥åŠ›æ¬„ã‚’ãƒªã‚»ãƒƒãƒˆ
            document.getElementById('bulk-edit-category').value = '';
            document.getElementById('bulk-edit-status').value = 'no-change';
            document.getElementById('bulk-edit-date').value = '';
            document.getElementById('bulk-edit-lap').value = '';
            document.getElementById('bulk-edit-category').value = '';
            document.getElementById('bulk-edit-status').value = 'no-change';
            document.getElementById('bulk-edit-date').value = '';
            document.getElementById('bulk-edit-lap').value = '';
            renderDifficultyCheckboxes('bulk-edit-difficulty-checks', editingSubjectId, []);
            toggleBulkDateInputInModal();
            toggleBulkDateInputInModal();

            document.getElementById('bulk-edit-modal').classList.remove('hidden');
        }

        function closeBulkEditModal() {
            document.getElementById('bulk-edit-modal').classList.add('hidden');
        }

        function toggleBulkDateInputInModal() {
            const val = document.getElementById('bulk-edit-status').value;
            const dateInput = document.getElementById('bulk-edit-date');
            if (val === 'completed_date') {
                dateInput.classList.remove('hidden');
            } else {
                dateInput.classList.add('hidden');
            }
        }

        function applyCombinedBulkEdit() {
            const checks = document.querySelectorAll('.unit-select-checkbox:checked');
            if (checks.length === 0) return;

            const subj = appData.subjects[editingSubjectId];

            // å„å…¥åŠ›å€¤ã‚’å–å¾—
            const newCat = document.getElementById('bulk-edit-category').value.trim();
            const statusType = document.getElementById('bulk-edit-status').value;
            const dateVal = document.getElementById('bulk-edit-date').value;
            const lapVal = document.getElementById('bulk-edit-lap').value;

            // é›£æ˜“åº¦å–å¾—
            const diffChecks = document.querySelectorAll('#bulk-edit-difficulty-checks input:checked');
            const newDiffs = Array.from(diffChecks).map(c => c.value);
            const shouldUpdateDiff = newDiffs.length > 0;

            let updateCount = 0;

            if (!confirm(`é¸æŠã—ãŸ ${checks.length} ä»¶ã®å˜å…ƒã‚’ä¸€æ‹¬å¤‰æ›´ã—ã¾ã™ã‹ï¼Ÿ`)) return;

            checks.forEach(c => {
                const idx = parseInt(c.value);
                const item = subj.syllabus[idx];
                if (!item) return;

                // ã‚«ãƒ†ã‚´ãƒªå¤‰æ›´
                if (newCat) item.category = newCat;

                // é›£æ˜“åº¦å¤‰æ›´
                if (shouldUpdateDiff) {
                    item.difficulty = newDiffs;
                }

                // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å¤‰æ›´
                if (statusType !== 'no-change') {
                    if (statusType === 'pending') {
                        item.status = 'pending';
                        item.completedDate = null;
                    } else if (statusType === 'initial') {
                        item.status = 'completed';
                        item.completedDate = 'initial';
                    } else if (statusType === 'completed_today') {
                        if (item.status !== 'completed') {
                            item.status = 'completed';
                            item.completedDate = getTodayStr();
                        }
                    } else if (statusType === 'completed_date' && dateVal) {
                        item.status = 'completed';
                        item.completedDate = dateVal;
                    }
                }

                // å‘¨å›æ•°å¤‰æ›´
                if (lapVal !== "") {
                    item.lapCount = parseInt(lapVal);
                }

                updateCount++;
            });

            saveData();
            renderUnitList();
            closeBulkEditModal();
            showToast(`${updateCount}ä»¶ã‚’æ›´æ–°ã—ã¾ã—ãŸ`);
            updateUI();
        }

        function toggleUnitWeak(idx) { const item = appData.subjects[editingSubjectId].syllabus[idx]; item.isWeak = !item.isWeak; saveData(); renderUnitList(); updateUI(); }
        // â˜…ä¿®æ­£ç‰ˆï¼šå˜ä½“ç·¨é›†ã‚‚ãƒ¢ãƒ¼ãƒ€ãƒ«ã§è¡Œã†ã‚ˆã†ã«å¤‰æ›´
        function editUnit(idx) {
            editingUnitIndex = idx;
            const subj = appData.subjects[editingSubjectId];
            const item = subj.syllabus[idx];

            // ãƒ¢ãƒ¼ãƒ€ãƒ«ã«å…¥åŠ›å€¤ã‚’ã‚»ãƒƒãƒˆ
            document.getElementById('single-edit-category').value = item.category;
            document.getElementById('single-edit-title').value = item.title;
            document.getElementById('single-edit-weak').checked = !!item.isWeak;
            document.getElementById('single-edit-lap').value = item.lapCount || 0;
            document.getElementById('single-edit-lap').value = item.lapCount || 0;
            renderDifficultyCheckboxes('single-edit-difficulty-checks', editingSubjectId, item.difficulty || []);

            // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã®åˆ¤å®šã¨ã‚»ãƒƒãƒˆ
            const statusSel = document.getElementById('single-edit-status');
            const dateInput = document.getElementById('single-edit-date');

            if (item.status === 'completed') {
                if (item.completedDate === 'initial') {
                    statusSel.value = 'initial';
                } else {
                    // æ—¥ä»˜ãŒå…¥ã£ã¦ã„ã‚‹å ´åˆã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯ã€Œæ—¥ä»˜æŒ‡å®šã€ã«ã—ã¦ãã®æ—¥ä»˜ã‚’å…¥ã‚Œã‚‹
                    statusSel.value = 'completed_date';
                    dateInput.value = item.completedDate;
                }
            } else {
                statusSel.value = 'pending';
            }

            toggleSingleEditDateInput(); // æ—¥ä»˜æ¬„ã®è¡¨ç¤ºåˆ‡æ›¿
            document.getElementById('single-unit-edit-modal').classList.remove('hidden');
        }

        // â˜…è¿½åŠ ï¼šå˜ä½“ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«ã®æ“ä½œé–¢æ•°ç¾¤
        function closeSingleUnitEditModal() {
            document.getElementById('single-unit-edit-modal').classList.add('hidden');
            editingUnitIndex = null;
        }

        function toggleSingleEditDateInput() {
            const val = document.getElementById('single-edit-status').value;
            const dateInput = document.getElementById('single-edit-date');
            if (val === 'completed_date') {
                dateInput.classList.remove('hidden');
            } else {
                dateInput.classList.add('hidden');
            }
        }

        function saveSingleUnitEdit() {
            const subj = appData.subjects[editingSubjectId];
            const item = subj.syllabus[editingUnitIndex];

            const cat = document.getElementById('single-edit-category').value.trim();
            const title = document.getElementById('single-edit-title').value.trim();

            if (!cat || !title) {
                showToast("ã‚«ãƒ†ã‚´ãƒªã¨å˜å…ƒåã¯å¿…é ˆã§ã™");
                return;
            }

            // å€¤ã‚’æ›´æ–°
            item.category = cat;
            item.title = title;
            item.isWeak = document.getElementById('single-edit-weak').checked;
            item.lapCount = parseInt(document.getElementById('single-edit-lap').value) || 0;

            // é›£æ˜“åº¦æ›´æ–°
            const diffChecks = document.querySelectorAll('#single-edit-difficulty-checks input:checked');
            const diffs = Array.from(diffChecks).map(c => c.value);
            item.difficulty = diffs.length > 0 ? diffs : undefined;

            const statusType = document.getElementById('single-edit-status').value;
            const dateVal = document.getElementById('single-edit-date').value;

            // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°ãƒ­ã‚¸ãƒƒã‚¯
            if (statusType === 'pending') {
                item.status = 'pending';
                item.completedDate = null;
            } else if (statusType === 'initial') {
                item.status = 'completed';
                item.completedDate = 'initial';
            } else {
                // completed
                item.status = 'completed';
                if (statusType === 'completed_date' && dateVal) {
                    item.completedDate = dateVal;
                } else {
                    // ã€Œå®Œäº†(ä»Šæ—¥)ã€ãŒé¸ã°ã‚ŒãŸã€ã¾ãŸã¯æ—¥ä»˜æŒ‡å®šã§ç©ºæ¬„ã ã£ãŸå ´åˆã¯ä»Šæ—¥ã®æ—¥ä»˜
                    // ãŸã ã—ã€æ—¢ã«å®Œäº†æ¸ˆã¿ã§æ—¥ä»˜ãŒå¤‰ã‚ã‚‰ãªã„å ´åˆã¯ç¶­æŒã—ãŸæ–¹ãŒè¦ªåˆ‡ã‹ã‚‚ï¼Ÿ
                    // ä»Šå›ã¯æ˜ç¤ºçš„ã«å¤‰æ›´æ“ä½œã‚’ã—ã¦ã„ã‚‹ã®ã§ã€é¸æŠã«å¾“ã„ã¾ã™
                    if (statusType === 'completed') {
                        item.completedDate = getTodayStr();
                    } else if (item.completedDate && statusType === 'completed_date') {
                        // æ—¢å­˜ã®æ—¥ä»˜ã‚’ã‚­ãƒ¼ãƒ—
                    } else {
                        item.completedDate = getTodayStr();
                    }
                }
            }

            saveData();
            renderUnitList();
            updateUI();
            closeSingleUnitEditModal();
            showToast("å˜å…ƒã‚’æ›´æ–°ã—ã¾ã—ãŸ");
        }

        // â˜…ä¿®æ­£ç‰ˆï¼š0æ—¥ç›®å®Œäº†ã‚’ã€Œæ—¥ä»˜ã€ã§ã¯ãªãã€Œæ—¢é‚(initial)ã€ã¨ã—ã¦è¨˜éŒ²ã™ã‚‹é–¢æ•°
        function saveUnit() {
            const cat = document.getElementById('new-unit-category').value.trim();
            const title = document.getElementById('new-unit-title').value.trim();
            if (!title) { showToast('å˜å…ƒåã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }

            const w = document.getElementById('new-unit-weak').checked;
            const lap = parseInt(document.getElementById('new-unit-lap').value) || 0;
            const statusType = document.getElementById('new-unit-status-select').value;

            // é›£æ˜“åº¦ã‚¿ã‚°é…åˆ—å–å¾—
            const diffChecks = document.querySelectorAll('#new-unit-difficulty-checks input:checked');
            const diffs = Array.from(diffChecks).map(c => c.value);

            const subj = appData.subjects[editingSubjectId];

            // æ—¥ä»˜ã¨ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã®æ±ºå®š
            let newStatus = 'pending';
            let newDate = undefined;
            let shouldCleanSchedule = false;

            if (statusType === 'completed') {
                newStatus = 'completed';
                if (editingUnitIndex !== null && subj.syllabus[editingUnitIndex].completedDate && subj.syllabus[editingUnitIndex].completedDate !== 'initial') {
                    newDate = subj.syllabus[editingUnitIndex].completedDate;
                } else {
                    newDate = getTodayStr();
                }
            } else if (statusType === 'completed_init') {
                newStatus = 'completed';
                if (!subj.startDate) subj.startDate = getTodayStr();
                newDate = "initial";
                shouldCleanSchedule = true;
            }

            const newItem = {
                id: (editingUnitIndex !== null) ? subj.syllabus[editingUnitIndex].id : `u_${Date.now()}_${Math.random().toString(36).substr(2, 5)}`,
                category: cat,
                title: title,
                status: newStatus,
                completedDate: newDate,
                lapCount: lap,
                isWeak: w,
                difficulty: diffs.length > 0 ? diffs : undefined
            };

            if (editingUnitIndex !== null) {
                // æ—¢å­˜æ›´æ–°
                if (shouldCleanSchedule) {
                    const uId = subj.syllabus[editingUnitIndex].id;
                    Object.keys(appData.schedules).forEach(date => {
                        appData.schedules[date] = appData.schedules[date].filter(task => task.unitId !== uId);
                        if (appData.schedules[date].length === 0) delete appData.schedules[date];
                    });
                }
                subj.syllabus[editingUnitIndex] = newItem;
            } else {
                // æ–°è¦è¿½åŠ 
                subj.syllabus.push(newItem);
            }

            saveData();
            renderUnitList();
            resetUnitInput();
            updateUI();
            showToast(editingUnitIndex !== null ? 'å˜å…ƒã‚’æ›´æ–°ã—ã¾ã—ãŸ' : 'å˜å…ƒã‚’è¿½åŠ ã—ã¾ã—ãŸ');
        }

        function resetUnitInput() {
            editingUnitIndex = null;
            document.getElementById('new-unit-category').value = '';
            document.getElementById('new-unit-title').value = '';
            document.getElementById('new-unit-status-select').value = 'pending';
            document.getElementById('new-unit-lap').value = 0;
            document.getElementById('new-unit-weak').checked = false;
            document.getElementById('add-update-unit-btn').textContent = 'è¿½åŠ ';
            document.getElementById('cancel-edit-unit-btn').classList.add('hidden');
            // é›£æ˜“åº¦ãƒªã‚»ãƒƒãƒˆ
            if (editingSubjectId) renderDifficultyCheckboxes('new-unit-difficulty-checks', editingSubjectId, []);
        }

        function cancelEditUnit() { resetUnitInput(); }
        function deleteUnitRequest(idx) { showAppConfirm("å‰Šé™¤ç¢ºèª", "å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ", () => { appData.subjects[editingSubjectId].syllabus.splice(idx, 1); saveData(); renderUnitList(); updateUI(); }); }

        // â˜…ä¿®æ­£ç‰ˆï¼šé•·ã„å˜å…ƒåã§ã‚‚ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆå´©ã‚Œã—ãªã„äºˆå®šè¿½åŠ ãƒ¢ãƒ¼ãƒ€ãƒ«
        // â˜…ä¿®æ­£ç‰ˆï¼šHTMLå´ã®æ§‹é€ ã«åˆã‚ã›ã¦ã‚·ãƒ³ãƒ—ãƒ«ã«ã—ãŸäºˆå®šè¿½åŠ ãƒ¢ãƒ¼ãƒ€ãƒ«
        function openDateModal(dateStr) {
            selectedDateString = dateStr;
            document.getElementById('modal-date-title').textContent = formatShortDate(new Date(dateStr));

            const isChallenge = appData.currentSubjectId !== ALL_SUBJECTS_ID && appData.subjects[appData.currentSubjectId]?.type === 'challenge';
            document.getElementById('modal-study-content').style.display = isChallenge ? 'none' : 'block';
            document.getElementById('modal-challenge-content').style.display = isChallenge ? 'block' : 'none';

            if (isChallenge) {
                const subj = appData.subjects[appData.currentSubjectId]; const isDone = !!subj.challengeHistory[dateStr];
                document.getElementById('modal-challenge-status').textContent = `ãƒãƒ£ãƒ¬ãƒ³ã‚¸: ${subj.name}`;
                const btn = document.getElementById('toggle-challenge-date-btn'); btn.className = isDone ? "w-full py-3 bg-red-900 text-red-200 rounded-lg" : "w-full py-3 bg-challenge-gold text-app-dark rounded-lg";
                btn.textContent = isDone ? "å–ã‚Šæ¶ˆã™" : "é”æˆæ¸ˆã¿ã«ã™ã‚‹"; btn.onclick = () => { toggleChallengeDate(subj.id, dateStr, !isDone); closeModal(); };
            } else {
                const isAll = appData.currentSubjectId === ALL_SUBJECTS_ID; document.getElementById('set-exam-btn').style.display = isAll ? 'none' : 'block';
                if (!isAll) { const s = appData.subjects[appData.currentSubjectId]; const isSet = s.examDate === dateStr; document.getElementById('exam-btn-text').textContent = isSet ? 'ç›®æ¨™è§£é™¤' : 'ç›®æ¨™è¨­å®š'; document.getElementById('set-exam-btn').onclick = () => { s.examDate = isSet ? null : dateStr; if (!isSet && !s.startDate) s.startDate = getTodayStr(); saveData(); updateUI(); closeModal(); }; }
                const comp = document.getElementById('modal-completed-list'); comp.innerHTML = ''; (isAll ? getActiveSubjects() : [appData.subjects[appData.currentSubjectId]]).forEach(s => { (s.syllabus || []).forEach(u => { if (u.completedDate === dateStr) comp.innerHTML += `<div class="text-[10px] mb-1 truncate">âœ” [${escapeHtml(s.name)}] ${escapeHtml(u.title)}</div>`; }); });

                const taskList = document.getElementById('modal-task-list');
                taskList.innerHTML = "";
                const currentSchedule = appData.schedules[dateStr] || [];

                currentSchedule.forEach((t, i) => {
                    const s = appData.subjects[t.subjectId];
                    const u = s?.syllabus.find(x => x.id === t.unitId);
                    if (u) {
                        const isDone = u.status === 'completed';
                        taskList.innerHTML += `
                        <div class="flex justify-between items-center p-2 text-xs border-b border-gray-800 ${isDone ? 'opacity-50' : ''}">
                            <span class="flex-1 min-w-0 truncate mr-2 ${isDone ? 'line-through' : ''}">[${escapeHtml(s.name)}] ${escapeHtml(u.title)}</span>
                            <button onclick="removeTaskFromDate('${dateStr}', ${i})" class="text-red-400 shrink-0"><i class="fas fa-trash-alt"></i></button>
                        </div>`;
                    }
                });

                const sel = document.getElementById('unit-selector');
                sel.innerHTML = '<option value="">å˜å…ƒè¿½åŠ ...</option>';
                // â˜…ä»¥å‰ã®ã‚³ãƒ¼ãƒ‰ã§ã“ã“ã«ã‚ã£ãŸ sel.className = ... ã®è¡Œã¯å‰Šé™¤ã—ã¾ã—ãŸï¼ˆHTMLå´ã§è¨­å®šæ¸ˆã¿ã®ãŸã‚ï¼‰

                const pendingGroup = document.createElement('optgroup');
                pendingGroup.label = "æœªå®Œäº†ã®å˜å…ƒ";
                pendingGroup.className = "text-white bg-gray-900";

                const completedGroup = document.createElement('optgroup');
                completedGroup.label = "å®Œäº†æ¸ˆã¿ (å¾©ç¿’ãƒ»å‘¨å›)";
                completedGroup.className = "text-app-success bg-gray-900";

                getCurrentSyllabus().forEach(u => {
                    const sId = u._subjectId || appData.currentSubjectId;
                    const sName = u._subjectName || appData.subjects[sId].name;
                    const isAlreadyScheduled = currentSchedule.some(t => t.subjectId === sId && t.unitId === u.id);

                    if (!isAlreadyScheduled) {
                        const option = document.createElement('option');
                        option.value = `${sId}:${u.id}`;

                        if (u.status === 'pending') {
                            option.textContent = `[${sName}] ${u.title}`;
                            pendingGroup.appendChild(option);
                        } else {
                            const lap = u.lapCount || 1;
                            option.textContent = `[${sName}] ${u.title} (ç¾åœ¨: ${lap}å‘¨)`;
                            completedGroup.appendChild(option);
                        }
                    }
                });

                if (pendingGroup.children.length > 0) sel.appendChild(pendingGroup);
                if (completedGroup.children.length > 0) sel.appendChild(completedGroup);
            }
            document.getElementById('date-modal').classList.remove('hidden');
        }

        function closeModal() { document.getElementById('date-modal').classList.add('hidden'); }
        function removeTaskFromDate(d, i) { appData.schedules[d].splice(i, 1); saveData(); openDateModal(d); updateUI(); }
        // â˜…å¤‰æ›´ï¼šåŒæœŸå‡¦ç†ã‚’è¿½åŠ ã—ãŸäºˆå®šç™»éŒ²é–¢æ•°
        function addUnitToDate() {
            const v = document.getElementById('unit-selector').value;
            if (!v) return;

            const [sid, uid] = v.split(':');

            // ã‚¢ãƒ—ãƒªå†…ãƒ‡ãƒ¼ã‚¿ã®æ›´æ–°
            if (!appData.schedules[selectedDateString]) {
                appData.schedules[selectedDateString] = [];
            }
            appData.schedules[selectedDateString].push({ subjectId: sid, unitId: uid });
            saveData();

            // â˜…ã“ã“ãŒè¿½åŠ éƒ¨åˆ†ï¼šGoogle ToDoã¸åŒæœŸ
            const targetSubj = appData.subjects[sid];
            const targetUnit = targetSubj?.syllabus.find(x => x.id === uid);
            if (targetUnit) {
                addToGoogleTasks(targetUnit.title, selectedDateString);
            }

            openDateModal(selectedDateString);
            updateUI();
        }
        // â˜…ä¿®æ­£ç‰ˆï¼šæœŸé™åˆ‡ã‚Œãªã‚‰ãã®å ´ã§å†æ¥ç¶šã—ã¦ãã‚Œã‚‹åŒæœŸé–¢æ•°
        function syncFromGoogleTasks() {
            // ãƒˆãƒ¼ã‚¯ãƒ³ãŒãªã„å ´åˆ
            if (!googleAccessToken) {
                // è‡ªå‹•ã§å†ãƒ­ã‚°ã‚¤ãƒ³ã‚’è©¦ã¿ã‚‹ã‹èã
                if (confirm("Googleé€£æºã®æ¥ç¶šãŒåˆ‡ã‚Œã¦ã„ã¾ã™ã€‚\nå†æ¥ç¶šï¼ˆãƒ­ã‚°ã‚¤ãƒ³ï¼‰ã—ã¾ã™ã‹ï¼Ÿ")) {
                    performGoogleLogin();
                }
                return;
            }

            showToast("Google ToDoã‹ã‚‰åŒæœŸä¸­...");
            fetch('https://tasks.googleapis.com/tasks/v1/lists/@default/tasks?showCompleted=true&showHidden=true', {
                headers: { 'Authorization': `Bearer ${googleAccessToken}` }
            })
                .then(response => {
                    if (response.status === 401) {
                        // 401ã‚¨ãƒ©ãƒ¼ï¼ˆæœŸé™åˆ‡ã‚Œï¼‰ã®å ´åˆã‚‚å†ãƒ­ã‚°ã‚¤ãƒ³ã¸èª˜å°
                        throw new Error("AUTH_EXPIRED");
                    }
                    return response.json();
                })
                .then(data => {
                    if (!data.items) {
                        showToast("åŒæœŸã™ã‚‹ã‚¿ã‚¹ã‚¯ã¯ã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸ");
                        return;
                    }
                    // ...ï¼ˆä¸­ç•¥ï¼šå¤‰æ›´ãªã—ï¼‰...
                    let updatedCount = 0;
                    const todayStr = getTodayStr();

                    data.items.forEach(gTask => {
                        if (gTask.title.startsWith("[å­¦ç¿’] ")) {
                            const unitTitle = gTask.title.replace("[å­¦ç¿’] ", "");
                            const isCompletedInGoogle = (gTask.status === 'completed');
                            let taskCompletedDate = null;
                            if (gTask.completed) {
                                taskCompletedDate = formatDate(new Date(gTask.completed));
                            }
                            Object.values(appData.subjects).forEach(subj => {
                                if (subj.type === 'study' && subj.syllabus) {
                                    const unit = subj.syllabus.find(u => u.title === unitTitle);
                                    if (unit && isCompletedInGoogle && unit.status === 'pending' && taskCompletedDate === todayStr) {
                                        unit.status = 'completed';
                                        unit.completedDate = taskCompletedDate;
                                        updatedCount++;
                                    }
                                }
                            });
                        }
                    });

                    if (updatedCount > 0) {
                        saveData();
                        updateUI();
                        showToast(`${updatedCount}å€‹ã®å˜å…ƒã‚’åŒæœŸã—ã¾ã—ãŸ`);
                    } else {
                        showToast("æ–°ã—ã„å®Œäº†ã‚¿ã‚¹ã‚¯ã¯ã‚ã‚Šã¾ã›ã‚“");
                    }
                })
                .catch(err => {
                    if (err.message === "AUTH_EXPIRED" || err.message.includes("401")) {
                        if (confirm("æ¥ç¶šã®æœ‰åŠ¹æœŸé™ãŒåˆ‡ã‚Œã¾ã—ãŸã€‚\nå†æ¥ç¶šã—ã¾ã™ã‹ï¼Ÿ")) {
                            performGoogleLogin();
                        }
                    } else {
                        console.error("Sync error:", err);
                        showToast("åŒæœŸã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ");
                    }
                });
        }
        function openSettingsModal() {
            document.getElementById('settings-modal').classList.remove('hidden');
            updateThemeBtn(document.documentElement.classList.contains('light-mode'));
            // ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç•ªå·ã‚’åæ˜ 
            const vDisplay = document.getElementById('app-version-display');
            if (vDisplay && typeof APP_VERSION !== 'undefined') vDisplay.textContent = APP_VERSION;
        }
        function closeSettingsModal() { document.getElementById('settings-modal').classList.add('hidden'); }
        function requestReset() { showAppConfirm("å…¨ãƒªã‚»ãƒƒãƒˆ", "å…¨ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’æ¶ˆå»ã—ã¾ã™ã‹ï¼Ÿ", () => { appData = getBlankData(); saveData(); updateUI(); closeSettingsModal(); }); }
        function exportData() { const blob = new Blob([JSON.stringify(appData)], { type: "application/json" }); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `backup_${getTodayStr()}.json`; a.click(); }
        // å¾©æ´»: ãƒ•ã‚¡ã‚¤ãƒ«ã‚¤ãƒ³ãƒãƒ¼ãƒˆæ©Ÿèƒ½
        function importData(input) { const reader = new FileReader(); reader.onload = (e) => { appData = migrateData(JSON.parse(e.target.result)); saveData(); updateUI(); showToast('å¾©å…ƒã—ã¾ã—ãŸ'); }; reader.readAsText(input.files[0]); }
        function copyForKeep() {
            const d = formatDate(currentRecordDate); const tasks = appData.schedules[d] || [];
            let text = `ã€${d} ã®è¨˜éŒ²ã€‘\n`; tasks.forEach(task => { const s = appData.subjects[task.subjectId]; const u = s?.syllabus.find(x => x.id === task.unitId); if (u) text += `${u.status === 'completed' ? 'â˜‘' : 'â˜'} [${s.name}] ${u.title}\n`; });
            copyTextToClipboard(text); showToast('ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ');
        }

        // å¾©æ´»: Gemini(AI)é€£æºæ©Ÿèƒ½
        function copyPrompt() {
            const text = document.getElementById('gemini-prompt-template').value;
            copyTextToClipboard(text);
            showToast("ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ");
        }

        function importFromGemini() {
            const input = document.getElementById('gemini-json-input');
            const jsonStr = input.value.trim();
            if (!jsonStr) return;
            try {
                const data = JSON.parse(jsonStr);
                if (!data.name || !data.syllabus) throw new Error("å½¢å¼ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“");

                const id = 'subj_' + Date.now();
                const newSubj = {
                    id: id,
                    type: 'study',
                    name: data.name,
                    examDate: null,
                    startDate: getTodayStr(),
                    isActive: true,
                    history: {},
                    syllabus: data.syllabus.map((item, i) => ({
                        id: `u_${Date.now()}_${i}`,
                        category: item.category,
                        title: item.title,
                        status: 'pending',
                        isWeak: false
                    }))
                };
                appData.subjects[id] = newSubj;
                saveData();
                updateUI();
                input.value = '';
                showToast(`ã€Œ${data.name}ã€ã‚’å–ã‚Šè¾¼ã¿ã¾ã—ãŸ`);
            } catch (e) {
                alert("JSONã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: " + e.message);
            }
        }

        // â˜… IDãƒ™ãƒ¼ã‚¹ã®ã‚«ãƒ†ã‚´ãƒªæ§‹é€ ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ/å†ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
        function exportSyllabusStructure() {
            if (!editingSubjectId) { showToast("ç§‘ç›®ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“"); return; }
            const subj = appData.subjects[editingSubjectId];
            if (!subj || !subj.syllabus || subj.syllabus.length === 0) { showToast("å˜å…ƒãŒã‚ã‚Šã¾ã›ã‚“"); return; }
            const structure = subj.syllabus.map(u => ({ id: u.id, category: u.category || "", title: u.title, difficulty: u.difficulty || "" }));
            const json = JSON.stringify(structure, null, 2);
            copyTextToClipboard(json);
            showToast(`${structure.length}ä»¶ã®æ§‹é€ JSONã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ`);
        }

        function reimportSyllabusStructure() {
            if (!editingSubjectId) { showToast("ç§‘ç›®ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“"); return; }
            const subj = appData.subjects[editingSubjectId];
            if (!subj) return;

            const input = document.getElementById('syllabus-structure-input');
            const jsonStr = input.value.trim();
            if (!jsonStr) { showToast("JSONã‚’è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„"); return; }

            let newStructure;
            try { newStructure = JSON.parse(jsonStr); } catch (e) { showToast("âš ï¸ JSONå½¢å¼ã‚¨ãƒ©ãƒ¼: " + e.message); return; }
            if (!Array.isArray(newStructure)) { showToast("âš ï¸ é…åˆ—å½¢å¼ã®JSONãŒå¿…è¦ã§ã™"); return; }

            // IDæ¤œè¨¼: æ—¢å­˜syllabusã®IDã‚»ãƒƒãƒˆ
            const existingIds = new Set(subj.syllabus.map(u => u.id));
            const newIds = newStructure.map(u => u.id);
            const newIdSet = new Set(newIds);

            // é‡è¤‡ãƒã‚§ãƒƒã‚¯
            if (newIds.length !== newIdSet.size) { showToast("âš ï¸ é‡è¤‡ã—ãŸIDãŒã‚ã‚Šã¾ã™"); return; }

            // æ—¢å­˜ã«ã‚ã£ã¦æ–°è¦ã«ãªã„ID
            const missingIds = [...existingIds].filter(id => !newIdSet.has(id));
            if (missingIds.length > 0) { showToast(`âš ï¸ ${missingIds.length}ä»¶ã®IDãŒä¸è¶³: ${missingIds[0]}...`); return; }

            // æ–°è¦ã«ã‚ã£ã¦æ—¢å­˜ã«ãªã„ID
            const extraIds = [...newIdSet].filter(id => !existingIds.has(id));
            if (extraIds.length > 0) { showToast(`âš ï¸ ${extraIds.length}ä»¶ã®ä¸æ˜ãªID: ${extraIds[0]}...`); return; }

            // å„é …ç›®ã«category/titleãŒã‚ã‚‹ã‹
            for (const item of newStructure) {
                if (typeof item.category === 'undefined' || typeof item.title === 'undefined') {
                    showToast(`âš ï¸ id:${item.id} ã«categoryã¾ãŸã¯titleãŒã‚ã‚Šã¾ã›ã‚“`); return;
                }
            }

            // æ¤œè¨¼OK â†’ category/title/difficultyã®ã¿æ›´æ–°
            const updateMap = {};
            newStructure.forEach(item => { updateMap[item.id] = { category: item.category, title: item.title, difficulty: item.difficulty }; });

            let changed = 0;
            subj.syllabus.forEach(unit => {
                const update = updateMap[unit.id];
                if (unit.category !== update.category || unit.title !== update.title || (unit.difficulty || '') !== (update.difficulty || '')) {
                    unit.category = update.category;
                    unit.title = update.title;
                    unit.difficulty = update.difficulty || undefined;
                    changed++;
                }
            });

            saveData(); updateUI(); renderUnitList();
            input.value = '';
            showToast(`${changed}ä»¶ã®category/titleã‚’æ›´æ–°ã—ã¾ã—ãŸ`);
        }

        function importTickerData() {
            const input = document.getElementById('ticker-json-input');
            const jsonStr = input.value.trim();
            if (!jsonStr) return;
            try {
                const data = JSON.parse(jsonStr);
                if (!data.categories || !data.messages) throw new Error("å½¢å¼ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“");

                let addedCategories = 0;
                let updatedCategories = 0;
                let addedMessages = 0;

                // Merge categories
                data.categories.forEach(newCat => {
                    if (!newCat.id || !newCat.name) return; // Basic validation
                    const existingCatIndex = appData.ticker.categories.findIndex(c => c.id === newCat.id);
                    if (existingCatIndex > -1) {
                        // Update existing category
                        appData.ticker.categories[existingCatIndex] = { ...appData.ticker.categories[existingCatIndex], ...newCat };
                        updatedCategories++;
                    } else {
                        // Add new category
                        appData.ticker.categories.push(newCat);
                        addedCategories++;
                    }
                });

                // Merge messages
                data.messages.forEach(newMsg => {
                    if (!newMsg.categoryId || !newMsg.text) return; // Basic validation
                    const isDuplicate = appData.ticker.messages.some(m => m.categoryId === newMsg.categoryId && m.text === newMsg.text);
                    if (!isDuplicate) {
                        appData.ticker.messages.push(newMsg);
                        addedMessages++;
                    }
                });

                saveData();
                renderTickerSettings();
                initTicker(); // Restart ticker
                input.value = '';
                showToast(`ã‚«ãƒ†ã‚´ãƒª: ${addedCategories}ä»¶è¿½åŠ , ${updatedCategories}ä»¶æ›´æ–°. ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸: ${addedMessages}ä»¶è¿½åŠ `);
            } catch (e) {
                alert("JSONã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: " + e.message);
            }
        }
        function resetTickerData() {
            if (confirm("ãƒ†ã‚£ãƒƒã‚«ãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚’åˆæœŸåŒ–ã—ã¾ã™ã‹ï¼Ÿ")) {
                appData.ticker = JSON.parse(JSON.stringify(defaultTicker));
                saveData();
                renderTickerSettings();
                initTicker();
                showToast("åˆæœŸåŒ–ã—ã¾ã—ãŸ");
            }
        }

        function copyLongTermPrompt() {
            const subjects = getActiveSubjects().map(s => `${s.name} (ç›®æ¨™: ${s.examDate || 'æœªå®š'})`).join(', ');
            const text = `ä»¥ä¸‹ã®ç§‘ç›®ã®é•·æœŸå­¦ç¿’è¨ˆç”»ã‚’ç«‹ã¦ã¦ãã ã•ã„ã€‚\nç¾åœ¨æ—¥: ${getTodayStr()}\nç§‘ç›®: ${subjects}\n\næ¡ä»¶:\n- è©¦é¨“æ—¥ã‹ã‚‰é€†ç®—ã—ã¦æœˆã”ã¨ã®ãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³ã‚’æç¤º\n- å„ªå…ˆé †ä½ã‚’ã¤ã‘ã‚‹ã“ã¨`;
            copyTextToClipboard(text);
            document.getElementById('gemini-copy-feedback').classList.remove('hidden');
            setTimeout(() => document.getElementById('gemini-copy-feedback').classList.add('hidden'), 3000);
        }

        function copyDailyPrompt() {
            const pending = getCurrentSyllabus().filter(i => i.status === 'pending').slice(0, 10).map(i => i.title).join(', ');
            const text = `ä»Šæ—¥ã®å­¦ç¿’ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚\nç¾åœ¨æ—¥: ${getTodayStr()}\nå„ªå…ˆçš„ã«ã‚„ã‚‹ã¹ãå˜å…ƒå€™è£œ: ${pending}\n\næ¡ä»¶:\n- ä¼‘æ†©ã‚’å«ã‚ãŸç¾å®Ÿçš„ãªæ™‚é–“å‰²\n- é›†ä¸­åŠ›ãŒé«˜ã„åˆå‰ä¸­ã«é‡ã„ã‚¿ã‚¹ã‚¯`;
            copyTextToClipboard(text);
            document.getElementById('gemini-copy-feedback').classList.remove('hidden');
            setTimeout(() => document.getElementById('gemini-copy-feedback').classList.add('hidden'), 3000);
        }

        function copyReportPrompt() {
            const todayStr = getTodayStr();
            const done = [];
            getActiveSubjects().forEach(s => {
                s.syllabus.forEach(u => {
                    if (u.completedDate === todayStr) done.push(`[${s.name}] ${u.title}`);
                });
            });
            const text = `ä»Šæ—¥ã®å­¦ç¿’å ±å‘Šã§ã™ã€‚\nå®Ÿæ–½æ—¥: ${todayStr}\nå®Œäº†ã—ãŸå˜å…ƒ:\n${done.join('\n') || 'ãªã—'}\n\nã“ã®å†…å®¹ã§è¤’ã‚ã¦ã€æ¬¡ã®ãƒ¢ãƒãƒ™ãƒ¼ã‚·ãƒ§ãƒ³ã«ã¤ãªãŒã‚‹ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’ãã ã•ã„ã€‚`;
            copyTextToClipboard(text);
            document.getElementById('gemini-copy-feedback').classList.remove('hidden');
            setTimeout(() => document.getElementById('gemini-copy-feedback').classList.add('hidden'), 3000);
        }

        // â˜…è¿½åŠ ï¼šAIæ§‹é€ ç·¨é›†ç”¨é–¢æ•° (ã‚¿ã‚°å¯¾å¿œç‰ˆ)
        function exportSyllabusStructure() {
            const subj = appData.subjects[editingSubjectId];
            if (!subj || !subj.syllabus) {
                showToast("å˜å…ƒãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“");
                return;
            }
            // ID, Category, Title, Difficultyã‚’å‡ºåŠ›
            const data = subj.syllabus.map(u => ({
                id: u.id,
                category: u.category,
                title: u.title,
                difficulty: u.difficulty
            }));
            const json = JSON.stringify(data, null, 2);
            document.getElementById('syllabus-structure-input').value = json;
            copyTextToClipboard(json); // ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚‚ã‚³ãƒ”ãƒ¼
            showToast("JSONã‚’ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ");
        }

        function reimportSyllabusStructure() {
            const input = document.getElementById('syllabus-structure-input').value;
            if (!input) {
                showToast("JSONã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
                return;
            }
            try {
                const data = JSON.parse(input);
                if (!Array.isArray(data)) throw new Error("ãƒ«ãƒ¼ãƒˆãŒé…åˆ—ã§ã¯ã‚ã‚Šã¾ã›ã‚“");

                const subj = appData.subjects[editingSubjectId];
                if (!subj || !subj.syllabus) {
                    showToast("ç§‘ç›®ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“");
                    return;
                }

                let count = 0;
                data.forEach(item => {
                    // IDã§ãƒãƒƒãƒãƒ³ã‚°ã—ã¦æ›´æ–°
                    const unit = subj.syllabus.find(u => u.id === item.id);
                    if (unit) {
                        if (item.category !== undefined) unit.category = item.category;
                        if (item.title !== undefined) unit.title = item.title;

                        // difficultyã®æ›´æ–° (é…åˆ—å¯¾å¿œ)
                        if (item.difficulty !== undefined) {
                            if (Array.isArray(item.difficulty)) {
                                unit.difficulty = item.difficulty;
                            } else if (typeof item.difficulty === 'string') {
                                unit.difficulty = [item.difficulty];
                            } else {
                                unit.difficulty = undefined; // nullãªã©ã¯ã‚¯ãƒªã‚¢
                            }
                        }
                        count++;
                    }
                });
                saveData();
                renderUnitList(); // ãƒªã‚¹ãƒˆå†æç”»
                showToast(`${count}ä»¶ã®å˜å…ƒæƒ…å ±ã‚’æ›´æ–°ã—ã¾ã—ãŸ`);
            } catch (e) {
                showAppConfirm("ã‚¨ãƒ©ãƒ¼", "JSONã®ãƒ‘ãƒ¼ã‚¹ã«å¤±æ•—ã—ã¾ã—ãŸ:\n" + e.message, () => { });
            }
        }

        // â˜…è¿½åŠ ï¼šAIæ§‹é€ ç·¨é›†ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚³ãƒ”ãƒ¼
        function copyStructurePrompt() {
            const text = `ä»¥ä¸‹ã®å­¦ç¿’å˜å…ƒãƒªã‚¹ãƒˆï¼ˆJSONï¼‰ã®å„é …ç›®ã® "difficulty" ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’æ›´æ–°ã—ã¦ãã ã•ã„ã€‚
é›£æ˜“åº¦ã¯ä»¥ä¸‹ã®åŸºæº–ã§é…åˆ—å½¢å¼ï¼ˆ["A"], ["B"]ãªã©ï¼‰ã§ä»˜ä¸ã—ã¦ãã ã•ã„ã€‚

ã€é›£æ˜“åº¦åŸºæº–ã€‘
- ["A"]: åŸºç¤ãƒ»åŸºæœ¬äº‹é …
- ["B"]: æ¨™æº–çš„ãªå…¥è©¦ãƒ¬ãƒ™ãƒ«
- ["C"]: å¿œç”¨ãƒ»é›£å•ãƒ¬ãƒ™ãƒ«
â€»å¿…è¦ã«å¿œã˜ã¦ ["A", "B"] ã®ã‚ˆã†ã«è¤‡æ•°è¨­å®šã—ã¦ã‚‚æ§‹ã„ã¾ã›ã‚“ã€‚

å‡ºåŠ›ã¯JSONå½¢å¼ã®ã¿ã§ãŠé¡˜ã„ã—ã¾ã™ã€‚è§£èª¬ã¯ä¸è¦ã§ã™ã€‚

[ã“ã“ã«ã‚³ãƒ”ãƒ¼ã—ãŸJSONã‚’è²¼ã‚Šä»˜ã‘]`;
            copyTextToClipboard(text);
            showToast("ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆä¾‹ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼");
        }

        // --- CHART & UPDATE UI ---
        // â˜…ä¿®æ­£ç‰ˆï¼šã€Œæ—¢é‚(initial)ã€ã‚’åˆæœŸé€²æ—ã¨ã—ã¦ã‚°ãƒ©ãƒ•ã«åæ˜ ã•ã›ã‚‹é–¢æ•°
        function updatePaceChart(isChallenge) {
            const chartCanvas = document.getElementById('paceChart');
            if (!chartCanvas) return;

            const labels = [], actual = [], ideal = [], trend = [];
            let start, end;
            const today = getToday();

            let initialPercent = 0;
            // ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°å¯¾è±¡ã®ã‚¢ã‚¤ãƒ†ãƒ ãƒªã‚¹ãƒˆ
            let targetItems = [];
            let totalTargetCount = 0;

            if (appData.currentSubjectId === ALL_SUBJECTS_ID) {
                // å…¨ç§‘ç›®ãƒ¢ãƒ¼ãƒ‰ï¼ˆãƒ•ã‚£ãƒ«ã‚¿éå¯¾å¿œï¼šå¾“æ¥é€šã‚Šhistoryã‚’ä½¿ç”¨ï¼‰
                const dates = new Set();
                getActiveSubjects().forEach(s => {
                    Object.keys(s.history).forEach(d => dates.add(d));
                    if (s.startDate) dates.add(s.startDate);
                });
                dates.add(getTodayStr());
                const sorted = Array.from(dates).sort();
                if (sorted.length === 0) return;
                start = new Date(sorted[0]);

                let maxE = 0;
                getActiveSubjects().forEach(s => { if (s.examDate) maxE = Math.max(maxE, new Date(s.examDate).getTime()); });
                end = maxE > 0 ? new Date(maxE) : null;
                initialPercent = 0;

            } else {
                const s = appData.subjects[appData.currentSubjectId];
                if (!s) return;

                start = s.startDate ? new Date(s.startDate) : getToday();
                end = s.examDate ? new Date(s.examDate) : null;

                if (!isChallenge && s.syllabus && s.syllabus.length > 0) {
                    // â˜…ãƒ•ã‚£ãƒ«ã‚¿é©ç”¨ï¼šç¾åœ¨ã®ãƒ•ã‚£ãƒ«ã‚¿è¨­å®šã‚’å–å¾—ã—ã¦syllabusã‚’çµã‚Šè¾¼ã‚€
                    const filter = getDifficultyFilter(appData.currentSubjectId);
                    targetItems = s.syllabus.filter(u => {
                        // isUnitInFilterç›¸å½“ã®ãƒ­ã‚¸ãƒƒã‚¯ï¼ˆã¾ãŸã¯é–¢æ•°å‘¼ã³å‡ºã—ï¼‰
                        const tags = Array.isArray(u.difficulty) ? u.difficulty : (u.difficulty ? [u.difficulty] : []);
                        if (tags.length === 0) return true; // ã‚¿ã‚°ãªã—ã¯å¸¸ã«å«ã‚ã‚‹
                        return tags.some(t => filter.includes(t));
                    });
                    totalTargetCount = targetItems.length;

                    const startDateStr = formatDate(start);

                    if (totalTargetCount > 0) {
                        // çµã‚Šè¾¼ã¾ã‚ŒãŸä¸­ã§ã®åˆæœŸå®Œäº†æ•°
                        const initialDoneCount = targetItems.filter(u =>
                            u.status === 'completed' &&
                            (u.completedDate === 'initial' || (u.completedDate && u.completedDate <= startDateStr))
                        ).length;
                        initialPercent = Math.round((initialDoneCount / totalTargetCount) * 100);
                    } else {
                        initialPercent = 0;
                    }
                }
            }

            const dispEnd = (end && end > today) ? end : today;
            let cursor = new Date(start);
            let dayIdx = 0;
            const points = [];

            while (cursor <= dispEnd) {
                const dStr = formatDate(cursor);
                labels.push(formatShortDate(cursor));

                if (cursor <= today) {
                    let val = 0;
                    if (isChallenge) {
                        const s = appData.subjects[appData.currentSubjectId];
                        const daysPassed = Math.floor((cursor - new Date(s.startDate)) / 86400000) + 1;
                        let done = 0;
                        for (let k in s.challengeHistory) { if (new Date(k) <= cursor && new Date(k) >= new Date(s.startDate)) done++; }
                        val = daysPassed > 0 ? Math.round((done / daysPassed) * 100) : 0;
                    } else {
                        if (appData.currentSubjectId === ALL_SUBJECTS_ID) {
                            // å…¨ç§‘ç›®ã¯å¾“æ¥é€šã‚Š
                            let total = 0, count = 0;
                            getActiveSubjects().forEach(s => { total += getProgressAt(s, dStr); count++; });
                            val = count > 0 ? Math.round(total / count) : 0;
                        } else {
                            // â˜…å˜ç§‘ç›®ã¯ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°çµæœã‹ã‚‰å‹•çš„ã«è¨ˆç®—
                            if (totalTargetCount > 0) {
                                // ãã®æ—¥ã¾ã§ã«å®Œäº†ã—ãŸã‚¢ã‚¤ãƒ†ãƒ æ•°ï¼ˆçµã‚Šè¾¼ã¿æ¸ˆã¿ãƒªã‚¹ãƒˆã‹ã‚‰ï¼‰
                                const doneCount = targetItems.filter(u =>
                                    u.status === 'completed' &&
                                    (u.completedDate === 'initial' || (u.completedDate && u.completedDate <= dStr))
                                ).length;
                                val = Math.round((doneCount / totalTargetCount) * 100);
                            } else {
                                val = 0;
                            }
                        }
                        if (val < initialPercent) val = initialPercent;
                        points.push({ x: dayIdx, y: val });
                    }
                    actual.push(val);
                } else {
                    actual.push(null);
                }

                if (!isChallenge && end) {
                    const totalDays = (end - start) / 86400000;
                    const passed = (cursor - start) / 86400000;
                    if (totalDays > 0) {
                        const idealVal = initialPercent + (100 - initialPercent) * (passed / totalDays);
                        ideal.push(Math.min(100, idealVal));
                    } else {
                        ideal.push(100);
                    }
                } else {
                    ideal.push(null);
                }

                cursor.setDate(cursor.getDate() + 1);
                dayIdx++;
            }

            if (!isChallenge) {
                // â˜…ä¿®æ­£: ç›´è¿‘14æ—¥é–“ã®ãƒ‡ãƒ¼ã‚¿ã§ãƒˆãƒ¬ãƒ³ãƒ‰ã‚’è¨ˆç®—
                const validPoints = points.filter(p => !isNaN(p.y));
                const recentPoints = validPoints.slice(-14); // ç›´è¿‘14å€‹
                let res = null;

                if (recentPoints.length >= 2) {
                    // ç›´è¿‘ãƒ‡ãƒ¼ã‚¿ã®xåº§æ¨™ã‚’0èµ·ç‚¹ã«æ­£è¦åŒ–ã›ãšã€ãã®ã¾ã¾è¨ˆç®—ã—ã¦å…¨ä½“ã®ãƒˆãƒ¬ãƒ³ãƒ‰ã«ä¹—ã›ã‚‹
                    res = calculateLeastSquares(recentPoints);
                } else if (validPoints.length >= 2) {
                    res = calculateLeastSquares(validPoints); // ãƒ‡ãƒ¼ã‚¿ä¸è¶³ãªã‚‰å…¨æœŸé–“
                }

                if (res) {
                    // ãƒˆãƒ¬ãƒ³ãƒ‰ãƒ©ã‚¤ãƒ³æç”»
                    for (let i = 0; i < labels.length; i++) {
                        trend.push(Math.max(0, Math.min(100, res.slope * i + res.intercept)));
                    }

                    // â˜…è¿½åŠ : å®Œäº†äºˆæ¸¬æ—¥ã®è¨ˆç®—ã¨è¡¨ç¤º
                    if (res.slope > 0) {
                        const daysToFinish = (100 - res.intercept) / res.slope;
                        const finishDate = new Date(start);
                        finishDate.setDate(finishDate.getDate() + Math.ceil(daysToFinish));

                        // ã‚ã¾ã‚Šã«é ã„æœªæ¥ï¼ˆ10å¹´ä»¥ä¸Šå…ˆï¼‰ã¯è¡¨ç¤ºã—ãªã„
                        const maxDate = new Date(); maxDate.setFullYear(maxDate.getFullYear() + 5);

                        if (finishDate > maxDate) {
                            document.getElementById('predicted-finish-date').textContent = 'äºˆæ¸¬å®Œäº†: æœªå®š (ãƒšãƒ¼ã‚¹ä¸è¶³)';
                        } else if (daysToFinish < 0) {
                            document.getElementById('predicted-finish-date').textContent = 'äºˆæ¸¬å®Œäº†: é”æˆæ¸ˆã¿';
                        } else {
                            document.getElementById('predicted-finish-date').textContent = `äºˆæ¸¬å®Œäº†: ${formatDate(finishDate)}`;
                        }
                    } else {
                        document.getElementById('predicted-finish-date').textContent = 'äºˆæ¸¬å®Œäº†: -- (ãƒšãƒ¼ã‚¹åœæ»ä¸­)';
                    }
                }
            }

            paceChart.data.labels = labels;
            paceChart.data.datasets[0].data = ideal;
            paceChart.data.datasets[1].data = actual;
            paceChart.data.datasets[2].data = trend;

            // â˜…è¿½åŠ : é ‘å¼µã£ãŸæ—¥ï¼ˆé€²æ—ãŒå¢—ãˆãŸæ—¥ï¼‰ã®ãƒã‚¤ãƒ³ãƒˆã‚µã‚¤ã‚ºã‚’å¤§ããã™ã‚‹
            const pointRadii = actual.map((val, idx) => {
                if (idx === 0) return 2;
                const prev = actual[idx - 1];
                if (val !== null && prev !== null && val > prev) return 4; // å¢—ãˆãŸæ—¥ã¯å¤§ãã
                return 0; // å¢—ãˆã¦ãªã„æ—¥ã¯ç‚¹ã‚’æ¶ˆã™ï¼ˆç·šã®ã¿ï¼‰
            });
            paceChart.data.datasets[1].pointRadius = pointRadii;
            paceChart.data.datasets[1].pointHoverRadius = pointRadii.map(r => r > 0 ? r + 2 : 0);
            // èƒŒæ™¯è‰²ã‚‚å¼·èª¿ãƒã‚¤ãƒ³ãƒˆã ã‘æ¿ƒãã™ã‚‹è¨­å®šãªã©ã¯Datasetå…¨ä½“è¨­å®šãªã®ã§é›£ã—ã„ã€Radiusã ã‘ã§ååˆ†ç›®ç«‹ã¤ã¯ãš

            // â˜…ä¿®æ­£ï¼šãƒ©ã‚¤ãƒˆãƒ¢ãƒ¼ãƒ‰æ™‚ã®ã‚°ãƒ©ãƒ•è‰²èª¿æ•´
            const isLight = document.documentElement.classList.contains('light-mode');
            paceChart.data.datasets[0].borderColor = isLight ? '#0284c7' : '#38bdf8'; // ç›®æ¨™(é’)
            paceChart.data.datasets[2].borderColor = isLight ? '#ea580c' : '#f97316'; // äºˆæ¸¬(ã‚ªãƒ¬ãƒ³ã‚¸)

            paceChart.data.datasets[1].borderColor = isChallenge ? '#fbbf24' : '#10b981';
            paceChart.data.datasets[1].backgroundColor = isChallenge ? 'rgba(251, 191, 36, 0.1)' : 'rgba(16, 185, 129, 0.1)';

            paceChart.update();
        }
        function updateUI() {
            refreshSubjectSelectUI();
            updateHeaderDate();
            updateExamDaysDisplay();

            const isLight = document.documentElement.classList.contains('light-mode');
            // â˜…ä¿®æ­£ï¼šãƒ©ã‚¤ãƒˆãƒ¢ãƒ¼ãƒ‰ã®å††ã‚°ãƒ©ãƒ•èƒŒæ™¯ã‚’å°‘ã—æ¿ƒãã—ã¦è¦–èªæ€§ã‚¢ãƒƒãƒ—
            const circleBgColor = isLight ? '#cbd5e1' : '#1e293b';

            const isChallenge = appData.currentSubjectId !== ALL_SUBJECTS_ID && appData.subjects[appData.currentSubjectId]?.type === 'challenge';
            let percentage = 0;

            document.getElementById('current-subject-name-display').textContent = `è¡¨ç¤ºä¸­: ${appData.currentSubjectId === ALL_SUBJECTS_ID ? 'ç·åˆ' : appData.subjects[appData.currentSubjectId].name}`;
            document.getElementById('streak-count-header').textContent = '';
            document.getElementById('streak-count-mobile').textContent = '';
            document.getElementById('map-title').textContent = isChallenge ? 'æœˆåˆ¥é”æˆåº¦' : 'å˜å…ƒãƒãƒƒãƒ—';
            document.getElementById('map-legend').style.display = isChallenge ? 'none' : 'flex';
            document.getElementById('map-legend').style.display = isChallenge ? 'none' : 'flex';
            document.getElementById('progress-label').textContent = isChallenge ? 'å®Ÿæ–½ç‡' : 'é€²æ—ç‡';
            document.getElementById('predicted-finish-date').textContent = '';

            if (isChallenge) {
                document.getElementById('category-progress-section').classList.add('hidden');
                document.getElementById('difficulty-filter-area').classList.add('hidden');
                const subj = appData.subjects[appData.currentSubjectId]; const stats = calculateChallengeStats(subj);
                percentage = stats.percentage;
                const streakText = stats.currentStreak === 0 ? getStreakMessage(0) : `${stats.currentStreak}æ—¥é€£ç¶šç¶™ç¶šä¸­ï¼ ${getStreakMessage(stats.currentStreak)}`;
                document.getElementById('streak-count-header').textContent = streakText;
                document.getElementById('streak-count-mobile').textContent = streakText;
                renderMonthHeatmap(subj);
                progressCircleChart.data.datasets[0].backgroundColor = ['#fbbf24', circleBgColor];
                progressCircleChart.data.datasets[0].data = [percentage, 100 - percentage];
            } else {
                renderSlitBar();
                // é›£æ˜“åº¦ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼UIæç”»
                renderDifficultyFilter();
                const syl = getCurrentSyllabus();
                // é›£æ˜“åº¦ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼é©ç”¨
                const subjId = appData.currentSubjectId;
                const filtered = (subjId !== ALL_SUBJECTS_ID) ? syl.filter(u => isUnitInFilter(u, subjId)) : syl;
                // ã‚«ãƒ†ã‚´ãƒªåˆ¥é€²æ—ãƒãƒ¼æç”»ï¼ˆãƒ•ã‚£ãƒ«ã‚¿ãƒ¼é©ç”¨æ¸ˆã¿ï¼‰
                renderCategoryProgress(filtered);
                const total = filtered.length;
                if (total > 0) {
                    const completedNormal = filtered.filter(u => u.status === 'completed' && !u.isWeak).length;
                    const completedWeak = filtered.filter(u => u.status === 'completed' && u.isWeak).length;
                    percentage = Math.round(((completedNormal + completedWeak) / total) * 100);
                    const pNormal = Math.round((completedNormal / total) * 100);
                    const pWeak = Math.round((completedWeak / total) * 100);
                    const pRemaining = 100 - pNormal - pWeak;
                    progressCircleChart.data.datasets[0].backgroundColor = ['#10b981', '#fbbf24', circleBgColor];
                    progressCircleChart.data.datasets[0].data = [pNormal, pWeak, pRemaining];
                } else {
                    percentage = 0;
                    progressCircleChart.data.datasets[0].backgroundColor = ['#10b981', circleBgColor];
                    progressCircleChart.data.datasets[0].data = [0, 100];
                }
            }

            document.getElementById('total-progress-text').textContent = `${percentage}%`;
            progressCircleChart.update();

            renderRecordLists(); renderCalendar(); updatePaceChart(isChallenge); renderSleepChart(); loadSleepLogDate();
            if (document.getElementById('manage-screen').classList.contains('active')) renderManageScreen();
            document.body.style.opacity = 1;
        }

        const progressCircleChart = new Chart(document.getElementById('progressCircleChart').getContext('2d'), { type: 'doughnut', data: { datasets: [{ data: [0, 100], backgroundColor: ['#10b981', '#1e293b'], borderWidth: 0, cutout: '85%' }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false }, tooltip: { enabled: false } } } });
        const paceChart = new Chart(document.getElementById('paceChart').getContext('2d'), { type: 'line', data: { labels: [], datasets: [{ label: 'ç›®æ¨™', data: [], borderColor: '#38bdf8', borderWidth: 1, borderDash: [5, 5], pointRadius: 0, fill: false }, { label: 'å®Ÿç¸¾', data: [], borderColor: '#10b981', backgroundColor: 'rgba(16, 185, 129, 0.1)', borderWidth: 2, pointRadius: 2, fill: true, spanGaps: true }, { label: 'äºˆæ¸¬', data: [], borderColor: '#f97316', borderWidth: 2, borderDash: [2, 2], pointRadius: 0, fill: false }] }, options: { responsive: true, maintainAspectRatio: false, scales: { x: { grid: { color: '#334155' }, ticks: { color: '#64748b', font: { size: 9 }, maxTicksLimit: 6 } }, y: { min: 0, max: 100, grid: { color: '#334155' }, ticks: { color: '#64748b', font: { size: 9 } } } }, plugins: { legend: { labels: { color: '#94a3b8', font: { size: 10 }, boxWidth: 10 } } } } });

        function updateChartColors() {
            const isLight = document.documentElement.classList.contains('light-mode');
            const gridColor = isLight ? '#cbd5e1' : '#334155';
            const textColor = isLight ? '#64748b' : '#94a3b8';

            if (paceChart && paceChart.options) {
                paceChart.options.scales.x.grid.color = gridColor;
                paceChart.options.scales.y.grid.color = gridColor;
                paceChart.options.scales.x.ticks.color = textColor;
                paceChart.options.scales.y.ticks.color = textColor;
                paceChart.options.plugins.legend.labels.color = textColor;
                paceChart.update();
            }
        }

        // --- Sleep Rhythm Logic ---
        let sleepChartRange = 7;

        function loadSleepLogDate() {
            const dateInput = document.getElementById('sleep-log-date');
            if (!dateInput.value) dateInput.value = getTodayStr(); // åˆæœŸå€¤ã‚»ãƒƒãƒˆ
            const dateStr = dateInput.value;

            const log = (appData.sleepLog && appData.sleepLog[dateStr]) || { wake: '', bed: '' };
            document.getElementById('sleep-log-wake').value = log.wake || '';

            // allnighter or normal bed
            const bedInput = document.getElementById('sleep-log-bed');
            const nextDayCheckbox = document.getElementById('sleep-log-nextday');
            if (log.bed === 'allnighter') {
                bedInput.value = '';
                bedInput.disabled = true;
                bedInput.style.opacity = '0.3';
                nextDayCheckbox.checked = false;
                nextDayCheckbox.disabled = true;
            } else {
                bedInput.value = log.bed || '';
                bedInput.disabled = false;
                bedInput.style.opacity = '1';
                nextDayCheckbox.checked = !!log.bedNextDay;
                nextDayCheckbox.disabled = false;
            }
            updateBedNextDayLabel();
        }

        function updateBedNextDayLabel() {
            const cb = document.getElementById('sleep-log-nextday');
            const track = document.getElementById('sleep-log-nextday-track');
            const thumb = document.getElementById('sleep-log-nextday-thumb');
            const text = document.getElementById('sleep-log-nextday-text');
            if (cb.checked) {
                track.style.backgroundColor = '#7c3aed';
                thumb.style.left = '14px';
                thumb.style.backgroundColor = '#fff';
                text.style.color = '#c084fc';
            } else {
                track.style.backgroundColor = '#374151';
                thumb.style.left = '2px';
                thumb.style.backgroundColor = '#9ca3af';
                text.style.color = '#6b7280';
            }
        }

        function shiftSleepLogDate(diff) {
            const dateInput = document.getElementById('sleep-log-date');
            if (!dateInput.value) dateInput.value = getTodayStr();

            const current = new Date(dateInput.value);
            current.setDate(current.getDate() + diff);
            dateInput.value = formatDate(current);
            loadSleepLogDate();
        }

        function saveSleepLog(type) {
            const dateStr = document.getElementById('sleep-log-date').value;
            if (!dateStr) return;

            if (!appData.sleepLog) appData.sleepLog = {};
            if (!appData.sleepLog[dateStr]) appData.sleepLog[dateStr] = { wake: '', bed: '' };

            let msg = "";
            let updatedVal = "";

            if (type === 'wake') {
                const val = document.getElementById('sleep-log-wake').value;
                appData.sleepLog[dateStr].wake = val;
                msg = "èµ·åºŠæ™‚é–“ã‚’è¨˜éŒ²ã—ã¾ã—ãŸ";
                updatedVal = val;
            } else if (type === 'bed') {
                const val = document.getElementById('sleep-log-bed').value;
                const nextDay = document.getElementById('sleep-log-nextday').checked;
                appData.sleepLog[dateStr].bed = val;
                appData.sleepLog[dateStr].bedNextDay = nextDay;
                msg = nextDay ? `å°±å¯æ™‚é–“ã‚’è¨˜éŒ²ã—ã¾ã—ãŸ (ç¿Œæ—¥ ${val})` : "å°±å¯æ™‚é–“ã‚’è¨˜éŒ²ã—ã¾ã—ãŸ";
                updatedVal = val;
            } else if (type === 'allnighter') {
                appData.sleepLog[dateStr].bed = 'allnighter';
                delete appData.sleepLog[dateStr].bedNextDay;
                msg = "ã‚ªãƒ¼ãƒ«ï¼ˆå¾¹å¤œï¼‰ã‚’è¨˜éŒ²ã—ã¾ã—ãŸ";
                // UIã‚’æ›´æ–°
                document.getElementById('sleep-log-bed').value = '';
                document.getElementById('sleep-log-bed').disabled = true;
                document.getElementById('sleep-log-bed').style.opacity = '0.3';
                document.getElementById('sleep-log-nextday').checked = false;
                document.getElementById('sleep-log-nextday').disabled = true;
                updateBedNextDayLabel();
            } else {
                // fallback for old calls (though now separate buttons)
                appData.sleepLog[dateStr].wake = document.getElementById('sleep-log-wake').value;
                appData.sleepLog[dateStr].bed = document.getElementById('sleep-log-bed').value;
                msg = "è¨˜éŒ²ã—ã¾ã—ãŸ";
            }

            // è‡ªå‹•ãƒã‚§ãƒƒã‚¯åˆ¤å®š
            // typeæŒ‡å®šãŒã‚ã‚‹å ´åˆã¯ã€ãã‚Œã«é–¢é€£ã™ã‚‹ãƒã‚§ãƒƒã‚¯ã®ã¿è¡Œã†ã®ãŒåŠ¹ç‡çš„ã ãŒ
            // æ—¢å­˜é–¢æ•°ã¯ä¸¡æ–¹ãƒã‚§ãƒƒã‚¯ã™ã‚‹ã®ã§ãã®ã¾ã¾åˆ©ç”¨ï¼ˆå‰¯ä½œç”¨ã¯ãªã„ï¼‰
            checkSleepLogAutoChallenge(dateStr, appData.sleepLog[dateStr].wake, appData.sleepLog[dateStr].bed);

            saveData();
            renderSleepChart();
            showToast(msg);
        }

        function checkSleepLogAutoChallenge(dateStr, wake, bed) {
            const challenges = getActiveChallenges();
            let updated = false;

            challenges.forEach(c => {
                if (!c.autoCheckType || !c.autoCheckTime) return;

                let achieved = false;

                if (c.autoCheckType === 'waketime' && wake) {
                    const wakeMin = timeToMinutes(wake);
                    const targetMin = timeToMinutes(c.autoCheckTime);
                    if (wakeMin <= targetMin) achieved = true;
                } else if (c.autoCheckType === 'bedtime' && bed && bed !== 'allnighter') {
                    const bedLog = appData.sleepLog && appData.sleepLog[dateStr];
                    const bedMin = timeToMinutes(bed, true, bedLog && bedLog.bedNextDay);
                    const targetMin = timeToMinutes(c.autoCheckTime, true);
                    if (bedMin <= targetMin) achieved = true;
                }

                if (achieved) {
                    if (!c.challengeHistory) c.challengeHistory = {};
                    if (!c.challengeHistory[dateStr]) {
                        c.challengeHistory[dateStr] = true;
                        updated = true;
                    }
                }
            });

            if (updated) {
                renderChallengeScreen(); // Update the challenge table immediately
                showToast("ç›®æ¨™é”æˆï¼ãƒãƒ£ãƒ¬ãƒ³ã‚¸ã‚’æ›´æ–°ã—ã¾ã—ãŸ");
            }
        }

        function timeToMinutes(timeStr, isBedtime = false, bedNextDay = false) {
            if (!timeStr || timeStr === 'allnighter') return 9999;
            const [h, m] = timeStr.split(':').map(Number);
            let total = h * 60 + m;
            if (bedNextDay) {
                // æ˜ç¤ºçš„ã«ã€Œç¿Œæ—¥ã€ãƒˆã‚°ãƒ«ãŒONã®å ´åˆã€å¸¸ã«+24æ™‚é–“
                total += 24 * 60;
            } else if (isBedtime && h < 4) {
                // å¾Œæ–¹äº’æ›: 00:00-03:59 ã¯è‡ªå‹•ã§ç¿Œæ—¥æ‰±ã„
                total += 24 * 60;
            }
            return total;
        }

        function changeSleepChartRange(days) {
            sleepChartRange = days;
            // ãƒœã‚¿ãƒ³ã®è¦‹ãŸç›®æ›´æ–°
            document.querySelectorAll('.chart-range-btn').forEach(btn => {
                if (parseInt(btn.dataset.range) === days) {
                    btn.classList.remove('text-gray-400', 'hover:bg-gray-800');
                    btn.classList.add('bg-gray-700', 'text-white');
                } else {
                    btn.classList.add('text-gray-400', 'hover:bg-gray-800');
                    btn.classList.remove('bg-gray-700', 'text-white');
                }
            });
            renderSleepChart();
        }

        function renderSleepChart() {
            const svg = document.getElementById('sleep-chart-svg');
            if (!svg) return;
            svg.innerHTML = '';

            const today = getToday();
            const days = [];

            // Xè»¸: æ—¥ä»˜ (å·¦ãŒéå»ã€å³ãŒä»Šæ—¥)
            for (let i = sleepChartRange - 1; i >= 0; i--) {
                const d = new Date(today);
                d.setDate(d.getDate() - i);
                days.push(formatDate(d));
            }

            // æç”»ã‚µã‚¤ã‚ºå®šæ•°
            const width = svg.clientWidth || 300;
            const height = svg.clientHeight || 150;
            const padding = { top: 20, right: 10, bottom: 20, left: 30 };
            const chartW = width - padding.left - padding.right;
            const chartH = height - padding.top - padding.bottom;

            // Yè»¸ã‚¹ã‚±ãƒ¼ãƒ«: å‰æ—¥18:00 (-360) ï½ å½“æ—¥24:00 (1440)
            // ã“ã‚Œã«ã‚ˆã‚Š 0:00 ãŒä¸­å¤®ã‚„ã‚„ä¸Šã«æ¥ã¦ã€ç¡çœ (å¤œã€œæœ)ãŒé€£ç¶šã—ã¦è¡¨ç¤ºã•ã‚Œã‚‹
            // ç¿Œæ—¥ãƒˆã‚°ãƒ«å¯¾å¿œã®ãŸã‚ä¸Šé™ã‚’18æ™‚â†’24æ™‚ã«æ‹¡å¼µ
            const minMin = -360;
            const maxMin = 1440;
            const rangeMin = maxMin - minMin;

            // æ™‚åˆ»æ–‡å­—åˆ—ã‚’åˆ†ã«å¤‰æ› (0:00åŸºæº–)
            // isPrevBed: å‰æ—¥ã®å°±å¯æ™‚é–“ã‹ã©ã†ã‹
            // bedNextDay: ç¿Œæ—¥ãƒˆã‚°ãƒ«ãŒONã‹ã©ã†ã‹
            const getMinutes = (timeStr, isPrevBed, bedNextDay) => {
                if (!timeStr || timeStr === 'allnighter') return null;
                const [h, m] = timeStr.split(':').map(Number);
                let total = h * 60 + m;

                if (isPrevBed) {
                    if (bedNextDay) {
                        // æ˜ç¤ºçš„ã«ç¿Œæ—¥æŒ‡å®š: ãã®ã¾ã¾ï¼ˆå½“æ—¥ã®æ™‚åˆ»ã¨ã—ã¦ãƒ—ãƒ­ãƒƒãƒˆï¼‰
                        // ä¾‹: bedNextDay ON ã§ 05:00 â†’ å½“æ—¥ã®05:00 (300åˆ†)
                    } else if (total > 720) {
                        // 12:00ä»¥å¾Œã¯å‰æ—¥æ‰±ã„ï¼ˆå¾“æ¥ãƒ­ã‚¸ãƒƒã‚¯ï¼‰
                        total -= 1440;
                    }
                    // 12:00ä»¥å‰(åˆå‰ä¸­)ã¯ãã®ã¾ã¾ï¼ˆæ·±å¤œå°±å¯ï¼‰
                } else {
                    // å½“æ—¥ã®èµ·åºŠæ™‚é–“
                    // ãã®ã¾ã¾
                }
                return total;
            };

            const getY = (min) => {
                if (min === null) return null;
                if (min < minMin || min > maxMin) return null;
                const percent = (min - minMin) / rangeMin;
                return padding.top + (percent * chartH);
            };

            const getX = (idx) => {
                const colWidth = chartW / days.length;
                return padding.left + (idx * colWidth) + (colWidth / 2);
            };

            // ã‚³ãƒ©ãƒ å¹…
            const colWidth = chartW / days.length;

            // --- 1. æ™‚é–“ã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³ (æ¨ªç·š) - 3æ™‚é–“ã”ã¨ ---
            // -360(18), -180(21), 0(0), 180(3), 360(6), 540(9), 720(12), 900(15), 1080(18)
            for (let m = minMin; m <= maxMin; m += 180) {
                const y = getY(m);
                if (y === null) continue;

                // 24æ™‚ã¯0æ™‚è¡¨è¨˜ã€ãã‚Œä»¥å¤–ã¯æ™‚åˆ»
                let labelHour = Math.floor(m / 60);
                if (labelHour < 0) labelHour += 24;
                if (labelHour >= 24) labelHour -= 24;

                const isZero = (m === 0);

                // line
                const line = document.createElementNS("http://www.w3.org/2000/svg", "line");
                line.setAttribute("x1", padding.left);
                line.setAttribute("y1", y);
                line.setAttribute("x2", width - padding.right);
                line.setAttribute("y2", y);
                line.setAttribute("stroke", isZero ? "#64748b" : "#334155");
                line.setAttribute("stroke-width", "1");
                if (!isZero) line.setAttribute("stroke-dasharray", "2 2");
                svg.appendChild(line);

                // label
                const txt = document.createElementNS("http://www.w3.org/2000/svg", "text");
                txt.setAttribute("x", padding.left - 5);
                txt.setAttribute("y", y + 3);
                txt.setAttribute("text-anchor", "end");
                txt.setAttribute("fill", isZero ? "#cbd5e1" : "#64748b");
                txt.setAttribute("font-size", "8");
                txt.textContent = String(labelHour);
                svg.appendChild(txt);
            }

            // --- 2. æ—¥ä»˜ã‚°ãƒªãƒƒãƒ‰ (ç¸¦ç·š) & ãƒ‡ãƒ¼ã‚¿ãƒ—ãƒ­ãƒƒãƒˆ ---
            const barWidth = Math.max(2, colWidth * 0.7);

            days.forEach((dStr, idx) => {
                const xCenter = getX(idx);
                const xLeft = padding.left + (idx * colWidth);

                // ç¸¦ã‚°ãƒªãƒƒãƒ‰ç·š
                const vLine = document.createElementNS("http://www.w3.org/2000/svg", "line");
                vLine.setAttribute("x1", xLeft);
                vLine.setAttribute("y1", padding.top);
                vLine.setAttribute("x2", xLeft);
                vLine.setAttribute("y2", height - padding.bottom);
                vLine.setAttribute("stroke", "#1e293b");
                vLine.setAttribute("stroke-width", "1");
                svg.appendChild(vLine);

                // å³ç«¯ã®é–‰ã˜ç·š
                if (idx === days.length - 1) {
                    const xRight = padding.left + ((idx + 1) * colWidth);
                    const vLineR = document.createElementNS("http://www.w3.org/2000/svg", "line");
                    vLineR.setAttribute("x1", xRight);
                    vLineR.setAttribute("y1", padding.top);
                    vLineR.setAttribute("x2", xRight);
                    vLineR.setAttribute("y2", height - padding.bottom);
                    vLineR.setAttribute("stroke", "#1e293b");
                    vLineR.setAttribute("stroke-width", "1");
                    svg.appendChild(vLineR);
                }

                // æ—¥ä»˜ãƒ©ãƒ™ãƒ«
                const showLabel = (sleepChartRange <= 14) || (idx % 3 === 0);

                if (showLabel) {
                    const dObj = new Date(dStr);
                    const txt = document.createElementNS("http://www.w3.org/2000/svg", "text");
                    txt.setAttribute("x", xCenter);
                    txt.setAttribute("y", height - 5);
                    txt.setAttribute("text-anchor", "middle");
                    txt.setAttribute("fill", "#94a3b8");
                    txt.setAttribute("font-size", "8");
                    txt.textContent = `${dObj.getMonth() + 1}/${dObj.getDate()}`;
                    svg.appendChild(txt);
                }

                // ãƒ‡ãƒ¼ã‚¿ãƒ—ãƒ­ãƒƒãƒˆ
                const logCurr = (appData.sleepLog && appData.sleepLog[dStr]);

                const dObj = new Date(dStr);
                const prevD = new Date(dObj);
                prevD.setDate(prevD.getDate() - 1);
                const prevStr = formatDate(prevD);
                const logPrev = (appData.sleepLog && appData.sleepLog[prevStr]);

                // ã‚ªãƒ¼ãƒ«ï¼ˆå¾¹å¤œï¼‰ã®å ´åˆã¯Ã—å°ã‚’è¡¨ç¤º
                const prevIsAllnighter = logPrev && logPrev.bed === 'allnighter';
                if (prevIsAllnighter) {
                    // ã‚ªãƒ¼ãƒ«è¡¨ç¤º: Ã—å°
                    const allTxt = document.createElementNS("http://www.w3.org/2000/svg", "text");
                    allTxt.setAttribute("x", xCenter);
                    allTxt.setAttribute("y", padding.top + chartH * 0.35);
                    allTxt.setAttribute("text-anchor", "middle");
                    allTxt.setAttribute("dominant-baseline", "middle");
                    allTxt.setAttribute("fill", "#fb923c");
                    allTxt.setAttribute("font-size", "10");
                    allTxt.setAttribute("opacity", "0.7");
                    allTxt.textContent = "å¾¹å¤œ";
                    svg.appendChild(allTxt);
                }

                if ((logCurr || logPrev) && !prevIsAllnighter) {
                    const minBed = logPrev && logPrev.bed && logPrev.bed !== 'allnighter'
                        ? getMinutes(logPrev.bed, true, logPrev.bedNextDay) : null;
                    const minWake = logCurr ? getMinutes(logCurr.wake, false) : null;

                    const yBed = getY(minBed);
                    const yWake = getY(minWake);

                    if (yBed !== null && yWake !== null && yWake > yBed) {
                        const rect = document.createElementNS("http://www.w3.org/2000/svg", "rect");
                        rect.setAttribute("x", xCenter - barWidth / 2);
                        rect.setAttribute("y", yBed);
                        rect.setAttribute("width", barWidth);
                        rect.setAttribute("height", yWake - yBed);
                        rect.setAttribute("rx", "1");
                        rect.setAttribute("fill", "rgba(139, 92, 246, 0.5)");
                        rect.setAttribute("stroke", "none");
                        svg.appendChild(rect);
                    }

                    const drawPoint = (y, color) => {
                        if (y === null) return;
                        const circle = document.createElementNS("http://www.w3.org/2000/svg", "circle");
                        circle.setAttribute("cx", xCenter);
                        circle.setAttribute("cy", y);
                        circle.setAttribute("r", "2.5");
                        circle.setAttribute("fill", color);
                        circle.setAttribute("stroke", "#1e293b");
                        circle.setAttribute("stroke-width", "1");
                        svg.appendChild(circle);
                    };

                    drawPoint(yWake, "#facc15"); // é»„è‰² (èµ·åºŠ)
                    drawPoint(yBed, "#c084fc");   // ç´«è‰² (å°±å¯)
                }
            });
        }

        // åˆæœŸåŒ–æ™‚ã«å‘¼ã¶
        // updateUIã®æœ€å¾Œã« renderSleepChart() ã‚’è¿½åŠ ã™ã‚‹å¿…è¦ãŒã‚ã‚‹


        // ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆè¨­å®š
        document.querySelectorAll('.nav-btn').forEach(btn => {
            btn.onclick = () => {
                if (btn.dataset.target) {
                    switchTab(btn.dataset.target);
                }
            };
        });

        document.getElementById('record-prev-day').onclick = () => { currentRecordDate.setDate(currentRecordDate.getDate() - 1); renderRecordLists(); };
        document.getElementById('record-next-day').onclick = () => { currentRecordDate.setDate(currentRecordDate.getDate() + 1); renderRecordLists(); };
        // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã®æœˆç§»å‹•ã‚¤ãƒ™ãƒ³ãƒˆã‚’å†è¨­å®š
        document.addEventListener('click', (e) => {
            if (e.target.closest('#prev-month')) {
                currentCalendarDate.setMonth(currentCalendarDate.getMonth() - 1);
                renderCalendar();
            }
            if (e.target.closest('#next-month')) {
                currentCalendarDate.setMonth(currentCalendarDate.getMonth() + 1);
                renderCalendar();
            }
        });
        // â˜…è¿½åŠ ï¼šãƒ†ãƒ¼ãƒåˆ‡ã‚Šæ›¿ãˆæ©Ÿèƒ½
        function toggleTheme() {
            const html = document.documentElement;
            const isLight = html.classList.toggle('light-mode');

            updateThemeBtn(isLight);
            updateChartColors();

            // è¨­å®šã‚’ä¿å­˜
            localStorage.setItem('app_theme', isLight ? 'light' : 'dark');
        }

        function updateThemeBtn(isLight) {
            const btn = document.getElementById('theme-toggle-btn');
            if (btn) {
                if (isLight) {
                    btn.innerHTML = '<i class="fas fa-sun text-orange-400"></i> <span class="text-gray-600">ãƒ©ã‚¤ãƒˆãƒ¢ãƒ¼ãƒ‰ä¸­</span>';
                    btn.classList.replace('bg-gray-700', 'bg-gray-200');
                    btn.classList.replace('text-white', 'text-gray-600');
                } else {
                    btn.innerHTML = '<i class="fas fa-moon text-yellow-300"></i> <span>ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰ä¸­</span>';
                    btn.classList.replace('bg-gray-200', 'bg-gray-700');
                    btn.classList.replace('text-gray-600', 'text-white');
                }
            }
        }

        // èµ·å‹•æ™‚ã«ä¿å­˜ã•ã‚ŒãŸãƒ†ãƒ¼ãƒã‚’é©ç”¨
        (function initTheme() {
            const savedTheme = localStorage.getItem('app_theme');
            if (savedTheme === 'light') {
                document.documentElement.classList.add('light-mode');
            }
            // ãƒœã‚¿ãƒ³ã®è¡¨ç¤ºã¯HTMLèª­ã¿è¾¼ã¿å¾Œã«è¡Œã†ãŸã‚ã€window.onloadç­‰ã§å†åº¦å‘¼ã¶ã‹ã€
            // è¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã„ãŸæ™‚ã«æ›´æ–°ã™ã‚‹ã‚ˆã†ã«ã—ã¾ã™
        })();
        document.addEventListener('DOMContentLoaded', () => {
            // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ç”»é¢ã®åˆ¶å¾¡
            // å°‘ã—ã ã‘å¾…ã£ã¦ã‹ã‚‰ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¢ã‚¦ãƒˆã•ã›ã‚‹ï¼ˆã¡ã‚‰ã¤ãé˜²æ­¢ & åˆæœŸå‡¦ç†å¾…ã¡ï¼‰
            setTimeout(() => {
                const loader = document.getElementById('initial-loader');
                if (loader) {
                    loader.style.opacity = '0';
                    setTimeout(() => loader.remove(), 500);
                }
            }, 500);

            // ãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹ã®ç›£è¦–ã‚’å°‘ã—ä¸å¯§ã«
            // Firebaseã®èª­ã¿è¾¼ã¿ã‚’å¾…ã¤å¿…è¦ãŒã‚ã‚‹ãŸã‚ã€setIntervalã§ãƒã‚§ãƒƒã‚¯ã™ã‚‹ã‹ã€
            // deferã—ã¦ã„ã‚‹ã®ã§DOMContentLoadedæ™‚ã«ã¯firebaseå¤‰æ•°ãŒä½¿ãˆã‚‹ã¯ãšã ãŒã€
            // å®‰å…¨ã®ãŸã‚try-catchã§å›²ã‚€ã‹ã€å­˜åœ¨ãƒã‚§ãƒƒã‚¯ã‚’è¡Œã†
            const initFirebase = () => {
                if (typeof firebase === 'undefined') {
                    setTimeout(initFirebase, 100);
                    return;
                }

                firebase.auth().onAuthStateChanged((user) => {
                    const modal = document.getElementById('login-modal');
                    if (user) {
                        currentUserDocId = user.uid;
                        modal.classList.add('hidden');
                        // ãƒ­ã‚°ã‚¤ãƒ³ãŒç¢ºå®šã—ã¦ã‹ã‚‰é€šä¿¡ã‚’é–‹å§‹ã™ã‚‹
                        startListening();
                        //syncFromGoogleTasks(); // â˜…è‡ªå‹•åŒæœŸã—ãŸã„å ´åˆã¯ã“ã®è¡ŒãŒå¿…è¦ã§ã™ï¼
                    } else {
                        currentUserDocId = null;
                        modal.classList.remove('hidden');
                    }
                });
            };
            initFirebase();

            updateChartColors();
            updateChartColors(); // é‡è¤‡ã—ã¦ã„ã‚‹ãŒå…ƒã®ã‚³ãƒ¼ãƒ‰é€šã‚Šæ®‹ã™
            initStudyTimeSelects(); // â˜…è¿½åŠ : ã‚»ãƒ¬ã‚¯ãƒˆãƒœãƒƒã‚¯ã‚¹åˆæœŸåŒ–
            // ã‚¢ã‚³ãƒ¼ãƒ‡ã‚£ã‚ªãƒ³ã®åˆæœŸçŠ¶æ…‹ã‚’è¨­å®šï¼ˆç›´è¿‘ã§é–‹ã„ã¦ã„ãŸã‚‚ã®ã‚’è¨˜æ†¶ã—ã¦ã‚‚è‰¯ã„ãŒã€ä¸€æ—¦ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯é–‰ã˜ã¦ãŠãã‹ã€æœ€åˆã ã‘é–‹ãï¼‰
            // ã‚¿ãƒ–ã®åˆæœŸè¡¨ç¤º
            switchHabitTab('tab-habit-check');
        });

        // --- Global Data Migration ---
        function getBlankData() {
            return {
                subjects: JSON.parse(JSON.stringify(defaultSubjects)),
                schedules: {},
                currentSubjectId: 'chemistry', // åˆæœŸé¸æŠã¯åŒ–å­¦
                sleepLog: {},
                studyLog: {}, // â˜…è¿½åŠ 
                ticker: JSON.parse(JSON.stringify(defaultTicker))
            };
        }

        // --- Tab Logic ---
        function switchHabitTab(tabId) {
            // ã™ã¹ã¦ã®ã‚¿ãƒ–ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’éè¡¨ç¤º
            ['tab-habit-check', 'tab-study-time', 'tab-life-rhythm'].forEach(id => {
                document.getElementById(id).classList.add('hidden');
            });
            // ã™ã¹ã¦ã®ã‚¿ãƒ–ãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ«ã‚’éã‚¢ã‚¯ãƒ†ã‚£ãƒ–ï¼ˆã‚°ãƒ¬ãƒ¼ï¼‰ã«
            ['btn-tab-habit-check', 'btn-tab-study-time', 'btn-tab-life-rhythm'].forEach(id => {
                const btn = document.getElementById(id);
                btn.classList.remove('bg-gray-700', 'text-white', 'shadow');
                btn.classList.add('text-gray-400');
            });

            // é¸æŠã•ã‚ŒãŸã‚¿ãƒ–ã‚’è¡¨ç¤º
            document.getElementById(tabId).classList.remove('hidden');

            // é¸æŠã•ã‚ŒãŸãƒœã‚¿ãƒ³ã‚’ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ï¼ˆèƒŒæ™¯è‰²ãƒ»ç™½æ–‡å­—ï¼‰ã«
            const activeBtn = document.getElementById('btn-' + tabId);
            activeBtn.classList.remove('text-gray-400');
            activeBtn.classList.add('bg-gray-700', 'text-white', 'shadow');

            // ã‚°ãƒ©ãƒ•æç”»ãªã©ãŒå¿…è¦ãªå ´åˆ
            if (tabId === 'tab-study-time') {
                renderStudyChart();
            } else if (tabId === 'tab-life-rhythm') {
                renderSleepChart();
            }
        }

        // --- Study Time Logic ---
        let studyChartRange = 7;
        let studyTimeChart = null;

        function initStudyTimeSelects() {
            const hourSelect = document.getElementById('study-log-hours');
            const minuteSelect = document.getElementById('study-log-minutes');
            hourSelect.innerHTML = '';
            minuteSelect.innerHTML = '';

            for (let i = 0; i <= 24; i++) {
                const opt = document.createElement('option');
                opt.value = i;
                opt.textContent = i;
                hourSelect.appendChild(opt);
            }
            for (let i = 0; i < 60; i++) {
                const opt = document.createElement('option');
                opt.value = i;
                opt.textContent = String(i).padStart(2, '0');
                minuteSelect.appendChild(opt);
            }
            loadStudyLogDate();
        }

        // â–²â–¼ ãƒœã‚¿ãƒ³ã§åˆ†ã‚’ãƒ«ãƒ¼ãƒ—ï¼ˆ59â†’0â†’59ï¼‰
        function stepMinutes(diff) {
            const sel = document.getElementById('study-log-minutes');
            let val = parseInt(sel.value) + diff;
            if (val < 0) val = 59;
            if (val > 59) val = 0;
            sel.value = val;
        }

        function loadStudyLogDate() {
            const dateInput = document.getElementById('study-log-date');
            if (!dateInput.value) dateInput.value = getTodayStr();
            const dateStr = dateInput.value;

            // ãƒ©ãƒ™ãƒ«æ›´æ–°
            const label = document.getElementById('study-time-label');
            if (dateStr === getTodayStr()) {
                label.textContent = "ä»Šæ—¥ã®å‹‰å¼·æ™‚é–“";
            } else {
                const d = new Date(dateStr);
                label.textContent = `${d.getMonth() + 1}/${d.getDate()}ã®å‹‰å¼·æ™‚é–“`;
            }

            const log = (appData.studyLog && appData.studyLog[dateStr]) || { time: 0 };
            const hours = Math.floor(log.time / 60);
            const minutes = log.time % 60;

            document.getElementById('study-log-hours').value = hours;
            document.getElementById('study-log-minutes').value = minutes;
        }

        function shiftStudyLogDate(diff) {
            const dateInput = document.getElementById('study-log-date');
            if (!dateInput.value) dateInput.value = getTodayStr();

            const current = new Date(dateInput.value);
            current.setDate(current.getDate() + diff);
            dateInput.value = formatDate(current);
            loadStudyLogDate();
        }

        function saveStudyLog() {
            const dateStr = document.getElementById('study-log-date').value;
            if (!dateStr) return;

            const h = parseInt(document.getElementById('study-log-hours').value) || 0;
            const m = parseInt(document.getElementById('study-log-minutes').value) || 0;
            const totalMinutes = h * 60 + m;

            if (!appData.studyLog) appData.studyLog = {};
            appData.studyLog[dateStr] = { time: totalMinutes };

            // è‡ªå‹•ãƒã‚§ãƒƒã‚¯åˆ¤å®š
            checkStudyTimeAutoChallenge(dateStr, totalMinutes);

            saveData();
            renderStudyChart();
            showToast("å‹‰å¼·æ™‚é–“ã‚’è¨˜éŒ²ã—ã¾ã—ãŸ");
        }

        function changeStudyChartRange(days) {
            studyChartRange = days;
            document.querySelectorAll('.study-chart-range-btn').forEach(btn => {
                if (parseInt(btn.dataset.range) === days) {
                    btn.classList.remove('text-gray-400', 'hover:bg-gray-800');
                    btn.classList.add('bg-gray-700', 'text-white');
                } else {
                    btn.classList.add('text-gray-400', 'hover:bg-gray-800');
                    btn.classList.remove('bg-gray-700', 'text-white');
                }
            });
            renderStudyChart();
        }

        function renderStudyChart() {
            const canvas = document.getElementById('studyTimeChart');
            if (!canvas) return;

            const ctx = canvas.getContext('2d');
            const today = getToday();
            const labels = [];
            const data = [];
            let totalTime = 0;

            // Xè»¸: æ—¥ä»˜ (å·¦ãŒéå»ã€å³ãŒä»Šæ—¥)
            for (let i = studyChartRange - 1; i >= 0; i--) {
                const d = new Date(today);
                d.setDate(d.getDate() - i);
                const dStr = formatDate(d);
                labels.push(`${d.getMonth() + 1}/${d.getDate()}`);

                const log = (appData.studyLog && appData.studyLog[dStr]);
                const minutes = log ? log.time : 0;
                data.push(minutes / 60); // æ™‚é–“å˜ä½ã§è¡¨ç¤º
                totalTime += minutes;
            }

            // åˆè¨ˆæ™‚é–“ã®è¡¨ç¤ºæ›´æ–°
            const th = Math.floor(totalTime / 60);
            const tm = totalTime % 60;
            document.getElementById('study-total-display').textContent = `${th}h ${tm}m`;

            const isLight = document.documentElement.classList.contains('light-mode');
            const barColor = isLight ? '#3b82f6' : '#60a5fa';
            const gridColor = isLight ? '#cbd5e1' : '#334155';
            const textColor = isLight ? '#64748b' : '#94a3b8';

            if (studyTimeChart) {
                studyTimeChart.destroy();
            }

            studyTimeChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'å‹‰å¼·æ™‚é–“ (æ™‚é–“)',
                        data: data,
                        backgroundColor: barColor,
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            grid: { display: false, color: gridColor },
                            ticks: { color: textColor, font: { size: 10 } }
                        },
                        y: {
                            beginAtZero: true,
                            grid: { color: gridColor, borderDash: [2, 2] },
                            ticks: { color: textColor, font: { size: 10 } }
                        }
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: (context) => {
                                    const val = context.raw;
                                    const h = Math.floor(val);
                                    const m = Math.round((val - h) * 60);
                                    return `${h}æ™‚é–“ ${m}åˆ†`;
                                }
                            }
                        }
                    }
                }
            });
        }

        function checkStudyTimeAutoChallenge(dateStr, minutes) {
            const challenges = getActiveChallenges();
            let updated = false;

            challenges.forEach(c => {
                if (c.autoCheckType === 'study_time' && c.autoCheckTime) {
                    const target = parseInt(c.autoCheckTime);
                    if (minutes >= target) {
                        if (!c.challengeHistory) c.challengeHistory = {};
                        if (!c.challengeHistory[dateStr]) {
                            c.challengeHistory[dateStr] = true;
                            updated = true;
                        }
                    }
                }
            });

            if (updated) {
                renderChallengeScreen();
                showToast("ç›®æ¨™é”æˆï¼ãƒãƒ£ãƒ¬ãƒ³ã‚¸ã‚’æ›´æ–°ã—ã¾ã—ãŸ");
            }
        }    </script>
</body>

</html>